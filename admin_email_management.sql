-- ğŸ› ï¸ BeatNexus ç®¡ç†è€…ç”¨: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ç®¡ç†ãƒ„ãƒ¼ãƒ«
-- å‰Šé™¤æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å†åˆ©ç”¨å•é¡Œã‚’è§£æ±ºã™ã‚‹ãŸã‚ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

-- ==========================================
-- ğŸ“Š è¨ºæ–­: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ä½¿ç”¨çŠ¶æ³ç¢ºèª
-- ==========================================

-- 1. å…¨ä½“çš„ãªçŠ¶æ³ç¢ºèª
SELECT 
  'Total Users' as category,
  count(*) as count
FROM auth.users
UNION ALL
SELECT 
  'Deleted Email Users',
  count(*)
FROM auth.users
WHERE email LIKE '%@deleted.local'
UNION ALL
SELECT 
  'Active Users',
  count(*)
FROM auth.users u
JOIN profiles p ON u.id = p.id
WHERE p.is_deleted = FALSE
UNION ALL
SELECT 
  'Soft Deleted Users',
  count(*)
FROM auth.users u
JOIN profiles p ON u.id = p.id
WHERE p.is_deleted = TRUE;

-- 2. ç‰¹å®šã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãŒåˆ©ç”¨å¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
-- ä½¿ç”¨æ–¹æ³•: ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ã€å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„
-- SELECT check_email_availability('å•é¡Œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹@example.com');

-- ==========================================
-- ğŸ”§ ä¿®å¾©: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹è§£æ”¾ãƒ„ãƒ¼ãƒ«
-- ==========================================

-- 3. å‰Šé™¤æ¸ˆã¿ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ä¸€è¦§ã¨è©³ç´°ç¢ºèª
SELECT 
  u.id,
  u.email,
  u.created_at,
  u.email_confirmed_at,
  p.is_deleted,
  p.deleted_at,
  p.username,
  u.raw_user_meta_data->>'deleted_at' as auth_deleted_metadata,
  u.raw_user_meta_data->>'original_email_hash' as original_email_hash
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
WHERE p.is_deleted = TRUE
   OR u.email LIKE '%@deleted.local'
ORDER BY u.created_at DESC;

-- 4. ç‰¹å®šã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å¼·åˆ¶è§£æ”¾ï¼ˆç®¡ç†è€…ç”¨ï¼‰
-- âš ï¸ æ³¨æ„: å‰Šé™¤æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ã¿è§£æ”¾å¯èƒ½
-- ä½¿ç”¨æ–¹æ³•: ä»¥ä¸‹ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã‚’å¤–ã—ã¦ã€å®Ÿéš›ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã«ç½®ãæ›ãˆã¦ãã ã•ã„
-- SELECT force_release_deleted_email('è§£æ”¾ã—ãŸã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹@example.com');

-- ==========================================
-- ğŸš¨ ç·Šæ€¥ä¿®å¾©: å­¤ç«‹ã—ãŸauth.usersãƒ¬ã‚³ãƒ¼ãƒ‰ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
-- ==========================================

-- 5. profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«ãªã„auth.usersãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ç¢ºèª
SELECT 
  u.id,
  u.email,
  u.created_at,
  'ORPHANED_AUTH_USER' as status
FROM auth.users u
LEFT JOIN profiles p ON u.id = p.id
WHERE p.id IS NULL
  AND u.email NOT LIKE 'test%@example.com'; -- ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯é™¤å¤–

-- 6. å­¤ç«‹ã—ãŸauth.usersãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ï¼ˆâš ï¸ æ…é‡ã«å®Ÿè¡Œï¼‰
-- æ³¨æ„: å¿…ãšä¸Šè¨˜ã®ã‚¯ã‚¨ãƒªã§ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„
/*
DELETE FROM auth.users 
WHERE id IN (
  SELECT u.id
  FROM auth.users u
  LEFT JOIN profiles p ON u.id = p.id
  WHERE p.id IS NULL
    AND u.email NOT LIKE 'test%@example.com'
    AND u.created_at < NOW() - INTERVAL '1 day' -- 1æ—¥ä»¥ä¸Šå‰ã«ä½œæˆã•ã‚ŒãŸã‚‚ã®ã®ã¿
);
*/

-- ==========================================
-- ğŸ“‹ ä½¿ç”¨æ–¹æ³•ã¨ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
-- ==========================================

/*
ğŸ” å•é¡Œè¨ºæ–­æ‰‹é †:
1. ä¸Šè¨˜ã®ã€Œè¨ºæ–­ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ
2. å•é¡Œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ check_email_availability() ã‚’å®Ÿè¡Œ
3. çµæœã«å¿œã˜ã¦é©åˆ‡ãªä¿®å¾©æ–¹æ³•ã‚’é¸æŠ

ğŸ› ï¸ ä¿®å¾©æ–¹æ³•:
A. ã‚½ãƒ•ãƒˆå‰Šé™¤æ¸ˆã¿ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ãƒ¡ãƒ¼ãƒ«è§£æ”¾:
   - force_release_deleted_email('ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹') ã‚’å®Ÿè¡Œ

B. å­¤ç«‹ã—ãŸauth.usersãƒ¬ã‚³ãƒ¼ãƒ‰ã®å‰Šé™¤:
   - ä¸Šè¨˜ã®ç¢ºèªã‚¯ã‚¨ãƒªå®Ÿè¡Œå¾Œã€å‰Šé™¤ã‚¯ã‚¨ãƒªã‚’å®Ÿè¡Œ

C. ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã®ä¿®å¾©:
   - fix_deleted_users_metadata() ã‚’å®Ÿè¡Œ

ğŸš¨ æ³¨æ„äº‹é …:
- æœ¬ç•ªç’°å¢ƒã§ã¯å¿…ãšãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ã‹ã‚‰å®Ÿè¡Œ
- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯çµ¶å¯¾ã«å¤‰æ›´ã—ãªã„
- å‰Šé™¤æ“ä½œã¯å…ƒã«æˆ»ã›ãªã„ãŸã‚ã€ååˆ†ã«ç¢ºèªã—ã¦ã‹ã‚‰å®Ÿè¡Œ

ğŸ“ ã‚µãƒãƒ¼ãƒˆ:
å•é¡ŒãŒè§£æ±ºã—ãªã„å ´åˆã¯ã€ä»¥ä¸‹ã®æƒ…å ±ã‚’å«ã‚ã¦å ±å‘Šã—ã¦ãã ã•ã„:
- å•é¡Œã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ï¼ˆæ©Ÿå¯†æƒ…å ±ã¯é™¤ãï¼‰
- ä¸Šè¨˜è¨ºæ–­ã‚¯ã‚¨ãƒªã®çµæœ
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆã‚‚ã—ã‚ã‚Œã°ï¼‰
*/ 