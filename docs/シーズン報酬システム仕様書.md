# BeatNexus シーズン報酬システム仕様書

作成日: 2025年7月22日  
対象: シーズン終了時の限定バッジ・アイコンフレーム付与システム

---

## 1. システム概要

### 1.1 目的
シーズンごとの功績（プレイヤーランキング、投票者ランキングなど）に応じて、ユーザーに収集・設定可能なデジタルアイテムを付与することで、ユーザーの努力を「名誉」として可視化し、プロフィールをカスタマイズする楽しみを提供し、プラットフォームへのエンゲージメントを深化させる。

### 1.2 主要機能
- **限定バッジの収集・表示**: シーズン成績に応じた名誉バッジの付与と展示
- **アイコンフレームのカスタマイズ**: プロフィール画像を装飾するフレームの設定
- **コレクション管理**: 獲得済み・未獲得アイテムの管理と表示
- **自動報酬付与**: シーズン終了時の自動的な報酬配布
- **特別通知**: 報酬獲得時の専用通知システム

### 1.3 技術スタック
- **データベース**: PostgreSQL (Supabase)
- **フロントエンド**: React + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **国際化**: react-i18next
- **自動化**: Supabase Edge Functions + pg_cron

---

## 2. データベース設計

### 2.1 rewardsテーブル（マスターデータ）

全てのバッジとフレームの「マスターデータ」を管理するテーブル。

```sql
CREATE TYPE reward_type AS ENUM ('badge', 'frame');
CREATE TYPE reward_rarity AS ENUM ('common', 'rare', 'epic', 'legendary');

CREATE TABLE rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,                    -- 報酬名（例: "β Top 8", "Season 1 Champion"）
  description TEXT,                      -- 説明文
  type reward_type NOT NULL,             -- 'badge' または 'frame'
  rarity reward_rarity NOT NULL,         -- レアリティ
  image_url TEXT NOT NULL,               -- 画像URL
  season_id UUID REFERENCES seasons(id), -- 関連シーズン（NULL=永続的な報酬）
  criteria_type TEXT,                    -- 獲得条件タイプ（例: "player_rank", "voter_rank"）
  criteria_value INTEGER,               -- 獲得条件値（例: 8 = TOP8以内）
  is_active BOOLEAN DEFAULT true,       -- アクティブフラグ
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- インデックス
CREATE INDEX idx_rewards_season_id ON rewards(season_id);
CREATE INDEX idx_rewards_type ON rewards(type);
CREATE INDEX idx_rewards_criteria ON rewards(criteria_type, criteria_value);
```

### 2.2 user_rewardsテーブル（所有権管理）

どのユーザーが、どの報酬を獲得したかを記録する「所有権」を管理するテーブル。

```sql
CREATE TABLE user_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  reward_id UUID NOT NULL REFERENCES rewards(id) ON DELETE CASCADE,
  earned_at TIMESTAMPTZ DEFAULT now(),
  earned_season_id UUID REFERENCES seasons(id), -- 獲得時のシーズン
  
  -- 制約: 同じユーザーが同じ報酬を複数回獲得することを防ぐ
  UNIQUE(user_id, reward_id)
);

-- インデックス
CREATE INDEX idx_user_rewards_user_id ON user_rewards(user_id);
CREATE INDEX idx_user_rewards_reward_id ON user_rewards(reward_id);
CREATE INDEX idx_user_rewards_earned_season ON user_rewards(earned_season_id);
```

### 2.3 profilesテーブル拡張

アイコンフレーム設定用のカラムを追加。

```sql
-- 既存のprofilesテーブルに追加
ALTER TABLE profiles 
ADD COLUMN equipped_frame_id UUID REFERENCES rewards(id) ON DELETE SET NULL;

-- フレームタイプのみを参照するための制約（トリガーで実装）
CREATE INDEX idx_profiles_equipped_frame ON profiles(equipped_frame_id);
```

### 2.4 RLS（Row Level Security）設定

```sql
-- rewards テーブル: 読み取り専用
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can read rewards" ON rewards
  FOR SELECT USING (true);

-- user_rewards テーブル: 自分の報酬のみ参照可能
ALTER TABLE user_rewards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read own rewards" ON user_rewards
  FOR SELECT USING (auth.uid() = user_id);

-- profilesテーブルの equipped_frame_id: 自分のみ更新可能
CREATE POLICY "Users can update own equipped frame" ON profiles
  FOR UPDATE USING (auth.uid() = id);
```

---

## 3. ユーザー体験（UX）フロー

### 3.1 コレクションページ

#### 3.1.1 場所とアクセス
- **場所**: プロフィールページ内に新しく「コレクション」タブを追加
- **UI配置**: 既存の「Current Battles」「Battle History」「Posts」タブと同列に配置

#### 3.1.2 機能仕様
```tsx
// タブ構成の拡張
type ProfileTab = 'current' | 'history' | 'posts' | 'collection';

// コレクションページの構造
interface CollectionPageProps {
  userId: string;
  isOwnProfile: boolean;
}
```

#### 3.1.3 表示内容
1. **獲得済みバッジギャラリー**
   - グリッドレイアウトで美しく並んで表示
   - バッジをタップすると詳細モーダルが開く
   - 詳細情報: 拡大画像、名称、説明文、獲得日付

2. **未獲得バッジのシルエット**
   - 「？？？」または薄いシルエットで表示
   - 収集意欲を掻き立てる演出
   - タップすると「まだ獲得していません」のメッセージ

3. **フィルタリング機能**
   - 「全て」「バッジ」「フレーム」「シーズン別」のフィルター
   - レアリティ別ソート機能

#### 3.1.4 レスポンシブデザイン
```css
/* モバイル: 2列グリッド */
@media (max-width: 640px) {
  .collection-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
}

/* タブレット: 3列グリッド */
@media (min-width: 641px) and (max-width: 1024px) {
  .collection-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }
}

/* デスクトップ: 4列グリッド */
@media (min-width: 1025px) {
  .collection-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
  }
}
```

### 3.2 アイコンフレーム設定

#### 3.2.1 場所とアクセス
- **場所**: プロフィール編集画面
- **トリガー**: プロフィール画像をタップ → 編集モーダル表示

#### 3.2.2 UI構成
1. **プレビューエリア**
   - リアルタイムでフレームが適用されたアバターを表示
   - フレーム変更時のスムーズなアニメーション

2. **フレーム選択UI**
   - 獲得済みフレームが横一列に表示
   - 「フレームなし」オプションも含む
   - 選択中のフレームにはハイライト表示

3. **保存機能**
   - 「保存」ボタンでprofiles.equipped_frame_idを更新
   - 即座にサイト全体でフレームが反映

#### 3.2.3 フレーム表示システム
```tsx
// アバター表示コンポーネントでの実装例
interface AvatarProps {
  src?: string;
  frameId?: string;
  size?: 'sm' | 'md' | 'lg';
}

const Avatar: React.FC<AvatarProps> = ({ src, frameId, size = 'md' }) => {
  const frameImage = useFrameImage(frameId); // カスタムフック
  
  return (
    <div className={`relative ${sizeClasses[size]}`}>
      {/* アバター画像 */}
      <img src={src || getDefaultAvatarUrl()} className="rounded-full" />
      
      {/* フレーム画像（オーバーレイ） */}
      {frameImage && (
        <img 
          src={frameImage} 
          className="absolute inset-0 pointer-events-none"
          style={{ zIndex: 1 }}
        />
      )}
    </div>
  );
};
```

---

## 4. 報酬付与プロセス

### 4.1 シーズン終了時の自動処理

#### 4.1.1 処理フロー
```mermaid
sequenceDiagram
    participant Cron as pg_cron
    participant SeasonEnd as end_season関数
    participant GrantRewards as grant_season_rewards関数
    participant NotifyUsers as 通知システム
    participant Users as ユーザー

    Cron->>SeasonEnd: シーズン終了時刻に実行
    SeasonEnd->>SeasonEnd: ランキング確定
    SeasonEnd->>GrantRewards: grant_season_rewards(season_id)
    GrantRewards->>GrantRewards: 報酬対象者リストアップ
    GrantRewards->>GrantRewards: user_rewardsテーブルに一括挿入
    GrantRewards->>NotifyUsers: 特別通知作成
    NotifyUsers->>Users: 「報酬獲得！」通知送信
```

#### 4.1.2 grant_season_rewards関数の実装

```sql
CREATE OR REPLACE FUNCTION grant_season_rewards(p_season_id UUID)
RETURNS JSON AS $$
DECLARE
  v_reward_record RECORD;
  v_target_users UUID[];
  v_granted_count INTEGER := 0;
  v_result JSON;
BEGIN
  -- シーズンに関連する全ての報酬を取得
  FOR v_reward_record IN 
    SELECT * FROM rewards 
    WHERE season_id = p_season_id AND is_active = true
  LOOP
    -- 報酬タイプに応じて対象ユーザーを特定
    IF v_reward_record.criteria_type = 'player_rank' THEN
      -- プレイヤーランキング上位者
      SELECT ARRAY_AGG(user_id) INTO v_target_users
      FROM season_rankings 
      WHERE season_id = p_season_id 
        AND rank <= v_reward_record.criteria_value
      ORDER BY rank;
      
    ELSIF v_reward_record.criteria_type = 'voter_rank' THEN
      -- 投票者ランキング上位者
      SELECT ARRAY_AGG(user_id) INTO v_target_users
      FROM season_voter_rankings 
      WHERE season_id = p_season_id 
        AND rank <= v_reward_record.criteria_value
      ORDER BY rank;
    END IF;

    -- 対象ユーザーに報酬を付与（重複は UNIQUE制約で回避）
    IF v_target_users IS NOT NULL THEN
      INSERT INTO user_rewards (user_id, reward_id, earned_season_id)
      SELECT 
        unnest(v_target_users),
        v_reward_record.id,
        p_season_id
      ON CONFLICT (user_id, reward_id) DO NOTHING;
      
      GET DIAGNOSTICS v_granted_count = ROW_COUNT;
      
      -- 報酬獲得通知を作成
      INSERT INTO notifications (user_id, title, message, type, created_at)
      SELECT 
        unnest(v_target_users),
        'シーズン報酬獲得！',
        FORMAT('シーズン成績により「%s」を獲得しました！コレクションページで確認できます。', v_reward_record.name),
        'reward_earned',
        NOW();
    END IF;
  END LOOP;

  -- 結果を返す
  SELECT json_build_object(
    'season_id', p_season_id,
    'total_rewards_granted', v_granted_count,
    'processed_at', NOW()
  ) INTO v_result;

  RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 4.2 運営側の手動実行

```sql
-- 例: βシーズン0の報酬付与
SELECT grant_season_rewards('beta-season-0-uuid');

-- 特定報酬の手動付与（緊急時用）
INSERT INTO user_rewards (user_id, reward_id, earned_season_id)
VALUES ('user-uuid', 'reward-uuid', 'season-uuid');
```

---

## 5. 通知システム連携

### 5.1 新しい通知タイプ

```typescript
// 既存の通知タイプに追加
type NotificationType = 
  | 'info'
  | 'success'
  | 'warning'
  | 'battle_matched'
  | 'battle_win'
  | 'battle_lose'
  | 'battle_draw'
  | 'reward_earned';    // 新規追加
```

### 5.2 報酬獲得通知の特別処理

```typescript
// NotificationStore での処理拡張
const handleRewardEarnedNotification = (notification: Notification) => {
  // 特別な演出付きモーダルを表示
  showRewardModal({
    title: notification.title,
    message: notification.message,
    rewardId: notification.related_reward_id, // 新規カラム
    onClose: () => {
      // コレクションページに直接遷移
      navigate(`/profile/${auth.user.id}?tab=collection`);
      deleteNotification(notification.id);
    }
  });
};
```

### 5.3 通知演出仕様

1. **特別なアニメーション**
   - キラキラエフェクト
   - ゴールドグラデーション
   - フェードイン＋スケールアップ

2. **音響効果**（オプション）
   - 獲得時の効果音
   - レアリティに応じた音声変化

---

## 6. フロントエンド実装計画

### 6.1 新規コンポーネント

```
src/components/rewards/
├── CollectionPage.tsx          # コレクションメインページ
├── BadgeCard.tsx              # バッジ表示カード
├── FrameCard.tsx              # フレーム表示カード
├── RewardDetailModal.tsx      # 報酬詳細モーダル
├── FrameSelector.tsx          # フレーム選択UI
├── RewardEarnedModal.tsx      # 報酬獲得通知モーダル
└── CollectionFilters.tsx      # フィルタリングUI
```

### 6.2 カスタムフック

```typescript
// 報酬データ管理
export const useUserRewards = (userId: string) => {
  const [rewards, setRewards] = useState<UserReward[]>([]);
  const [loading, setLoading] = useState(true);
  
  const fetchRewards = async () => {
    // user_rewards と rewards の JOIN クエリ
  };
  
  return { rewards, loading, refetch: fetchRewards };
};

// フレーム画像取得
export const useFrameImage = (frameId?: string) => {
  const [frameImage, setFrameImage] = useState<string | null>(null);
  
  useEffect(() => {
    if (frameId) {
      // rewards テーブルから画像URL取得
    }
  }, [frameId]);
  
  return frameImage;
};
```

### 6.3 Zustore拡張

```typescript
interface RewardStore {
  userRewards: UserReward[];
  availableRewards: Reward[];
  equippedFrame: Reward | null;
  
  fetchUserRewards: (userId: string) => Promise<void>;
  fetchAvailableRewards: () => Promise<void>;
  updateEquippedFrame: (frameId: string | null) => Promise<void>;
}
```

---

## 7. 国際化（i18n）対応

### 7.1 新規翻訳キー

```json
{
  "rewards": {
    "collection": {
      "title": "コレクション",
      "tabs": {
        "all": "全て",
        "badges": "バッジ",
        "frames": "フレーム"
      },
      "filters": {
        "rarity": "レアリティ",
        "season": "シーズン"
      },
      "notEarned": "まだ獲得していません",
      "earnedOn": "獲得日: {{date}}"
    },
    "frames": {
      "select": "フレームを選択",
      "preview": "プレビュー",
      "none": "フレームなし",
      "apply": "適用"
    },
    "notifications": {
      "earned": {
        "title": "シーズン報酬獲得！",
        "message": "「{{rewardName}}」を獲得しました！",
        "viewCollection": "コレクションを見る"
      }
    },
    "rarity": {
      "common": "コモン",
      "rare": "レア", 
      "epic": "エピック",
      "legendary": "レジェンダリー"
    }
  }
}
```

---

## 8. 初期データ例

### 8.1 βシーズン0の報酬定義

```sql
-- βシーズン0 プレイヤーランキング報酬
INSERT INTO rewards (name, description, type, rarity, image_url, season_id, criteria_type, criteria_value) VALUES
('β Top 8', 'βシーズン0において、プレイヤーランキングTOP8に入賞した者に贈られる名誉の証', 'badge', 'epic', '/images/rewards/beta-top8-badge.png', 'beta-season-0-uuid', 'player_rank', 8),
('β Champion', 'βシーズン0のプレイヤーランキング1位獲得者に贈られる最高の栄誉', 'badge', 'legendary', '/images/rewards/beta-champion-badge.png', 'beta-season-0-uuid', 'player_rank', 1),
('β Crown Frame', 'βシーズン0のチャンピオン専用アイコンフレーム', 'frame', 'legendary', '/images/rewards/beta-crown-frame.png', 'beta-season-0-uuid', 'player_rank', 1);

-- βシーズン0 投票者ランキング報酬  
INSERT INTO rewards (name, description, type, rarity, image_url, season_id, criteria_type, criteria_value) VALUES
('β Judge Elite', 'βシーズン0において、投票者ランキングTOP20に入賞した審査員に贈られる証', 'badge', 'rare', '/images/rewards/beta-judge-badge.png', 'beta-season-0-uuid', 'voter_rank', 20),
('β Chief Judge', 'βシーズン0の投票者ランキング1位に贈られる最高審査員の証', 'badge', 'epic', '/images/rewards/beta-chief-judge-badge.png', 'beta-season-0-uuid', 'voter_rank', 1);
```

---

## 9. パフォーマンス考慮事項

### 9.1 データベース最適化

```sql
-- 複合インデックスによる検索最適化
CREATE INDEX idx_user_rewards_composite ON user_rewards(user_id, earned_season_id);
CREATE INDEX idx_rewards_season_type ON rewards(season_id, type, is_active);

-- 部分インデックス（アクティブな報酬のみ）
CREATE INDEX idx_rewards_active ON rewards(type, rarity) WHERE is_active = true;
```

### 9.2 フロントエンド最適化

1. **画像の遅延読み込み**
   ```tsx
   <img 
     src={reward.image_url} 
     loading="lazy"
     onError={handleImageError}
   />
   ```

2. **仮想化スクロール**（大量コレクション対応）
   ```tsx
   import { VirtuosoGrid } from 'react-virtuoso';
   
   <VirtuosoGrid
     data={rewards}
     itemContent={(index, reward) => <RewardCard reward={reward} />}
   />
   ```

3. **キャッシュ戦略**
   - ユーザーの報酬データはZustandで永続化
   - 画像はブラウザキャッシュ活用

---

## 10. セキュリティ考慮事項

### 10.1 報酬付与の不正防止

1. **サーバーサイド検証**
   - 報酬付与は必ずサーバーサイド関数で実行
   - フロントエンドからの直接的な報酬付与は禁止

2. **重複付与防止**
   - UNIQUE制約による技術的な重複防止
   - ログによる監査追跡

3. **RLS による権限管理**
   - 他ユーザーの報酬情報への不正アクセス防止

### 10.2 画像アセット管理

1. **CDN使用**
   - 報酬画像はCDNで配信
   - 改ざん防止のためのハッシュ検証

2. **フォールバック機能**
   - 画像読み込み失敗時のデフォルト表示

---

## 11. 運用・監視

### 11.1 メトリクス

1. **報酬付与監視**
   ```sql
   -- 日次報酬付与数
   SELECT 
     DATE(earned_at) as date,
     COUNT(*) as rewards_granted
   FROM user_rewards 
   WHERE earned_at >= CURRENT_DATE - INTERVAL '7 days'
   GROUP BY DATE(earned_at);
   ```

2. **ユーザーエンゲージメント**
   - コレクションページ閲覧数
   - フレーム変更頻度
   - 報酬獲得通知のクリック率

### 11.2 ログ出力

```typescript
// 報酬関連イベントのログ
export const trackRewardEvents = {
  rewardEarned: (userId: string, rewardId: string, seasonId: string) => {
    console.log('Reward earned:', { userId, rewardId, seasonId });
  },
  frameEquipped: (userId: string, frameId: string) => {
    console.log('Frame equipped:', { userId, frameId });
  },
  collectionViewed: (userId: string, viewedByUserId: string) => {
    console.log('Collection viewed:', { userId, viewedByUserId });
  }
};
```

---

## 12. 実装優先度

### Phase 1: 基盤実装（必須）
- [ ] データベーステーブル作成
- [ ] RLS設定
- [ ] grant_season_rewards関数実装
- [ ] 基本的なコレクションページ作成

### Phase 2: UI/UX実装
- [ ] バッジ・フレーム表示コンポーネント
- [ ] プロフィール編集でのフレーム選択
- [ ] 報酬獲得通知システム
- [ ] レスポンシブ対応

### Phase 3: 最適化・拡張
- [ ] パフォーマンス最適化
- [ ] 高度なフィルタリング機能
- [ ] アニメーション・エフェクト強化
- [ ] 分析・監視ダッシュボード

---

## 13. 参考資料

- [既存プロフィールシステム](./BeatNexus.mdc#プロフィール関連)
- [シーズンシステム仕様書](./シーズンシステム仕様書.md)
- [通知システム仕様書](./通知システム仕様書.md)
- [ランキングシステム仕様書](./ランキングシステム仕様書.md)

---

**作成者**: AI Assistant  
**最終更新**: 2025年7月22日
