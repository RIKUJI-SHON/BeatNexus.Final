# BeatNexus ã‚·ãƒ¼ã‚ºãƒ³å ±é…¬ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

ä½œæˆæ—¥: 2025å¹´7æœˆ22æ—¥  
æœ€çµ‚æ›´æ–°: 2025å¹´7æœˆ22æ—¥  
å¯¾è±¡: ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®é™å®šãƒãƒƒã‚¸ä»˜ä¸ã‚·ã‚¹ãƒ†ãƒ 

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç›®çš„
ã‚·ãƒ¼ã‚ºãƒ³ã”ã¨ã®åŠŸç¸¾ï¼ˆãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã€æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãªã©ï¼‰ã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åé›†ãƒ»è¡¨ç¤ºå¯èƒ½ãªé™å®šãƒãƒƒã‚¸ã‚’ä»˜ä¸ã™ã‚‹ã“ã¨ã§ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®åŠªåŠ›ã‚’ã€Œåèª‰ã€ã¨ã—ã¦å¯è¦–åŒ–ã—ã€ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚’ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã™ã‚‹æ¥½ã—ã¿ã‚’æä¾›ã—ã€ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã®ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆã‚’æ·±åŒ–ã•ã›ã‚‹ã€‚

### 1.2 ä¸»è¦æ©Ÿèƒ½
- **é™å®šãƒãƒƒã‚¸ã®åé›†ãƒ»è¡¨ç¤º**: ã‚·ãƒ¼ã‚ºãƒ³æˆç¸¾ã«å¿œã˜ãŸåèª‰ãƒãƒƒã‚¸ã®ä»˜ä¸ã¨å±•ç¤º
- **ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†**: ç²å¾—æ¸ˆã¿ãƒ»æœªç²å¾—ã‚¢ã‚¤ãƒ†ãƒ ã®ç®¡ç†ã¨è¡¨ç¤º
- **è‡ªå‹•å ±é…¬ä»˜ä¸**: ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®è‡ªå‹•çš„ãªå ±é…¬é…å¸ƒ
- **ç‰¹åˆ¥é€šçŸ¥**: å ±é…¬ç²å¾—æ™‚ã®å°‚ç”¨é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- **å¤šè¨€èªå¯¾å¿œ**: æ—¥æœ¬èªãƒ»è‹±èªã§ã®è¡¨ç¤ºå¯¾å¿œ

### 1.3 æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: PostgreSQL (Supabase)
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: React + TypeScript + Tailwind CSS
- **çŠ¶æ…‹ç®¡ç†**: Zustand
- **å›½éš›åŒ–**: react-i18next
- **è‡ªå‹•åŒ–**: Supabase Edge Functions + pg_cron

### 1.4 å®Ÿè£…çŠ¶æ³ï¼ˆ2025å¹´7æœˆ22æ—¥ç¾åœ¨ï¼‰
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆå®Œäº†ï¼ˆãƒãƒƒã‚¸ã®ã¿ã€ãƒ•ãƒ¬ãƒ¼ãƒ æ©Ÿèƒ½å‰Šé™¤æ¸ˆã¿ï¼‰
- âœ… BadgeCardã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå®Ÿè£…æ¸ˆã¿ï¼ˆãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¯ãƒ»ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°å‰Šé™¤æ¸ˆã¿ï¼‰
- âœ… å¤šè¨€èªåŒ–å¯¾å¿œå®Œäº†
- âœ… ãƒ¢ãƒ¼ãƒ€ãƒ«è©³ç´°è¡¨ç¤ºæ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿
- âŒ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸æœªå®Ÿè£…
- âŒ è‡ªå‹•å ±é…¬ä»˜ä¸ã‚·ã‚¹ãƒ†ãƒ æœªå®Ÿè£…

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 2.1 rewardsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼‰

å…¨ã¦ã®ãƒãƒƒã‚¸ã®ã€Œãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã€ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

```sql
CREATE TABLE rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name TEXT NOT NULL,                    -- å ±é…¬åï¼ˆä¾‹: "Î² Top 8", "Season 1 Champion"ï¼‰
  description TEXT,                      -- èª¬æ˜æ–‡
  type TEXT NOT NULL CHECK (type IN ('badge')), -- 'badge'ã®ã¿ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ æ©Ÿèƒ½å‰Šé™¤ï¼‰
  image_url TEXT NOT NULL,               -- ç”»åƒURL
  season_id UUID REFERENCES seasons(id), -- é–¢é€£ã‚·ãƒ¼ã‚ºãƒ³ï¼ˆNULL=æ°¸ç¶šçš„ãªå ±é…¬ï¼‰
  rank_requirement INTEGER,             -- å¿…è¦ãƒ©ãƒ³ã‚¯ï¼ˆ1ä½, 2ä½, 3ä½ãªã©ã€nullã®å ´åˆã¯å…¨å“¡ï¼‰
  min_battles INTEGER DEFAULT 0,        -- æœ€ä½ãƒãƒˆãƒ«æ•°ï¼ˆå‚åŠ æ¡ä»¶ï¼‰
  is_limited BOOLEAN DEFAULT true,      -- é™å®šå ±é…¬ã‹ã©ã†ã‹
  is_active BOOLEAN DEFAULT true,       -- ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ•ãƒ©ã‚°
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_rewards_season_id ON rewards(season_id);
CREATE INDEX idx_rewards_type ON rewards(type);
```

### 2.2 user_rewardsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ‰€æœ‰æ¨©ç®¡ç†ï¼‰

ã©ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€ã©ã®å ±é…¬ã‚’ç²å¾—ã—ãŸã‹ã‚’è¨˜éŒ²ã™ã‚‹ã€Œæ‰€æœ‰æ¨©ã€ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã€‚

```sql
CREATE TABLE user_rewards (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
  reward_id UUID NOT NULL REFERENCES rewards(id) ON DELETE CASCADE,
  earned_at TIMESTAMPTZ DEFAULT now(),
  earned_season_id UUID REFERENCES seasons(id), -- ç²å¾—æ™‚ã®ã‚·ãƒ¼ã‚ºãƒ³
  
  -- åˆ¶ç´„: åŒã˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåŒã˜å ±é…¬ã‚’è¤‡æ•°å›ç²å¾—ã™ã‚‹ã“ã¨ã‚’é˜²ã
  UNIQUE(user_id, reward_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_rewards_user_id ON user_rewards(user_id);
CREATE INDEX idx_user_rewards_reward_id ON user_rewards(reward_id);
CREATE INDEX idx_user_rewards_earned_season ON user_rewards(earned_season_id);
```

### 2.3 profilesãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ

**æ³¨æ„**: ã‚¢ã‚¤ã‚³ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ æ©Ÿèƒ½ã¯å‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚equipped_frame_idã‚«ãƒ©ãƒ ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚

### 2.4 RLSï¼ˆRow Level Securityï¼‰è¨­å®š

```sql
-- rewards ãƒ†ãƒ¼ãƒ–ãƒ«: èª­ã¿å–ã‚Šå°‚ç”¨
ALTER TABLE rewards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Anyone can read rewards" ON rewards
  FOR SELECT USING (true);

-- user_rewards ãƒ†ãƒ¼ãƒ–ãƒ«: è‡ªåˆ†ã®å ±é…¬ã®ã¿å‚ç…§å¯èƒ½
ALTER TABLE user_rewards ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Users can read own rewards" ON user_rewards
  FOR SELECT USING (auth.uid() = user_id);

-- profilesãƒ†ãƒ¼ãƒ–ãƒ«ã® equipped_frame_id: è‡ªåˆ†ã®ã¿æ›´æ–°å¯èƒ½
CREATE POLICY "Users can update own equipped frame" ON profiles
  FOR UPDATE USING (auth.uid() = id);
```

---

## 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ï¼ˆUXï¼‰ãƒ•ãƒ­ãƒ¼

### 3.1 ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸

#### 3.1.1 å ´æ‰€ã¨ã‚¢ã‚¯ã‚»ã‚¹
- **å ´æ‰€**: ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒšãƒ¼ã‚¸å†…ã«æ–°ã—ãã€Œã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã€ã‚¿ãƒ–ã‚’è¿½åŠ 
- **UIé…ç½®**: æ—¢å­˜ã®ã€ŒCurrent Battlesã€ã€ŒBattle Historyã€ã€ŒPostsã€ã‚¿ãƒ–ã¨åŒåˆ—ã«é…ç½®

#### 3.1.2 æ©Ÿèƒ½ä»•æ§˜
```tsx
// ã‚¿ãƒ–æ§‹æˆã®æ‹¡å¼µ
type ProfileTab = 'current' | 'history' | 'posts' | 'collection';

// ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã®æ§‹é€ 
interface CollectionPageProps {
  userId: string;
  isOwnProfile: boolean;
}
```

#### 3.1.3 è¡¨ç¤ºå†…å®¹
1. **ç²å¾—æ¸ˆã¿ãƒãƒƒã‚¸ã‚®ãƒ£ãƒ©ãƒªãƒ¼**
   - ã‚°ãƒªãƒƒãƒ‰ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã§ç¾ã—ãä¸¦ã‚“ã§è¡¨ç¤º
   - ãƒãƒƒã‚¸ã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ãŒé–‹ãï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
   - è©³ç´°æƒ…å ±: æ‹¡å¤§ç”»åƒã€åç§°ã€èª¬æ˜æ–‡ã€ç²å¾—æ—¥ä»˜
   - ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¯ã‚„ç²å¾—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ã¯è¡¨ç¤ºã—ãªã„ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰

2. **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½**ï¼ˆæœªå®Ÿè£…ï¼‰
   - ã€Œå…¨ã¦ã€ã€Œã‚·ãƒ¼ã‚ºãƒ³åˆ¥ã€ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼

#### 3.1.4 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ãƒ‡ã‚¶ã‚¤ãƒ³
```css
/* ãƒ¢ãƒã‚¤ãƒ«: 2åˆ—ã‚°ãƒªãƒƒãƒ‰ */
@media (max-width: 640px) {
  .collection-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 1rem;
  }
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ: 3åˆ—ã‚°ãƒªãƒƒãƒ‰ */
@media (min-width: 641px) and (max-width: 1024px) {
  .collection-grid {
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
  }
}

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—: 4åˆ—ã‚°ãƒªãƒƒãƒ‰ */
@media (min-width: 1025px) {
  .collection-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 2rem;
  }
}
```

### 3.2 BadgeCardå®Ÿè£…è©³ç´°ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

#### 3.2.1 ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆä»•æ§˜
- **å ´æ‰€**: `src/components/rewards/BadgeCard.tsx`
- **å®Ÿè£…çŠ¶æ³**: âœ… å®Œäº†ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰

#### 3.2.2 UIä»•æ§˜
1. **ã‚«ãƒ¼ãƒ‰è¡¨ç¤º**
   - 96x96pxã®å¤§ããªãƒãƒƒã‚¸ç”»åƒ
   - ãƒãƒƒã‚¸åã®ã¿è¡¨ç¤º
   - ãƒ›ãƒãƒ¼æ™‚ã®ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—åŠ¹æœ
   - ãƒˆãƒ­ãƒ•ã‚£ãƒ¼ãƒãƒ¼ã‚¯ã‚„ç²å¾—ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¿ã‚°ã¯éè¡¨ç¤º

2. **è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«**
   - ã‚¯ãƒªãƒƒã‚¯æ™‚ã«è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
   - 128x128pxã®æ‹¡å¤§ãƒãƒƒã‚¸ç”»åƒ
   - å¤šè¨€èªå¯¾å¿œã®èª¬æ˜ãƒ»ç²å¾—æ—¥è¡¨ç¤º
   - ãƒ’ãƒ³ãƒˆ: `premium.badges.details.description`ã€`premium.badges.details.earnedDate`ã‚­ãƒ¼ä½¿ç”¨

#### 3.2.3 å¤šè¨€èªåŒ–å¯¾å¿œ
```typescript
// ç¿»è¨³ã‚­ãƒ¼
"premium": {
  "badges": {
    "details": {
      "description": "èª¬æ˜", // "Description"
      "earnedDate": "ç²å¾—æ—¥"  // "Earned Date"
    }
  }
}
```

---

## 4. å ±é…¬ä»˜ä¸ãƒ—ãƒ­ã‚»ã‚¹ï¼ˆæœªå®Ÿè£…ï¼‰

### 4.1 ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®è‡ªå‹•å‡¦ç†ï¼ˆæœªå®Ÿè£…ï¼‰

#### 4.1.1 å‡¦ç†ãƒ•ãƒ­ãƒ¼
```mermaid
sequenceDiagram
    participant Cron as pg_cron
    participant SeasonEnd as end_seasoné–¢æ•°
    participant GrantRewards as grant_season_rewardsé–¢æ•°
    participant NotifyUsers as é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
    participant Users as ãƒ¦ãƒ¼ã‚¶ãƒ¼

    Cron->>SeasonEnd: ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚åˆ»ã«å®Ÿè¡Œ
    SeasonEnd->>SeasonEnd: ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç¢ºå®š
    SeasonEnd->>GrantRewards: grant_season_rewards(season_id)
    GrantRewards->>GrantRewards: å ±é…¬å¯¾è±¡è€…ãƒªã‚¹ãƒˆã‚¢ãƒƒãƒ—
    GrantRewards->>GrantRewards: user_rewardsãƒ†ãƒ¼ãƒ–ãƒ«ã«ä¸€æ‹¬æŒ¿å…¥
    GrantRewards->>NotifyUsers: ç‰¹åˆ¥é€šçŸ¥ä½œæˆ
    NotifyUsers->>Users: ã€Œå ±é…¬ç²å¾—ï¼ã€é€šçŸ¥é€ä¿¡
```

#### 4.1.2 grant_season_rewardsé–¢æ•°ã®å®Ÿè£…ï¼ˆè¦å®Ÿè£…ï¼‰

```sql
CREATE OR REPLACE FUNCTION grant_season_rewards(p_season_id UUID)
RETURNS JSON AS $$
DECLARE
  v_reward_record RECORD;
  v_target_users UUID[];
  v_granted_count INTEGER := 0;
  v_result JSON;
BEGIN
  -- ã‚·ãƒ¼ã‚ºãƒ³ã«é–¢é€£ã™ã‚‹å…¨ã¦ã®å ±é…¬ã‚’å–å¾—
  FOR v_reward_record IN 
    SELECT * FROM rewards 
    WHERE season_id = p_season_id AND is_active = true
  LOOP
    -- rank_requirementã«å¿œã˜ã¦å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ç‰¹å®š
    SELECT ARRAY_AGG(user_id) INTO v_target_users
    FROM season_rankings 
    WHERE season_id = p_season_id 
      AND rank <= v_reward_record.rank_requirement
      AND battle_count >= v_reward_record.min_battles
    ORDER BY rank;

    -- å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å ±é…¬ã‚’ä»˜ä¸ï¼ˆé‡è¤‡ã¯ UNIQUEåˆ¶ç´„ã§å›é¿ï¼‰
    IF v_target_users IS NOT NULL THEN
      INSERT INTO user_rewards (user_id, reward_id, earned_season_id)
      SELECT 
        unnest(v_target_users),
        v_reward_record.id,
        p_season_id
      ON CONFLICT (user_id, reward_id) DO NOTHING;
      
      GET DIAGNOSTICS v_granted_count = ROW_COUNT;
      
      -- å ±é…¬ç²å¾—é€šçŸ¥ã‚’ä½œæˆ
      INSERT INTO notifications (user_id, title, message, type, created_at)
      SELECT 
        unnest(v_target_users),
        'ã‚·ãƒ¼ã‚ºãƒ³å ±é…¬ç²å¾—ï¼',
        FORMAT('ã‚·ãƒ¼ã‚ºãƒ³æˆç¸¾ã«ã‚ˆã‚Šã€Œ%sã€ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚', v_reward_record.name),
        'reward_earned',
        NOW();
    END IF;
  END LOOP;

  -- çµæœã‚’è¿”ã™
  SELECT json_build_object(
    'season_id', p_season_id,
    'total_rewards_granted', v_granted_count,
    'processed_at', NOW()
  ) INTO v_result;

  RETURN v_result;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

### 4.2 é‹å–¶å´ã®æ‰‹å‹•å®Ÿè¡Œ

```sql
-- ä¾‹: Î²ã‚·ãƒ¼ã‚ºãƒ³0ã®å ±é…¬ä»˜ä¸
SELECT grant_season_rewards('beta-season-0-uuid');

-- ç‰¹å®šå ±é…¬ã®æ‰‹å‹•ä»˜ä¸ï¼ˆç·Šæ€¥æ™‚ç”¨ï¼‰
INSERT INTO user_rewards (user_id, reward_id, earned_season_id)
VALUES ('user-uuid', 'reward-uuid', 'season-uuid');
```

---

## 5. é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ é€£æº

### 5.1 æ–°ã—ã„é€šçŸ¥ã‚¿ã‚¤ãƒ—

```typescript
// æ—¢å­˜ã®é€šçŸ¥ã‚¿ã‚¤ãƒ—ã«è¿½åŠ 
type NotificationType = 
  | 'info'
  | 'success'
  | 'warning'
  | 'battle_matched'
  | 'battle_win'
  | 'battle_lose'
  | 'battle_draw'
  | 'reward_earned';    // æ–°è¦è¿½åŠ 
```

### 5.2 å ±é…¬ç²å¾—é€šçŸ¥ã®ç‰¹åˆ¥å‡¦ç†

```typescript
// NotificationStore ã§ã®å‡¦ç†æ‹¡å¼µ
const handleRewardEarnedNotification = (notification: Notification) => {
  // ç‰¹åˆ¥ãªæ¼”å‡ºä»˜ããƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
  showRewardModal({
    title: notification.title,
    message: notification.message,
    rewardId: notification.related_reward_id, // æ–°è¦ã‚«ãƒ©ãƒ 
    onClose: () => {
      // ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã«ç›´æ¥é·ç§»
      navigate(`/profile/${auth.user.id}?tab=collection`);
      deleteNotification(notification.id);
    }
  });
};
```

### 5.3 é€šçŸ¥æ¼”å‡ºä»•æ§˜

1. **ç‰¹åˆ¥ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³**
   - ã‚­ãƒ©ã‚­ãƒ©ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
   - ã‚´ãƒ¼ãƒ«ãƒ‰ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
   - ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³ï¼‹ã‚¹ã‚±ãƒ¼ãƒ«ã‚¢ãƒƒãƒ—

2. **éŸ³éŸ¿åŠ¹æœ**ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
   - ç²å¾—æ™‚ã®åŠ¹æœéŸ³

---

## 6. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å®Ÿè£…è¨ˆç”»

### 6.1 å®Ÿè£…æ¸ˆã¿ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```
src/components/rewards/
â”œâ”€â”€ BadgeCard.tsx              # ãƒãƒƒã‚¸è¡¨ç¤ºã‚«ãƒ¼ãƒ‰ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
â””â”€â”€ CollectionPage.tsx         # ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
```

### 6.2 æœªå®Ÿè£…ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

```
src/components/rewards/
â”œâ”€â”€ RewardDetailModal.tsx      # å ±é…¬è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆBadgeCardã«çµ±åˆæ¸ˆã¿ï¼‰
â”œâ”€â”€ RewardEarnedModal.tsx      # å ±é…¬ç²å¾—é€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæœªå®Ÿè£…ï¼‰
â””â”€â”€ CollectionFilters.tsx      # ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°UIï¼ˆæœªå®Ÿè£…ï¼‰
```

### 6.3 å®Ÿè£…æ¸ˆã¿ã‚«ã‚¹ã‚¿ãƒ ãƒ•ãƒƒã‚¯

```typescript
// å ±é…¬ãƒ‡ãƒ¼ã‚¿ç®¡ç†ï¼ˆCollectionPageã§ä½¿ç”¨ï¼‰
export const useUserRewards = (userId: string) => {
  const [rewards, setRewards] = useState<UserReward[]>([]);
  const [loading, setLoading] = useState(true);
  
  const fetchRewards = async () => {
    // user_rewards ã¨ rewards ã® JOIN ã‚¯ã‚¨ãƒªï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰
  };
  
  return { rewards, loading, refetch: fetchRewards };
};
```

### 6.4 Zustoreæ‹¡å¼µï¼ˆæœªå®Ÿè£…ï¼‰

```typescript
interface RewardStore {
  userRewards: UserReward[];
  availableRewards: Reward[];
  
  fetchUserRewards: (userId: string) => Promise<void>;
  fetchAvailableRewards: () => Promise<void>;
}
```

---

## 7. å›½éš›åŒ–ï¼ˆi18nï¼‰å¯¾å¿œï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

### 7.1 å®Ÿè£…æ¸ˆã¿ç¿»è¨³ã‚­ãƒ¼

```json
{
  "premium": {
    "badges": {
      "details": {
        "description": "èª¬æ˜",      // "Description"
        "earnedDate": "ç²å¾—æ—¥"     // "Earned Date"
      }
    }
  },
  "profilePage": {
    "emptyStates": {
      "battleHistory": "ãƒãƒˆãƒ«ã§å‹åˆ©ã‚’é‡ã­ã¦å±¥æ­´ã‚’ä½œã‚ã†ï¼"
                      // "Build your battle history by winning more battles!"
    }
  },
  "myBattlesPage": {
    "empty": {
      "completedBattles": {
        "hint": "ãƒãƒˆãƒ«ã§å‹åˆ©ã‚’é‡ã­ã¦å±¥æ­´ã‚’ä½œã‚ã†ï¼"
               // "Build your battle history by winning more battles!"
      }
    }
  }
}
```

### 7.2 æœªå®Ÿè£…ç¿»è¨³ã‚­ãƒ¼

```json
{
  "rewards": {
    "collection": {
      "title": "ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³",
      "tabs": {
        "all": "å…¨ã¦",
        "badges": "ãƒãƒƒã‚¸"
      },
      "filters": {
        "season": "ã‚·ãƒ¼ã‚ºãƒ³"
      },
      "notEarned": "ã¾ã ç²å¾—ã—ã¦ã„ã¾ã›ã‚“",
      "earnedOn": "ç²å¾—æ—¥: {{date}}"
    },
    "notifications": {
      "earned": {
        "title": "ã‚·ãƒ¼ã‚ºãƒ³å ±é…¬ç²å¾—ï¼",
        "message": "ã€Œ{{rewardName}}ã€ã‚’ç²å¾—ã—ã¾ã—ãŸï¼",
        "viewCollection": "ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¦‹ã‚‹"
      }
    }
  }
}
```

---

## 8. åˆæœŸãƒ‡ãƒ¼ã‚¿ä¾‹ï¼ˆæœªå®Ÿè£…ï¼‰

### 8.1 Î²ã‚·ãƒ¼ã‚ºãƒ³0ã®å ±é…¬å®šç¾©

```sql
-- Î²ã‚·ãƒ¼ã‚ºãƒ³0 ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°å ±é…¬
INSERT INTO rewards (name, description, type, image_url, season_id, rank_requirement, min_battles) VALUES
('Î² Top 8', 'Î²ã‚·ãƒ¼ã‚ºãƒ³0ã«ãŠã„ã¦ã€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°TOP8ã«å…¥è³ã—ãŸè€…ã«è´ˆã‚‰ã‚Œã‚‹åèª‰ã®è¨¼', 'badge', '/images/rewards/beta-top8-badge.png', 'beta-season-0-uuid', 8, 5),
('Î² Champion', 'Î²ã‚·ãƒ¼ã‚ºãƒ³0ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°1ä½ç²å¾—è€…ã«è´ˆã‚‰ã‚Œã‚‹æœ€é«˜ã®æ „èª‰', 'badge', '/images/rewards/beta-champion-badge.png', 'beta-season-0-uuid', 1, 5);

-- å‚åŠ è³ï¼ˆå…¨å“¡å¯¾è±¡ï¼‰
INSERT INTO rewards (name, description, type, image_url, season_id, rank_requirement, min_battles) VALUES
('Î² Participant', 'Î²ã‚·ãƒ¼ã‚ºãƒ³0ã«å‚åŠ ã—ãŸè¨˜å¿µãƒãƒƒã‚¸', 'badge', '/images/rewards/beta-participant-badge.png', 'beta-season-0-uuid', 999999, 1);
```

---

## 9. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è€ƒæ…®äº‹é …

### 9.1 ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æœ€é©åŒ–

```sql
-- è¤‡åˆã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«ã‚ˆã‚‹æ¤œç´¢æœ€é©åŒ–
CREATE INDEX idx_user_rewards_composite ON user_rewards(user_id, earned_season_id);
CREATE INDEX idx_rewards_season_type ON rewards(season_id, type, is_active);

-- éƒ¨åˆ†ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªå ±é…¬ã®ã¿ï¼‰
CREATE INDEX idx_rewards_active ON rewards(type) WHERE is_active = true;
```

### 9.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æœ€é©åŒ–

1. **ç”»åƒã®é…å»¶èª­ã¿è¾¼ã¿**
   ```tsx
   <img 
     src={reward.image_url} 
     loading="lazy"
     onError={handleImageError}
   />
   ```

2. **ä»®æƒ³åŒ–ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«**ï¼ˆå¤§é‡ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å¯¾å¿œï¼‰
   ```tsx
   import { VirtuosoGrid } from 'react-virtuoso';
   
   <VirtuosoGrid
     data={rewards}
     itemContent={(index, reward) => <RewardCard reward={reward} />}
   />
   ```

3. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ±é…¬ãƒ‡ãƒ¼ã‚¿ã¯Zustandã§æ°¸ç¶šåŒ–
   - ç”»åƒã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ´»ç”¨

---

## 10. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### 10.1 å ±é…¬ä»˜ä¸ã®ä¸æ­£é˜²æ­¢

1. **ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰æ¤œè¨¼**
   - å ±é…¬ä»˜ä¸ã¯å¿…ãšã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰é–¢æ•°ã§å®Ÿè¡Œ
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‹ã‚‰ã®ç›´æ¥çš„ãªå ±é…¬ä»˜ä¸ã¯ç¦æ­¢

2. **é‡è¤‡ä»˜ä¸é˜²æ­¢**
   - UNIQUEåˆ¶ç´„ã«ã‚ˆã‚‹æŠ€è¡“çš„ãªé‡è¤‡é˜²æ­¢
   - ãƒ­ã‚°ã«ã‚ˆã‚‹ç›£æŸ»è¿½è·¡

3. **RLS ã«ã‚ˆã‚‹æ¨©é™ç®¡ç†**
   - ä»–ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å ±é…¬æƒ…å ±ã¸ã®ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢

### 10.2 ç”»åƒã‚¢ã‚»ãƒƒãƒˆç®¡ç†

1. **CDNä½¿ç”¨**
   - å ±é…¬ç”»åƒã¯CDNã§é…ä¿¡
   - æ”¹ã–ã‚“é˜²æ­¢ã®ãŸã‚ã®ãƒãƒƒã‚·ãƒ¥æ¤œè¨¼

2. **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**
   - ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¡¨ç¤º

---

## 11. é‹ç”¨ãƒ»ç›£è¦–

### 11.1 ãƒ¡ãƒˆãƒªã‚¯ã‚¹

1. **å ±é…¬ä»˜ä¸ç›£è¦–**
   ```sql
   -- æ—¥æ¬¡å ±é…¬ä»˜ä¸æ•°
   SELECT 
     DATE(earned_at) as date,
     COUNT(*) as rewards_granted
   FROM user_rewards 
   WHERE earned_at >= CURRENT_DATE - INTERVAL '7 days'
   GROUP BY DATE(earned_at);
   ```

2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆ**
   - ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸é–²è¦§æ•°
   - ãƒ•ãƒ¬ãƒ¼ãƒ å¤‰æ›´é »åº¦
   - å ±é…¬ç²å¾—é€šçŸ¥ã®ã‚¯ãƒªãƒƒã‚¯ç‡

### 11.2 ãƒ­ã‚°å‡ºåŠ›

```typescript
// å ±é…¬é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã®ãƒ­ã‚°
export const trackRewardEvents = {
  rewardEarned: (userId: string, rewardId: string, seasonId: string) => {
    console.log('Reward earned:', { userId, rewardId, seasonId });
  },
  frameEquipped: (userId: string, frameId: string) => {
    console.log('Frame equipped:', { userId, frameId });
  },
  collectionViewed: (userId: string, viewedByUserId: string) => {
    console.log('Collection viewed:', { userId, viewedByUserId });
  }
};
```

---

## 12. å®Ÿè£…å„ªå…ˆåº¦

### Phase 1: åŸºç›¤å®Ÿè£…
- [x] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [x] RLSè¨­å®š
- [x] BadgeCardå®Ÿè£…ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
- [x] å¤šè¨€èªåŒ–å¯¾å¿œ
- [ ] grant_season_rewardsé–¢æ•°å®Ÿè£…
- [ ] åŸºæœ¬çš„ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸æ©Ÿèƒ½æ”¹å–„

### Phase 2: UI/UXå®Ÿè£…ï¼ˆæœªå®Ÿè£…ï¼‰
- [ ] å ±é…¬ç²å¾—é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- [ ] ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
- [ ] ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œæ”¹å–„

### Phase 3: æœ€é©åŒ–ãƒ»æ‹¡å¼µï¼ˆæœªå®Ÿè£…ï¼‰
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
- [ ] é«˜åº¦ãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½
- [ ] ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ã‚¨ãƒ•ã‚§ã‚¯ãƒˆå¼·åŒ–
- [ ] åˆ†æãƒ»ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰

---

## 13. å®Ÿè£…æ¸ˆã¿æ©Ÿèƒ½ã¾ã¨ã‚ï¼ˆ2025å¹´7æœˆ22æ—¥ï¼‰

### âœ… å®Œäº†æ¸ˆã¿
1. **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ**: rewardsãƒ†ãƒ¼ãƒ–ãƒ«ã€user_rewardsãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆãƒãƒƒã‚¸ã®ã¿ï¼‰
2. **BadgeCard**: ã‚·ãƒ³ãƒ—ãƒ«ãªãƒãƒƒã‚¸è¡¨ç¤ºãƒ»è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½
3. **å¤šè¨€èªåŒ–**: åŸºæœ¬çš„ãªç¿»è¨³ã‚­ãƒ¼å®Ÿè£…
4. **CollectionPage**: åŸºæœ¬çš„ãªã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¡¨ç¤ºæ©Ÿèƒ½

### âŒ æœªå®Ÿè£…
1. **è‡ªå‹•å ±é…¬ä»˜ä¸ã‚·ã‚¹ãƒ†ãƒ **: grant_season_rewardsé–¢æ•°
2. **å ±é…¬ç²å¾—é€šçŸ¥**: ç‰¹åˆ¥ãªé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«
3. **ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½**: ã‚·ãƒ¼ã‚ºãƒ³åˆ¥ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
4. **ç®¡ç†ç”»é¢**: å ±é…¬ãƒã‚¹ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ç®¡ç†

### ğŸ”„ éƒ¨åˆ†å®Ÿè£…
1. **ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸**: åŸºæœ¬è¡¨ç¤ºã®ã¿ã€ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æœªå®Ÿè£…
2. **é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ **: åŸºæœ¬é€šçŸ¥ã¯å®Ÿè£…æ¸ˆã¿ã€å ±é…¬ç²å¾—é€šçŸ¥ã¯æœªå®Ÿè£…

---

## 13. å‚è€ƒè³‡æ–™

- [æ—¢å­˜ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ ](./BeatNexus.mdc#ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«é–¢é€£)
- [ã‚·ãƒ¼ã‚ºãƒ³ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](./ã‚·ãƒ¼ã‚ºãƒ³ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸.md)
- [é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](./é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸.md)
- [ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](./ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸.md)

---

**ä½œæˆè€…**: AI Assistant  
**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ22æ—¥
