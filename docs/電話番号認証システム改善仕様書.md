# 電話番号認証システム改善仕様書

## 📋 現在の問題点

### 🔍 調査結果
1. **auth.users テーブル**
   - 電話番号関連のカラム（phone, phone_confirmed_at等）は存在するが使用されていない
   - 全19ユーザー中、電話番号を持つユーザーは0人

2. **現在の認証フロー**
   - フロントエンドで電話番号認証（Twilio）を実装済み
   - 電話番号認証は完了するが、**auth.usersテーブルに電話番号が保存されない**
   - profilesテーブルにphone_numberカラムは削除済み（統一作業完了）

3. **重大な脆弱性**
   - 同じ電話番号で無制限にアカウント作成可能
   - 電話番号の重複チェック機能が存在しない
   - 認証情報が永続化されていない

## 🎯 改善目標

### 主要目標
- **一意性の確保**: 1つの電話番号につき1つのアカウントのみ
- **認証情報の永続化**: auth.usersテーブルへの適切な保存
- **重複防止**: アカウント作成時の電話番号重複チェック
- **セキュリティ強化**: 不正な複数アカウント作成の防止

## 🔧 技術仕様

### 1. データベース構造の変更

#### 現在のauth.usersテーブル構造（利用されていないカラム）
- `phone`: 電話番号（現在未使用）
- `phone_confirmed_at`: 電話番号認証日時（現在未使用）
- `phone_change`: 電話番号変更時の一時保存（現在未使用）

#### 改修方針
既存のカラムを活用し、適切な制約を追加

### 2. 認証フロー改善

#### 🔄 改善後のサインアップフロー
1. **メールアドレス入力**
2. **電話番号入力・SMS OTP送信**
3. **OTP検証**
4. **電話番号重複チェック** ⭐ 新規追加
5. **アカウント作成**
6. **auth.usersに電話番号保存** ⭐ 改善

### 3. 実装内容

#### A. 電話番号管理テーブルの作成
```sql
-- 電話番号認証情報を管理するテーブル
CREATE TABLE phone_verifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number TEXT NOT NULL UNIQUE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  verified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- インデックスとRLSポリシーを追加
CREATE INDEX idx_phone_verifications_phone_number ON phone_verifications(phone_number);
CREATE INDEX idx_phone_verifications_user_id ON phone_verifications(user_id);
ALTER TABLE phone_verifications ENABLE ROW LEVEL SECURITY;
```

#### B. 電話番号重複チェック関数
```sql
CREATE OR REPLACE FUNCTION check_phone_availability(p_phone_number TEXT)
RETURNS JSON AS $$
DECLARE
  existing_user_id UUID;
  existing_in_auth UUID;
BEGIN
  -- phone_verificationsテーブルで重複チェック
  SELECT user_id INTO existing_user_id
  FROM phone_verifications 
  WHERE phone_number = p_phone_number
  LIMIT 1;

  -- auth.usersテーブルでも確認（既存データ対応）
  IF existing_user_id IS NULL THEN
    SELECT id INTO existing_in_auth
    FROM auth.users 
    WHERE phone = p_phone_number 
      AND phone_confirmed_at IS NOT NULL
    LIMIT 1;
    
    IF existing_in_auth IS NOT NULL THEN
      existing_user_id := existing_in_auth;
    END IF;
  END IF;

  IF existing_user_id IS NOT NULL THEN
    RETURN json_build_object(
      'available', false,
      'error', 'phone_already_registered',
      'message', 'この電話番号は既に別のアカウントで使用されています'
    );
  END IF;

  RETURN json_build_object(
    'available', true,
    'message', 'この電話番号は利用可能です'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### C. Edge Function の改修

**phone-verification/index.ts** の主な変更点：

1. **電話番号重複チェックの追加**
```typescript
// OTP送信前に重複チェック
if (action === 'send_code') {
  // 重複チェック実行
  const { data: availabilityCheck } = await supabaseAdmin
    .rpc('check_phone_availability', { p_phone_number: formattedPhone });
  
  if (!availabilityCheck.available) {
    return corsResponse({ 
      error: availabilityCheck.error,
      message: availabilityCheck.message 
    }, 409);
  }
  
  // Twilio SMS送信
  const result = await sendVerificationCode(phoneNumber);
  // ...
}
```

2. **auth.usersテーブルと管理テーブルへの電話番号保存**
```typescript
// OTP検証成功時にphone_verificationsテーブルに記録
if (action === 'verify_code') {
  const result = await verifyCode(phoneNumber, code);
  
  if (result.success) {
    const authHeader = req.headers.get('authorization');
    if (authHeader && authHeader.startsWith('Bearer ')) {
      const token = authHeader.replace('Bearer ', '');
      
      const { data: { user } } = await supabaseAdmin.auth.getUser(token);
      if (user) {
        // 電話番号認証記録関数を呼び出し
        await supabaseAdmin.rpc('record_phone_verification', {
          p_user_id: user.id,
          p_phone_number: formattedPhone
        });
      }
    }
    
    return corsResponse({ 
      success: true, 
      message: 'Phone number verified and saved successfully' 
    });
  }
  // ...
}
```

#### D. record_phone_verification関数の作成

ユーザーの電話番号認証が完了した時に、管理テーブルに記録する関数。

```sql
CREATE OR REPLACE FUNCTION record_phone_verification(
  p_user_id UUID,
  p_phone_number TEXT
) RETURNS VOID AS $$
BEGIN
  -- 既存の記録があるかチェック
  IF EXISTS (SELECT 1 FROM phone_verifications WHERE user_id = p_user_id) THEN
    -- 既存記録を更新
    UPDATE phone_verifications 
    SET 
      phone_number = p_phone_number,
      verified_at = NOW(),
      updated_at = NOW()
    WHERE user_id = p_user_id;
  ELSE
    -- 新規記録を作成
    INSERT INTO phone_verifications (user_id, phone_number, verified_at)
    VALUES (p_user_id, p_phone_number, NOW());
  END IF;
  
  -- 念のためauth.usersも更新（既存機能との互換性のため）
  UPDATE auth.users 
  SET 
    phone = p_phone_number,
    phone_confirmed_at = NOW()
  WHERE id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### D. フロントエンド改修

**AuthModal.tsx** の主要変更点：

1. **エラーハンドリングの改善**
```typescript
// 重複エラーの適切な表示
if (data.error === 'phone_already_registered') {
  setError(t('auth.error.phoneAlreadyRegistered'));
} else {
  setError(data.error || t('auth.error.verificationFailed'));
}
```

2. **多言語対応のエラーメッセージ**
```json
// i18n/locales/ja.json
{
  "auth": {
    "error": {
      "phoneAlreadyRegistered": "この電話番号は既に別のアカウントで使用されています。別の電話番号をお試しください。"
    }
  }
}

// i18n/locales/en.json
{
  "auth": {
    "error": {
      "phoneAlreadyRegistered": "This phone number is already registered with another account. Please try a different phone number."
    }
  }
}
```

### 4. セキュリティ対策

#### A. レート制限
- 同一電話番号からの連続SMS送信を制限
- IP単位でのリクエスト制限

#### B. 電話番号の正規化
- 国際形式への統一変換
- 特殊文字の除去と正規化

#### C. ログ機能
- 認証試行の記録
- 不正アクセスの検知

## 📅 実装スケジュール

### Phase 1: データベース管理テーブル追加（優先度：高）
- [ ] phone_verificationsテーブルの作成
- [ ] RLSポリシーの設定
- [ ] check_phone_availability関数の更新
- [ ] record_phone_verification関数の作成
- [ ] インデックス作成
- [ ] 電話番号重複チェック関数作成

### Phase 2: Edge Function改修（優先度：高）
- [ ] phone-verification関数の改修
- [ ] 重複チェック機能追加
- [ ] auth.users更新処理追加

### Phase 3: フロントエンド改修（優先度：中）
- [ ] エラーハンドリング改善
- [ ] 多言語エラーメッセージ追加
- [ ] UI/UX改善

### Phase 4: テスト・検証（優先度：高）
- [ ] 重複防止機能のテスト
- [ ] 既存ユーザーへの影響確認
- [ ] パフォーマンステスト

## 🚨 リスク・注意点

### 技術リスク
1. **既存ユーザーへの影響**: 現在電話番号を持たないユーザーの取り扱い
2. **データ整合性**: auth.usersとprofilesテーブル間の整合性確保
3. **パフォーマンス**: 重複チェッククエリの最適化

### 運用リスク
1. **電話番号変更**: ユーザーが電話番号を変更する場合の対応
2. **バックアップ復旧**: 電話番号データの適切なバックアップ
3. **国際化**: 各国の電話番号形式への対応

## 🎯 成功指標

### 定量指標
- 重複アカウント作成試行の検知率: 100%
- 電話番号認証完了率: 95%以上維持
- 認証処理時間: 5秒以内

### 定性指標
- ユーザーからの「複数アカウント作成」に関する問い合わせの減少
- バトルシステムの公平性向上
- セキュリティ監査での評価向上

## 🔄 今後の拡張性

### 将来の機能拡張
1. **SMS以外の認証方法**: 音声通話認証の追加
2. **二段階認証**: 既存ユーザー向けの追加セキュリティ
3. **不正検知**: AI/ML を活用した不正アカウント検知
4. **国際化対応**: より多くの国の電話番号形式サポート

---

## 📝 実装時の参考情報

### 関連ファイル
- `supabase/functions/phone-verification/index.ts`
- `src/components/auth/AuthModal.tsx`
- `src/i18n/locales/ja.json`
- `src/i18n/locales/en.json`

### 参考ドキュメント
- [Supabase Auth API Documentation](https://supabase.com/docs/reference/javascript/auth-admin-updateuserbyid)
- [Twilio Verify API Documentation](https://www.twilio.com/docs/verify/api)
- [PostgreSQL Unique Constraints](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS)

この仕様書に基づいて実装を行うことで、電話番号認証システムの脆弱性を解決し、BeatNexusの公平性とセキュリティを大幅に向上させることができます。
