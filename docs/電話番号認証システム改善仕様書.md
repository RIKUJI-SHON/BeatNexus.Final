# é›»è©±ç•ªå·èªè¨¼ã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ä»•æ§˜æ›¸

## ğŸ“‹ ç¾åœ¨ã®å•é¡Œç‚¹

### ğŸ” èª¿æŸ»çµæœ
1. **auth.users ãƒ†ãƒ¼ãƒ–ãƒ«**
   - é›»è©±ç•ªå·é–¢é€£ã®ã‚«ãƒ©ãƒ ï¼ˆphone, phone_confirmed_atç­‰ï¼‰ã¯å­˜åœ¨ã™ã‚‹ãŒä½¿ç”¨ã•ã‚Œã¦ã„ãªã„
   - å…¨19ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸­ã€é›»è©±ç•ªå·ã‚’æŒã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯0äºº

2. **ç¾åœ¨ã®èªè¨¼ãƒ•ãƒ­ãƒ¼**
   - ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§é›»è©±ç•ªå·èªè¨¼ï¼ˆTwilioï¼‰ã‚’å®Ÿè£…æ¸ˆã¿
   - é›»è©±ç•ªå·èªè¨¼ã¯å®Œäº†ã™ã‚‹ãŒã€**auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã«é›»è©±ç•ªå·ãŒä¿å­˜ã•ã‚Œãªã„**
   - profilesãƒ†ãƒ¼ãƒ–ãƒ«ã«phone_numberã‚«ãƒ©ãƒ ã¯å‰Šé™¤æ¸ˆã¿ï¼ˆçµ±ä¸€ä½œæ¥­å®Œäº†ï¼‰

3. **é‡å¤§ãªè„†å¼±æ€§**
   - åŒã˜é›»è©±ç•ªå·ã§ç„¡åˆ¶é™ã«ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆå¯èƒ½
   - é›»è©±ç•ªå·ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ãŒå­˜åœ¨ã—ãªã„
   - èªè¨¼æƒ…å ±ãŒæ°¸ç¶šåŒ–ã•ã‚Œã¦ã„ãªã„

## ğŸ¯ æ”¹å–„ç›®æ¨™

### ä¸»è¦ç›®æ¨™
- **ä¸€æ„æ€§ã®ç¢ºä¿**: 1ã¤ã®é›»è©±ç•ªå·ã«ã¤ã1ã¤ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã¿
- **èªè¨¼æƒ…å ±ã®æ°¸ç¶šåŒ–**: auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®é©åˆ‡ãªä¿å­˜
- **é‡è¤‡é˜²æ­¢**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ™‚ã®é›»è©±ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¼·åŒ–**: ä¸æ­£ãªè¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã®é˜²æ­¢

## ğŸ”§ æŠ€è¡“ä»•æ§˜

### 1. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ§‹é€ ã®å¤‰æ›´

#### ç¾åœ¨ã®auth.usersãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ï¼ˆåˆ©ç”¨ã•ã‚Œã¦ã„ãªã„ã‚«ãƒ©ãƒ ï¼‰
- `phone`: é›»è©±ç•ªå·ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰
- `phone_confirmed_at`: é›»è©±ç•ªå·èªè¨¼æ—¥æ™‚ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰
- `phone_change`: é›»è©±ç•ªå·å¤‰æ›´æ™‚ã®ä¸€æ™‚ä¿å­˜ï¼ˆç¾åœ¨æœªä½¿ç”¨ï¼‰

#### æ”¹ä¿®æ–¹é‡
æ—¢å­˜ã®ã‚«ãƒ©ãƒ ã‚’æ´»ç”¨ã—ã€é©åˆ‡ãªåˆ¶ç´„ã‚’è¿½åŠ 

### 2. èªè¨¼ãƒ•ãƒ­ãƒ¼æ”¹å–„

#### ğŸ”„ æ”¹å–„å¾Œã®ã‚µã‚¤ãƒ³ã‚¢ãƒƒãƒ—ãƒ•ãƒ­ãƒ¼
1. **ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›**
2. **é›»è©±ç•ªå·å…¥åŠ›ãƒ»SMS OTPé€ä¿¡**
3. **OTPæ¤œè¨¼**
4. **é›»è©±ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯** â­ æ–°è¦è¿½åŠ 
5. **ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ**
6. **auth.usersã«é›»è©±ç•ªå·ä¿å­˜** â­ æ”¹å–„

### 3. å®Ÿè£…å†…å®¹

#### A. é›»è©±ç•ªå·ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
```sql
-- é›»è©±ç•ªå·èªè¨¼æƒ…å ±ã‚’ç®¡ç†ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE phone_verifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  phone_number TEXT NOT NULL UNIQUE,
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  verified_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¨RLSãƒãƒªã‚·ãƒ¼ã‚’è¿½åŠ 
CREATE INDEX idx_phone_verifications_phone_number ON phone_verifications(phone_number);
CREATE INDEX idx_phone_verifications_user_id ON phone_verifications(user_id);
ALTER TABLE phone_verifications ENABLE ROW LEVEL SECURITY;
```

#### B. é›»è©±ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°
```sql
CREATE OR REPLACE FUNCTION check_phone_availability(p_phone_number TEXT)
RETURNS JSON AS $$
DECLARE
  existing_user_id UUID;
  existing_in_auth UUID;
BEGIN
  -- phone_verificationsãƒ†ãƒ¼ãƒ–ãƒ«ã§é‡è¤‡ãƒã‚§ãƒƒã‚¯
  SELECT user_id INTO existing_user_id
  FROM phone_verifications 
  WHERE phone_number = p_phone_number
  LIMIT 1;

  -- auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚‚ç¢ºèªï¼ˆæ—¢å­˜ãƒ‡ãƒ¼ã‚¿å¯¾å¿œï¼‰
  IF existing_user_id IS NULL THEN
    SELECT id INTO existing_in_auth
    FROM auth.users 
    WHERE phone = p_phone_number 
      AND phone_confirmed_at IS NOT NULL
    LIMIT 1;
    
    IF existing_in_auth IS NOT NULL THEN
      existing_user_id := existing_in_auth;
    END IF;
  END IF;

  IF existing_user_id IS NOT NULL THEN
    RETURN json_build_object(
      'available', false,
      'error', 'phone_already_registered',
      'message', 'ã“ã®é›»è©±ç•ªå·ã¯æ—¢ã«åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™'
    );
  END IF;

  RETURN json_build_object(
    'available', true,
    'message', 'ã“ã®é›»è©±ç•ªå·ã¯åˆ©ç”¨å¯èƒ½ã§ã™'
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### C. Edge Function ã®æ”¹ä¿®

**phone-verification/index.ts** ã®ä¸»ãªå¤‰æ›´ç‚¹ï¼š

1. **é›»è©±ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®è¿½åŠ **
```typescript
// OTPé€ä¿¡å‰ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯
if (action === 'send_code') {
  // é‡è¤‡ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
  const { data: availabilityCheck } = await supabaseAdmin
    .rpc('check_phone_availability', { p_phone_number: formattedPhone });
  
  if (!availabilityCheck.available) {
    return corsResponse({ 
      error: availabilityCheck.error,
      message: availabilityCheck.message 
    }, 409);
  }
  
  // Twilio SMSé€ä¿¡
  const result = await sendVerificationCode(phoneNumber);
  // ...
}
```

2. **auth.usersãƒ†ãƒ¼ãƒ–ãƒ«ã¨ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®é›»è©±ç•ªå·ä¿å­˜**
```typescript
// OTPæ¤œè¨¼æˆåŠŸæ™‚ã«phone_verificationsãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²
if (action === 'verify_code') {
  const result = await verifyCode(phoneNumber, code);
  
  if (result.success) {
    const authHeader = req.headers.get('authorization');
    if (authHeader && authHeader.startsWith('Bearer ')) {
      const token = authHeader.replace('Bearer ', '');
      
      const { data: { user } } = await supabaseAdmin.auth.getUser(token);
      if (user) {
        // é›»è©±ç•ªå·èªè¨¼è¨˜éŒ²é–¢æ•°ã‚’å‘¼ã³å‡ºã—
        await supabaseAdmin.rpc('record_phone_verification', {
          p_user_id: user.id,
          p_phone_number: formattedPhone
        });
      }
    }
    
    return corsResponse({ 
      success: true, 
      message: 'Phone number verified and saved successfully' 
    });
  }
  // ...
}
```

#### D. record_phone_verificationé–¢æ•°ã®ä½œæˆ

ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é›»è©±ç•ªå·èªè¨¼ãŒå®Œäº†ã—ãŸæ™‚ã«ã€ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²ã™ã‚‹é–¢æ•°ã€‚

```sql
CREATE OR REPLACE FUNCTION record_phone_verification(
  p_user_id UUID,
  p_phone_number TEXT
) RETURNS VOID AS $$
BEGIN
  -- æ—¢å­˜ã®è¨˜éŒ²ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
  IF EXISTS (SELECT 1 FROM phone_verifications WHERE user_id = p_user_id) THEN
    -- æ—¢å­˜è¨˜éŒ²ã‚’æ›´æ–°
    UPDATE phone_verifications 
    SET 
      phone_number = p_phone_number,
      verified_at = NOW(),
      updated_at = NOW()
    WHERE user_id = p_user_id;
  ELSE
    -- æ–°è¦è¨˜éŒ²ã‚’ä½œæˆ
    INSERT INTO phone_verifications (user_id, phone_number, verified_at)
    VALUES (p_user_id, p_phone_number, NOW());
  END IF;
  
  -- å¿µã®ãŸã‚auth.usersã‚‚æ›´æ–°ï¼ˆæ—¢å­˜æ©Ÿèƒ½ã¨ã®äº’æ›æ€§ã®ãŸã‚ï¼‰
  UPDATE auth.users 
  SET 
    phone = p_phone_number,
    phone_confirmed_at = NOW()
  WHERE id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
```

#### D. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ”¹ä¿®

**AuthModal.tsx** ã®ä¸»è¦å¤‰æ›´ç‚¹ï¼š

1. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„**
```typescript
// é‡è¤‡ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªè¡¨ç¤º
if (data.error === 'phone_already_registered') {
  setError(t('auth.error.phoneAlreadyRegistered'));
} else {
  setError(data.error || t('auth.error.verificationFailed'));
}
```

2. **å¤šè¨€èªå¯¾å¿œã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**
```json
// i18n/locales/ja.json
{
  "auth": {
    "error": {
      "phoneAlreadyRegistered": "ã“ã®é›»è©±ç•ªå·ã¯æ—¢ã«åˆ¥ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ä½¿ç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚åˆ¥ã®é›»è©±ç•ªå·ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚"
    }
  }
}

// i18n/locales/en.json
{
  "auth": {
    "error": {
      "phoneAlreadyRegistered": "This phone number is already registered with another account. Please try a different phone number."
    }
  }
}
```

### 4. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¯¾ç­–

#### A. ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- åŒä¸€é›»è©±ç•ªå·ã‹ã‚‰ã®é€£ç¶šSMSé€ä¿¡ã‚’åˆ¶é™
- IPå˜ä½ã§ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆåˆ¶é™

#### B. é›»è©±ç•ªå·ã®æ­£è¦åŒ–
- å›½éš›å½¢å¼ã¸ã®çµ±ä¸€å¤‰æ›
- ç‰¹æ®Šæ–‡å­—ã®é™¤å»ã¨æ­£è¦åŒ–

#### C. ãƒ­ã‚°æ©Ÿèƒ½
- èªè¨¼è©¦è¡Œã®è¨˜éŒ²
- ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹ã®æ¤œçŸ¥

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### Phase 1: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰
- [ ] phone_verificationsãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½œæˆ
- [ ] RLSãƒãƒªã‚·ãƒ¼ã®è¨­å®š
- [ ] check_phone_availabilityé–¢æ•°ã®æ›´æ–°
- [ ] record_phone_verificationé–¢æ•°ã®ä½œæˆ
- [ ] ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆ
- [ ] é›»è©±ç•ªå·é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°ä½œæˆ

### Phase 2: Edge Functionæ”¹ä¿®ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰
- [ ] phone-verificationé–¢æ•°ã®æ”¹ä¿®
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½è¿½åŠ 
- [ ] auth.usersæ›´æ–°å‡¦ç†è¿½åŠ 

### Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ”¹ä¿®ï¼ˆå„ªå…ˆåº¦ï¼šä¸­ï¼‰
- [ ] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ”¹å–„
- [ ] å¤šè¨€èªã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¿½åŠ 
- [ ] UI/UXæ”¹å–„

### Phase 4: ãƒ†ã‚¹ãƒˆãƒ»æ¤œè¨¼ï¼ˆå„ªå…ˆåº¦ï¼šé«˜ï¼‰
- [ ] é‡è¤‡é˜²æ­¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
- [ ] æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿ç¢ºèª
- [ ] ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ

## ğŸš¨ ãƒªã‚¹ã‚¯ãƒ»æ³¨æ„ç‚¹

### æŠ€è¡“ãƒªã‚¹ã‚¯
1. **æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å½±éŸ¿**: ç¾åœ¨é›»è©±ç•ªå·ã‚’æŒãŸãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å–ã‚Šæ‰±ã„
2. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: auth.usersã¨profilesãƒ†ãƒ¼ãƒ–ãƒ«é–“ã®æ•´åˆæ€§ç¢ºä¿
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚¯ã‚¨ãƒªã®æœ€é©åŒ–

### é‹ç”¨ãƒªã‚¹ã‚¯
1. **é›»è©±ç•ªå·å¤‰æ›´**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé›»è©±ç•ªå·ã‚’å¤‰æ›´ã™ã‚‹å ´åˆã®å¯¾å¿œ
2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å¾©æ—§**: é›»è©±ç•ªå·ãƒ‡ãƒ¼ã‚¿ã®é©åˆ‡ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
3. **å›½éš›åŒ–**: å„å›½ã®é›»è©±ç•ªå·å½¢å¼ã¸ã®å¯¾å¿œ

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### å®šé‡æŒ‡æ¨™
- é‡è¤‡ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆè©¦è¡Œã®æ¤œçŸ¥ç‡: 100%
- é›»è©±ç•ªå·èªè¨¼å®Œäº†ç‡: 95%ä»¥ä¸Šç¶­æŒ
- èªè¨¼å‡¦ç†æ™‚é–“: 5ç§’ä»¥å†…

### å®šæ€§æŒ‡æ¨™
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ã€Œè¤‡æ•°ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆã€ã«é–¢ã™ã‚‹å•ã„åˆã‚ã›ã®æ¸›å°‘
- ãƒãƒˆãƒ«ã‚·ã‚¹ãƒ†ãƒ ã®å…¬å¹³æ€§å‘ä¸Š
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»ã§ã®è©•ä¾¡å‘ä¸Š

## ğŸ”„ ä»Šå¾Œã®æ‹¡å¼µæ€§

### å°†æ¥ã®æ©Ÿèƒ½æ‹¡å¼µ
1. **SMSä»¥å¤–ã®èªè¨¼æ–¹æ³•**: éŸ³å£°é€šè©±èªè¨¼ã®è¿½åŠ 
2. **äºŒæ®µéšèªè¨¼**: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ã®è¿½åŠ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
3. **ä¸æ­£æ¤œçŸ¥**: AI/ML ã‚’æ´»ç”¨ã—ãŸä¸æ­£ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ¤œçŸ¥
4. **å›½éš›åŒ–å¯¾å¿œ**: ã‚ˆã‚Šå¤šãã®å›½ã®é›»è©±ç•ªå·å½¢å¼ã‚µãƒãƒ¼ãƒˆ

---

## ğŸ“ å®Ÿè£…æ™‚ã®å‚è€ƒæƒ…å ±

### é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `supabase/functions/phone-verification/index.ts`
- `src/components/auth/AuthModal.tsx`
- `src/i18n/locales/ja.json`
- `src/i18n/locales/en.json`

### å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [Supabase Auth API Documentation](https://supabase.com/docs/reference/javascript/auth-admin-updateuserbyid)
- [Twilio Verify API Documentation](https://www.twilio.com/docs/verify/api)
- [PostgreSQL Unique Constraints](https://www.postgresql.org/docs/current/ddl-constraints.html#DDL-CONSTRAINTS-UNIQUE-CONSTRAINTS)

ã“ã®ä»•æ§˜æ›¸ã«åŸºã¥ã„ã¦å®Ÿè£…ã‚’è¡Œã†ã“ã¨ã§ã€é›»è©±ç•ªå·èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ã®è„†å¼±æ€§ã‚’è§£æ±ºã—ã€BeatNexusã®å…¬å¹³æ€§ã¨ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
