# BeatNexus ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ä»•æ§˜æ›¸

## æ–‡æ›¸æƒ…å ±
- **ä½œæˆæ—¥**: 2025å¹´7æœˆ20æ—¥
- **ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0
- **å¯¾è±¡ç’°å¢ƒ**: æœ¬ç•ªç’°å¢ƒãƒ»é–‹ç™ºç’°å¢ƒå…±é€š
- **æœ€çµ‚æ›´æ–°**: ãƒãƒˆãƒ«çµŒé¨“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ©Ÿèƒ½å®Ÿè£…

---

## ç›®æ¬¡
1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ç¨®é¡](#ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ç¨®é¡)
3. [ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ](#ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ)
4. [ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯](#ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯)
5. [ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†](#ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†)
6. [ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»•æ§˜](#ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»•æ§˜)
7. [APIä»•æ§˜](#apiä»•æ§˜)
8. [UI/UXä»•æ§˜](#uiuxä»•æ§˜)
9. [ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)
10. [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹](#ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹)
11. [ä¿å®ˆãƒ»é‹ç”¨](#ä¿å®ˆé‹ç”¨)
12. [å¤‰æ›´å±¥æ­´](#å¤‰æ›´å±¥æ­´)

---

## æ¦‚è¦

BeatNexusã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒˆãƒ«æˆç¸¾ã¨æŠ•ç¥¨æ´»å‹•ã‚’å¯è¦–åŒ–ã—ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ç«¶äº‰è¦ç´ ã‚’æä¾›ã™ã‚‹ã‚·ã‚¹ãƒ†ãƒ ã§ã™ã€‚

### ä¸»è¦æ©Ÿèƒ½
- **ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°**: ãƒãƒˆãƒ«æˆç¸¾ã«åŸºã¥ããƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°**: æŠ•ç¥¨æ´»å‹•ã«åŸºã¥ããƒ©ãƒ³ã‚­ãƒ³ã‚°
- **ã‚·ãƒ¼ã‚ºãƒ³åˆ¶**: å®šæœŸçš„ãªãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚»ãƒƒãƒˆã¨è¨˜éŒ²ä¿å­˜
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°**: ãƒãƒˆãƒ«çµæœãƒ»æŠ•ç¥¨ã®å³åº§åæ˜ 

---

## ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ç¨®é¡

### 1. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°

#### 1.1 é€šç®—ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æ¦‚è¦**: å…¨æœŸé–“ã‚’é€šã˜ãŸãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **è©•ä¾¡æŒ‡æ¨™**: ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆEloã‚·ã‚¹ãƒ†ãƒ ï¼‰
- **è¡¨ç¤ºæ¡ä»¶**: ãƒãƒˆãƒ«çµŒé¨“è€…ï¼ˆå‹æ•—æ•°åˆè¨ˆ >= 1ï¼‰ã®ã¿
- **ã‚½ãƒ¼ãƒˆé †**: ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é™é † â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ˜‡é †

#### 1.2 ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æ¦‚è¦**: ç¾åœ¨ã‚·ãƒ¼ã‚ºãƒ³ã®ãƒã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **è©•ä¾¡æŒ‡æ¨™**: ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆ
- **è¡¨ç¤ºæ¡ä»¶**: ãƒãƒˆãƒ«çµŒé¨“è€…ï¼ˆå‹æ•—æ•°åˆè¨ˆ >= 1ï¼‰ã®ã¿
- **ã‚½ãƒ¼ãƒˆé †**: ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆé™é † â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼åæ˜‡é †

#### 1.3 éå»ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æ¦‚è¦**: çµ‚äº†ã—ãŸã‚·ãƒ¼ã‚ºãƒ³ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **è©•ä¾¡æŒ‡æ¨™**: å½“æ™‚ã®æœ€çµ‚ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆ
- **è¡¨ç¤ºæ¡ä»¶**: ãã®ã‚·ãƒ¼ã‚ºãƒ³ã§ãƒãƒˆãƒ«çµŒé¨“ãŒã‚ã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿
- **ã‚½ãƒ¼ãƒˆé †**: æœ€çµ‚é †ä½æ˜‡é †

### 2. æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°

#### 2.1 é€šç®—æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æ¦‚è¦**: å…¨æœŸé–“ã‚’é€šã˜ãŸæŠ•ç¥¨æ´»å‹•ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **è©•ä¾¡æŒ‡æ¨™**: ç·æŠ•ç¥¨æ•°
- **è¡¨ç¤ºæ¡ä»¶**: æŠ•ç¥¨çµŒé¨“è€…ï¼ˆvote_count >= 1ï¼‰ã®ã¿
- **ã‚½ãƒ¼ãƒˆé †**: æŠ•ç¥¨æ•°é™é † â†’ ä½œæˆæ—¥æ™‚æ˜‡é †

#### 2.2 ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **æ¦‚è¦**: ç¾åœ¨ã‚·ãƒ¼ã‚ºãƒ³ã®æŠ•ç¥¨æ´»å‹•ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- **è©•ä¾¡æŒ‡æ¨™**: ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨ãƒã‚¤ãƒ³ãƒˆ
- **è¡¨ç¤ºæ¡ä»¶**: ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨çµŒé¨“è€…ï¼ˆseason_vote_points >= 1ï¼‰ã®ã¿
- **ã‚½ãƒ¼ãƒˆé †**: ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨ãƒã‚¤ãƒ³ãƒˆé™é † â†’ ä½œæˆæ—¥æ™‚æ˜‡é †

---

## ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### 3.1 ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ« (profiles)

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼åŸºæœ¬æƒ…å ±ã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°é–¢é€£ãƒ‡ãƒ¼ã‚¿
CREATE TABLE profiles (
    id UUID PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    avatar_url TEXT,
    rating INTEGER DEFAULT 1200,           -- é€šç®—ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
    season_points INTEGER DEFAULT 1200,    -- ç¾åœ¨ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆ
    vote_count INTEGER DEFAULT 0,          -- é€šç®—æŠ•ç¥¨æ•°
    season_vote_points INTEGER DEFAULT 0,  -- ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨ãƒã‚¤ãƒ³ãƒˆ
    is_deleted BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.2 ã‚·ãƒ¼ã‚ºãƒ³ãƒ†ãƒ¼ãƒ–ãƒ« (seasons)

```sql
-- ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†
CREATE TABLE seasons (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) UNIQUE NOT NULL,     -- ä¾‹: "2025-S1", "HeartBeat"
    status VARCHAR(20) DEFAULT 'upcoming', -- upcoming/active/ended
    start_at TIMESTAMPTZ NOT NULL,
    end_at TIMESTAMPTZ NOT NULL,
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3.3 ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (season_rankings)

```sql
-- çµ‚äº†ã‚·ãƒ¼ã‚ºãƒ³ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨˜éŒ²
CREATE TABLE season_rankings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    season_id UUID NOT NULL REFERENCES seasons(id),
    user_id UUID NOT NULL REFERENCES profiles(id),
    points INTEGER NOT NULL,               -- æœ€çµ‚ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆ
    rank INTEGER NOT NULL,                 -- æœ€çµ‚é †ä½
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(season_id, user_id)
);
```

### 3.4 ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ– (season_voter_rankings)

```sql
-- çµ‚äº†ã‚·ãƒ¼ã‚ºãƒ³ã®æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¨˜éŒ²
CREATE TABLE season_voter_rankings (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    season_id UUID NOT NULL REFERENCES seasons(id),
    user_id UUID NOT NULL REFERENCES profiles(id),
    votes INTEGER NOT NULL,                -- æœ€çµ‚æŠ•ç¥¨ãƒã‚¤ãƒ³ãƒˆ
    rank INTEGER NOT NULL,                 -- æœ€çµ‚é †ä½
    created_at TIMESTAMPTZ DEFAULT NOW(),
    UNIQUE(season_id, user_id)
);
```

### 3.5 ãƒãƒˆãƒ«å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ« (archived_battles)

```sql
-- ãƒãƒˆãƒ«çµŒé¨“åˆ¤å®šç”¨
CREATE TABLE archived_battles (
    id UUID PRIMARY KEY,
    player1_user_id UUID REFERENCES profiles(id),
    player2_user_id UUID REFERENCES profiles(id),
    winner_id UUID REFERENCES profiles(id),  -- NULL = å¼•ãåˆ†ã‘
    player1_rating_change INTEGER,
    player2_rating_change INTEGER,
    season_id UUID REFERENCES seasons(id),
    created_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

### 4.1 ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ“ãƒ¥ãƒ¼å®šç¾©

#### é€šç®—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚° (rankings_view)
```sql
CREATE VIEW rankings_view AS
SELECT 
  p.id AS user_id,
  p.username,
  p.avatar_url,
  p.rating,
  p.season_points,
  (SELECT count(*) FROM archived_battles ab WHERE ab.winner_id = p.id) AS battles_won,
  (SELECT count(*) FROM archived_battles ab 
   WHERE ((ab.player1_user_id = p.id) OR (ab.player2_user_id = p.id)) 
   AND (ab.winner_id IS NOT NULL) 
   AND (ab.winner_id <> p.id)) AS battles_lost,
  rank() OVER (ORDER BY p.rating DESC, p.updated_at) AS rank
FROM profiles p
WHERE p.is_deleted = false
  AND (
    -- ãƒãƒˆãƒ«çµŒé¨“è€…ã®ã¿: å‹åˆ©æ•° + æ•—åŒ—æ•° >= 1
    (SELECT count(*) FROM archived_battles ab WHERE ab.winner_id = p.id) +
    (SELECT count(*) FROM archived_battles ab 
     WHERE ((ab.player1_user_id = p.id) OR (ab.player2_user_id = p.id)) 
     AND (ab.winner_id IS NOT NULL) 
     AND (ab.winner_id <> p.id)) >= 1
  );
```

#### é€šç®—æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚° (voter_rankings_view)
```sql
CREATE VIEW voter_rankings_view AS
SELECT 
  p.id,
  p.username,
  p.avatar_url,
  p.vote_count,
  dense_rank() OVER (ORDER BY p.vote_count DESC, p.created_at) AS rank
FROM profiles p
WHERE p.is_deleted = false
  AND p.vote_count >= 1;  -- æŠ•ç¥¨çµŒé¨“è€…ã®ã¿
```

### 4.2 ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯

#### ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•° (rankingStore)
```typescript
const getCurrentData = () => {
  if (activeTab === 'player') {
    const rankingType = activeRankingType;
    if (rankingType === 'current_season') {
      if (selectedSeasonId === currentSeason?.id) {
        return seasonRankings;
      } else {
        return historicalSeasonRankings.map(entry => ({
          user_id: entry.user_id,
          username: entry.username,
          avatar_url: entry.avatar_url,
          rating: entry.points,
          position: entry.rank,
          // ... ãã®ä»–ã®ãƒãƒƒãƒ”ãƒ³ã‚°
        }));
      }
    } else {
      return rankings;
    }
  } else {
    // æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°å‡¦ç†
    // ...
  }
};
```

---

## ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†

### 5.1 ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«

```mermaid
graph LR
    A[Upcoming] --> B[Active]
    B --> C[Ended]
    C --> D[Archived]
```

#### 5.1.1 ã‚·ãƒ¼ã‚ºãƒ³é–‹å§‹
- å‰ã‚·ãƒ¼ã‚ºãƒ³ã®çµ‚äº†æ™‚ã«è‡ªå‹•é–‹å§‹
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `season_points` ã‚’ 1200 ã«ãƒªã‚»ãƒƒãƒˆ
- å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã® `season_vote_points` ã‚’ 0 ã«ãƒªã‚»ãƒƒãƒˆ

#### 5.1.2 ã‚·ãƒ¼ã‚ºãƒ³é€²è¡Œä¸­
- ãƒãƒˆãƒ«çµæœã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
- æŠ•ç¥¨æ´»å‹•ã«ã‚ˆã‚‹ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒã‚¤ãƒ³ãƒˆåŠ ç®—

#### 5.1.3 ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†
- **è‡ªå‹•å®Ÿè¡Œ**: pg_cron ã«ã‚ˆã‚Šæ¯æ—¥ 00:05 (UTC) ã« `end_current_season()` å®Ÿè¡Œ
- **æ‰‹å‹•å®Ÿè¡Œ**: ç®¡ç†è€…ã«ã‚ˆã‚‹ä»»æ„ã‚¿ã‚¤ãƒŸãƒ³ã‚°å®Ÿè¡Œ

### 5.2 ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†å‡¦ç† (end_current_seasoné–¢æ•°)

```sql
CREATE OR REPLACE FUNCTION end_current_season()
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_current_season RECORD;
  v_player_ranking_count INTEGER := 0;
  v_voter_ranking_count INTEGER := 0;
  -- ä»–ã®å¤‰æ•°å®£è¨€...
BEGIN
  -- 1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ã‚ºãƒ³å–å¾—
  SELECT * INTO v_current_season
  FROM seasons 
  WHERE status = 'active'
  ORDER BY created_at DESC
  LIMIT 1;
  
  -- 2. ãƒãƒˆãƒ«ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆãƒãƒˆãƒ«çµŒé¨“è€…ã®ã¿ï¼‰
  INSERT INTO season_rankings (season_id, user_id, points, rank)
  SELECT v_current_season.id, p.id, p.season_points,
         ROW_NUMBER() OVER (ORDER BY p.season_points DESC, p.username ASC)
  FROM profiles p
  WHERE p.is_deleted = FALSE
  AND (
    -- ãƒãƒˆãƒ«çµŒé¨“è€…åˆ¤å®š
    (SELECT count(*) FROM archived_battles ab WHERE ab.winner_id = p.id) +
    (SELECT count(*) FROM archived_battles ab 
     WHERE ((ab.player1_user_id = p.id) OR (ab.player2_user_id = p.id)) 
     AND (ab.winner_id IS NOT NULL) 
     AND (ab.winner_id <> p.id)) >= 1
  );
  
  -- 3. æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ï¼ˆæŠ•ç¥¨çµŒé¨“è€…ã®ã¿ï¼‰
  INSERT INTO season_voter_rankings (season_id, user_id, votes, rank)
  SELECT v_current_season.id, id, season_vote_points,
         ROW_NUMBER() OVER (ORDER BY season_vote_points DESC, username ASC)
  FROM profiles
  WHERE is_deleted = FALSE
  AND season_vote_points >= 1;
  
  -- 4. ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†å‡¦ç†
  UPDATE seasons SET status = 'ended', end_at = NOW() WHERE id = v_current_season.id;
  
  -- 5. ãƒã‚¤ãƒ³ãƒˆãƒªã‚»ãƒƒãƒˆ
  UPDATE profiles SET season_points = 1200, season_vote_points = 0 WHERE is_deleted = FALSE;
  
  -- 6. æ¬¡ã‚·ãƒ¼ã‚ºãƒ³é–‹å§‹
  -- æ–°ã‚·ãƒ¼ã‚ºãƒ³ä½œæˆå‡¦ç†...
  
  RETURN json_build_object('success', true, /* ... */);
END;
$$;
```

---

## ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ä»•æ§˜

### 6.1 ãƒãƒˆãƒ«çµŒé¨“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: ãƒãƒˆãƒ«æœªçµŒé¨“è€…ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1200ãƒã‚¤ãƒ³ãƒˆï¼‰ã®å¤§é‡è¡¨ç¤ºã‚’é˜²æ­¢

**åˆ¤å®šæ¡ä»¶**:
```sql
-- ãƒãƒˆãƒ«çµŒé¨“åˆ¤å®š
(SELECT count(*) FROM archived_battles ab WHERE ab.winner_id = user_id) +  -- å‹åˆ©æ•°
(SELECT count(*) FROM archived_battles ab 
 WHERE ((ab.player1_user_id = user_id) OR (ab.player2_user_id = user_id)) 
 AND (ab.winner_id IS NOT NULL) 
 AND (ab.winner_id <> user_id)) >= 1  -- æ•—åŒ—æ•°
```

**é©ç”¨ç®‡æ‰€**:
- é€šç®—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
- ã‚·ãƒ¼ã‚ºãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
- ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†

### 6.2 æŠ•ç¥¨çµŒé¨“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**ç›®çš„**: æŠ•ç¥¨æ´»å‹•ã®ãªã„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰é™¤å¤–

**åˆ¤å®šæ¡ä»¶**:
- é€šç®—æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°: `vote_count >= 1`
- ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°: `season_vote_points >= 1`

**é©ç”¨ç®‡æ‰€**:
- é€šç®—æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
- ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º
- ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†

### 6.3 å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°

**åˆ¤å®šæ¡ä»¶**: `is_deleted = FALSE`

**é©ç”¨ç®‡æ‰€**: å…¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†

---

## APIä»•æ§˜

### 7.1 ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—API

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `GET /api/rankings` - é€šç®—ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- `GET /api/voter-rankings` - é€šç®—æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- `GET /api/season-rankings` - ã‚·ãƒ¼ã‚ºãƒ³ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- `GET /api/season-voter-rankings` - ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°
- `GET /api/historical-rankings/:seasonId` - éå»ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°

#### ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼
```typescript
interface RankingEntry {
  user_id: string;
  username: string;
  avatar_url: string | null;
  rating?: number;           // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿
  season_points?: number;    // ã‚·ãƒ¼ã‚ºãƒ³ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿
  vote_count?: number;       // æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿
  battles_won?: number;      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿
  battles_lost?: number;     // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ã¿
  position: number;          // é †ä½
  rank?: number;             // ãƒ“ãƒ¥ãƒ¼ã‹ã‚‰å–å¾—ã•ã‚Œã‚‹é †ä½
}

interface RankingResponse {
  data: RankingEntry[];
  total: number;
  page?: number;
  pageSize?: number;
}
```

### 7.2 ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†API

#### ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- `GET /api/seasons` - ã‚·ãƒ¼ã‚ºãƒ³ä¸€è¦§
- `GET /api/seasons/current` - ç¾åœ¨ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ã‚ºãƒ³
- `POST /api/admin/seasons/end` - ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†ï¼ˆç®¡ç†è€…é™å®šï¼‰

---

## UI/UXä»•æ§˜

### 8.1 ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒšãƒ¼ã‚¸                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼] [æŠ•ç¥¨è€…] ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [é€šç®—] [ã‚·ãƒ¼ã‚ºãƒ³] [éå»ã‚·ãƒ¼ã‚ºãƒ³â–¼] é¸æŠ    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ” æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ† TOP3 ãƒãƒ‡ã‚£ã‚¦ãƒ è¡¨ç¤º                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ğŸ“‹ è©³ç´°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒªã‚¹ãƒˆ                  â”‚
â”‚   #4 ãƒ¦ãƒ¼ã‚¶ãƒ¼å 1,234pt [è©³ç´°]          â”‚
â”‚   #5 ãƒ¦ãƒ¼ã‚¶ãƒ¼å 1,200pt [è©³ç´°]          â”‚
â”‚   ...                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 TopThreePodiumä»•æ§˜

**è¡¨ç¤ºæ¡ä»¶**: 
- 1ä½ã€œ3ä½ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã™ã‚‹å ´åˆã«è¡¨ç¤º
- 3äººæœªæº€ã§ã‚‚æŸ”è»Ÿã«è¡¨ç¤ºå¯¾å¿œ

**è¡¨ç¤ºå†…å®¹**:
- é †ä½ãƒãƒƒã‚¸ï¼ˆ1ä½: é‡‘ã€2ä½: éŠ€ã€3ä½: éŠ…ï¼‰
- ãƒ¦ãƒ¼ã‚¶ãƒ¼å
- ã‚¢ãƒã‚¿ãƒ¼ç”»åƒ
- ãƒã‚¤ãƒ³ãƒˆæ•°
- è©³ç´°ã¸ã®ãƒªãƒ³ã‚¯

### 8.3 æ¤œç´¢æ©Ÿèƒ½

**å¯¾è±¡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã§ã®éƒ¨åˆ†ä¸€è‡´æ¤œç´¢
**ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: å…¥åŠ›ä¸­ã®å³åº§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
**å¤§æ–‡å­—å°æ–‡å­—**: åŒºåˆ¥ã—ãªã„

### 8.4 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ

- **ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—**: 3ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ
- **ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ**: 2ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ  
- **ãƒ¢ãƒã‚¤ãƒ«**: 1ã‚«ãƒ©ãƒ ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ

---

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### 9.1 ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡

**ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤º**: èªè¨¼ä¸è¦ï¼ˆåŒ¿åãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚‚é–²è¦§å¯èƒ½ï¼‰
**ã‚·ãƒ¼ã‚ºãƒ³ç®¡ç†**: ç®¡ç†è€…æ¨©é™å¿…é ˆ
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ“ãƒ¥ãƒ¼**: RLSï¼ˆRow Level Securityï¼‰é©ç”¨

### 9.2 ãƒ‡ãƒ¼ã‚¿ä¿è­·

**å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼**: `is_deleted = TRUE` ã§ã‚½ãƒ•ãƒˆå‰Šé™¤
**å€‹äººæƒ…å ±**: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¨ã‚¢ãƒã‚¿ãƒ¼ã®ã¿å…¬é–‹
**ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ“ä½œ**: ä¸æ­£ãªãƒã‚¤ãƒ³ãƒˆæ“ä½œã®é˜²æ­¢

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹

### 10.1 ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ

```sql
-- profiles ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_profiles_rating ON profiles(rating DESC, updated_at);
CREATE INDEX idx_profiles_season_points ON profiles(season_points DESC, username);
CREATE INDEX idx_profiles_vote_count ON profiles(vote_count DESC, created_at);
CREATE INDEX idx_profiles_is_deleted ON profiles(is_deleted);

-- archived_battles ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_archived_battles_winner ON archived_battles(winner_id);
CREATE INDEX idx_archived_battles_player1 ON archived_battles(player1_user_id);
CREATE INDEX idx_archived_battles_player2 ON archived_battles(player2_user_id);
CREATE INDEX idx_archived_battles_season ON archived_battles(season_id);

-- season_rankings ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE INDEX idx_season_rankings_season ON season_rankings(season_id, rank);
CREATE INDEX idx_season_rankings_user ON season_rankings(user_id);
```

### 10.2 ã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥

**ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: Zustand ã«ã‚ˆã‚‹ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ã‚­ãƒ£ãƒƒã‚·ãƒ¥
**ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: ãƒ“ãƒ¥ãƒ¼ã®ãƒãƒ†ãƒªã‚¢ãƒ©ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³æ¤œè¨
**æ›´æ–°é »åº¦**: ãƒãƒˆãƒ«çµæœãƒ»æŠ•ç¥¨æ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

---

## ä¿å®ˆãƒ»é‹ç”¨

### 11.1 ç›£è¦–é …ç›®

- **ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†å‡¦ç†**: pg_cron ã‚¸ãƒ§ãƒ–ã®å®Ÿè¡ŒçŠ¶æ³
- **ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°**: ãƒãƒˆãƒ«å¾Œã®ãƒã‚¤ãƒ³ãƒˆåæ˜ 
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¯ã‚¨ãƒªå®Ÿè¡Œæ™‚é–“ã®ç›£è¦–

### 11.2 å®šæœŸãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹

- **ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—**: ä¸æ­£ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã®å‰Šé™¤
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æœ€é©åŒ–**: å®šæœŸçš„ãªREINDEXå®Ÿè¡Œ
- **çµ±è¨ˆæƒ…å ±æ›´æ–°**: ANALYZE ã®å®šæœŸå®Ÿè¡Œ

### 11.3 ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©æ—§

- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—**: æ¯æ—¥ã®è‡ªå‹•ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- **ãƒã‚¤ãƒ³ãƒˆã‚¢ã‚¦ãƒˆå¾©æ—§**: é‡è¦ãƒ‡ãƒ¼ã‚¿ã®å®šæœŸã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
- **ç½å®³å¾©æ—§**: è¤‡æ•°ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿è­·

---

## å¤‰æ›´å±¥æ­´

### Version 1.0 (2025-07-20)
- **åˆç‰ˆä½œæˆ**: åŸºæœ¬ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®ä»•æ§˜ç­–å®š
- **ãƒãƒˆãƒ«çµŒé¨“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…**: 
  - å•é¡Œ: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1200ãƒã‚¤ãƒ³ãƒˆã®ãƒãƒˆãƒ«æœªçµŒé¨“è€…ãŒãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å¤§é‡è¡¨ç¤º
  - è§£æ±º: ãƒãƒˆãƒ«å‚åŠ å›æ•°ï¼ˆå‹æ•—æ•°åˆè¨ˆ >= 1ï¼‰ã«ã‚ˆã‚‹æ­£ç¢ºãªãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
- **æŠ•ç¥¨çµŒé¨“è€…ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°å®Ÿè£…**:
  - æŠ•ç¥¨æœªçµŒé¨“è€…ï¼ˆvote_count = 0ï¼‰ã‚’æŠ•ç¥¨è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‹ã‚‰é™¤å¤–
- **ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†å‡¦ç†ä¿®æ­£**:
  - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å¯¾è±¡ã‚’çµŒé¨“è€…ã®ã¿ã«é™å®š
  - ä¸æ­£ãƒ‡ãƒ¼ã‚¿ã®æ–°è¦ç”Ÿæˆã‚’é˜²æ­¢
- **ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ“ãƒ¥ãƒ¼ä¿®æ­£**:
  - `rankings_view`: ãƒãƒˆãƒ«çµŒé¨“è€…ã®ã¿è¡¨ç¤º
  - `voter_rankings_view`: æŠ•ç¥¨çµŒé¨“è€…ã®ã¿è¡¨ç¤º
  - `season_voter_rankings_view`: ã‚·ãƒ¼ã‚ºãƒ³æŠ•ç¥¨çµŒé¨“è€…ã®ã¿è¡¨ç¤º

### é©ç”¨ç’°å¢ƒ
- **é–‹ç™ºç’°å¢ƒ** (wdttluticnlqzmqmfvgt): âœ… é©ç”¨æ¸ˆã¿
- **æœ¬ç•ªç’°å¢ƒ** (qgqcjtjxaoplhxurbpis): âœ… é©ç”¨æ¸ˆã¿

### ä»Šå¾Œã®æ”¹å–„äºˆå®š
- æ—¢å­˜ä¸æ­£ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—æ¤œè¨
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°å¤‰å‹•å±¥æ­´ã®å¯è¦–åŒ–
- è©³ç´°çµ±è¨ˆæƒ…å ±ã®æä¾›
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°äºˆæ¸¬æ©Ÿèƒ½ã®è¿½åŠ 

---

**æ–‡æ›¸çµ‚äº†**

*ã“ã®ä»•æ§˜æ›¸ã¯ BeatNexus ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½ã®å®Œå…¨ãªæŠ€è¡“ä»•æ§˜ã‚’è¨˜éŒ²ã—ãŸã‚‚ã®ã§ã™ã€‚æ©Ÿèƒ½ã®è¿½åŠ ãƒ»å¤‰æ›´æ™‚ã¯æœ¬æ–‡æ›¸ã®æ›´æ–°ã‚’å¿…é ˆã¨ã—ã¾ã™ã€‚*
