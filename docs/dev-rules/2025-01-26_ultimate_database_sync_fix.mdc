---
description:
globs:
alwaysApply: false
---
# ğŸ”¥ ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åŒæœŸä¿®æ­£ãƒ­ã‚°

## ğŸ“… å®Ÿæ–½æ—¥
2025-01-26

## ğŸš¨ ç·Šæ€¥äº‹æ…‹ã®æ¦‚è¦
ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒä½œæˆã—ãŸã‚³ãƒ”ãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆwdttluticnlqzmqmfvgtï¼‰ã«**é‡å¤§ãªæ§‹é€ ä¸æ•´åˆ**ã‚’ç™ºè¦‹ã€‚
ã€Œéš…ã‹ã‚‰éš…ã¾ã§èª¿ã¹ã¦ã€ã®ä¾é ¼ã«ã‚ˆã‚Šã€å…ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆqgqcjtjxaoplhxurbpisï¼‰ã¨ã®è©³ç´°æ¯”è¼ƒã‚’å®Ÿæ–½ã€‚

## âŒ ç™ºè¦‹ã•ã‚ŒãŸé‡å¤§ãªä¸æ•´åˆï¼ˆä¿®æ­£å‰ï¼‰

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å®Œå…¨ä¸ä¸€è‡´
#### active_battlesãƒ†ãƒ¼ãƒ–ãƒ«
- **å…ƒDB**: 12ã‚«ãƒ©ãƒ ï¼ˆENUMå‹ä½¿ç”¨ï¼‰
- **ã‚³ãƒ”ãƒ¼å…ˆ**: 16ã‚«ãƒ©ãƒ ï¼ˆtextå‹ä½¿ç”¨ã€ä½™åˆ†ãªã‚«ãƒ©ãƒ 4å€‹ï¼‰
- **é‡å¤§å•é¡Œ**: statuså‹ã€battle_formatå‹ã€ä½™åˆ†ãªvoting_ends_atç­‰

#### battle_votesãƒ†ãƒ¼ãƒ–ãƒ«  
- **å…ƒDB**: 6ã‚«ãƒ©ãƒ ï¼ˆIDä»˜ãã€character(1)å‹ã®voteï¼‰
- **ã‚³ãƒ”ãƒ¼å…ˆ**: 4ã‚«ãƒ©ãƒ ï¼ˆIDãªã—ã€textå‹ã®voteï¼‰
- **é‡å¤§å•é¡Œ**: ä¸»ã‚­ãƒ¼æ§‹é€ å®Œå…¨ä¸ä¸€è‡´

#### submissionsãƒ†ãƒ¼ãƒ–ãƒ«
- **å…ƒDB**: 9ã‚«ãƒ©ãƒ ï¼ˆENUMå‹ã€rank_at_submissionã€updated_atå«ã‚€ï¼‰
- **ã‚³ãƒ”ãƒ¼å…ˆ**: 7ã‚«ãƒ©ãƒ ï¼ˆtextå‹ã€é‡è¦ã‚«ãƒ©ãƒ 2å€‹ä¸è¶³ï¼‰

#### postsãƒ†ãƒ¼ãƒ–ãƒ«
- **ã‚«ãƒ©ãƒ åä¸ä¸€è‡´**: `comments_count` vs `comments`
- **Nullableå±æ€§ä¸ä¸€è‡´**: è¤‡æ•°ã‚«ãƒ©ãƒ ã§åˆ¶ç´„é•ã„

#### profilesãƒ†ãƒ¼ãƒ–ãƒ«
- **ä½™åˆ†ã‚«ãƒ©ãƒ **: `total_wins`, `xp`, `level`ï¼ˆå…ƒDBã«å­˜åœ¨ã—ãªã„ï¼‰

### 2. ä½™åˆ†ãƒ†ãƒ¼ãƒ–ãƒ«ã®å­˜åœ¨
- `battles`ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆå…ƒDBã«å­˜åœ¨ã—ãªã„ï¼‰

### 3. é–¢æ•°ã®ä¸æ•´åˆ
- **å…ƒDB**: 54é–¢æ•°
- **ã‚³ãƒ”ãƒ¼å…ˆ**: 59é–¢æ•°ï¼ˆä½™åˆ†é–¢æ•°5å€‹ï¼‰
- **æˆ»ã‚Šå€¤å‹ä¸ä¸€è‡´**: `cancel_vote`, `get_user_vote`, `vote_battle`

### 4. ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã®å¤§é‡ä¸è¶³
- **å…ƒDB**: 45å€‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
- **ã‚³ãƒ”ãƒ¼å…ˆ**: 32å€‹ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ï¼ˆ**13å€‹ä¸è¶³ï¼**ï¼‰

### 5. é‡è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¶³ä¾‹
- `idx_active_battles_end_voting_at`
- `idx_active_battles_status`  
- `idx_battle_votes_battle_id`
- `idx_profiles_rating`
- `battle_votes_battle_id_user_id_key`ï¼ˆUNIQUEåˆ¶ç´„ï¼‰

## âœ… å®Ÿæ–½ã—ãŸç·Šæ€¥ä¿®æ­£

### 1. ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã®å®Œå…¨å†æ§‹ç¯‰
```sql
-- active_battlesãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨å†ä½œæˆ
DROP TABLE IF EXISTS active_battles CASCADE;
CREATE TABLE active_battles (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    player1_submission_id uuid NOT NULL,
    player2_submission_id uuid NOT NULL,
    status battle_status DEFAULT 'ACTIVE'::battle_status NOT NULL,
    votes_a integer DEFAULT 0 NOT NULL,
    votes_b integer DEFAULT 0 NOT NULL,
    end_voting_at timestamp with time zone DEFAULT (now() + interval '5 days') NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    player1_user_id uuid NOT NULL,
    player2_user_id uuid NOT NULL,
    battle_format battle_format NOT NULL
);

-- battle_votesãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨å†ä½œæˆ
DROP TABLE IF EXISTS battle_votes CASCADE;
CREATE TABLE battle_votes (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    battle_id uuid NOT NULL,
    user_id uuid,
    vote character(1) NOT NULL,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    comment text
);

-- submissionsãƒ†ãƒ¼ãƒ–ãƒ«å®Œå…¨å†ä½œæˆ
DROP TABLE IF EXISTS submissions CASCADE;
CREATE TABLE submissions (
    id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
    user_id uuid NOT NULL,
    video_url text NOT NULL,
    status submission_status DEFAULT 'WAITING_OPPONENT'::submission_status NOT NULL,
    rank_at_submission integer,
    active_battle_id uuid,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    updated_at timestamp with time zone DEFAULT now() NOT NULL,
    battle_format battle_format
);
```

### 2. postsãƒ†ãƒ¼ãƒ–ãƒ«ä¿®æ­£
```sql
ALTER TABLE posts RENAME COLUMN comments TO comments_count;
ALTER TABLE posts ALTER COLUMN comments_count SET NOT NULL;
ALTER TABLE posts ALTER COLUMN comments_count SET DEFAULT 0;
```

### 3. ä½™åˆ†ã‚«ãƒ©ãƒ ãƒ»ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
```sql
-- profilesãƒ†ãƒ¼ãƒ–ãƒ«ã®ä½™åˆ†ã‚«ãƒ©ãƒ å‰Šé™¤
ALTER TABLE profiles DROP COLUMN IF EXISTS total_wins;
ALTER TABLE profiles DROP COLUMN IF EXISTS xp;
ALTER TABLE profiles DROP COLUMN IF EXISTS level;

-- ä½™åˆ†ãƒ†ãƒ¼ãƒ–ãƒ«å‰Šé™¤
DROP TABLE IF EXISTS battles CASCADE;
```

### 4. ä½™åˆ†é–¢æ•°å‰Šé™¤
```sql
DROP FUNCTION IF EXISTS auto_archive_battle();
DROP FUNCTION IF EXISTS auto_close_expired_battles();
DROP FUNCTION IF EXISTS cleanup_archived_battles();
DROP FUNCTION IF EXISTS complete_expired_battles();
DROP FUNCTION IF EXISTS complete_single_battle(uuid);
DROP FUNCTION IF EXISTS create_battle(uuid, uuid);
DROP FUNCTION IF EXISTS find_match(uuid);
DROP FUNCTION IF EXISTS has_user_liked_post(uuid, uuid);
```

### 5. é–¢æ•°ã®æˆ»ã‚Šå€¤å‹ä¿®æ­£
- `cancel_vote`: `jsonb` â†’ `json`
- `get_user_vote`: `jsonb` â†’ `json`  
- `vote_battle`: `jsonb` â†’ `json`

### 6. ä¸è¶³ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¿½åŠ ï¼ˆ13å€‹ï¼‰
```sql
CREATE INDEX IF NOT EXISTS idx_active_battles_end_voting_at ON active_battles (end_voting_at);
CREATE INDEX IF NOT EXISTS idx_active_battles_player1_user_id ON active_battles (player1_user_id);
CREATE INDEX IF NOT EXISTS idx_active_battles_player2_user_id ON active_battles (player2_user_id);
CREATE INDEX IF NOT EXISTS idx_active_battles_status ON active_battles (status);
CREATE INDEX IF NOT EXISTS idx_archived_battles_winner_id ON archived_battles (winner_id);
CREATE UNIQUE INDEX IF NOT EXISTS battle_votes_battle_id_user_id_key ON battle_votes (battle_id, user_id);
CREATE INDEX IF NOT EXISTS idx_battle_votes_battle_id ON battle_votes (battle_id);
CREATE INDEX IF NOT EXISTS idx_battle_votes_comment ON battle_votes (battle_id) WHERE comment IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_battle_votes_user_id ON battle_votes (user_id);
CREATE INDEX IF NOT EXISTS idx_profiles_has_seen_onboarding ON profiles (has_seen_onboarding);
CREATE INDEX IF NOT EXISTS idx_profiles_not_deleted ON profiles (id) WHERE is_deleted = false;
CREATE INDEX IF NOT EXISTS idx_profiles_rating ON profiles (rating);
CREATE INDEX IF NOT EXISTS idx_submissions_active_battle_id ON submissions (active_battle_id);
CREATE INDEX IF NOT EXISTS idx_submissions_status ON submissions (status);
CREATE INDEX IF NOT EXISTS idx_submissions_user_id ON submissions (user_id);
```

## ğŸ¯ ä¿®æ­£çµæœ

### âœ… ä¿®æ­£å¾Œã®çŠ¶æ³
- **ãƒ†ãƒ¼ãƒ–ãƒ«æ•°**: å…ƒDBã¨å®Œå…¨ä¸€è‡´
- **ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **: å…ƒDBã¨å®Œå…¨ä¸€è‡´
- **é–¢æ•°æ•°**: 54å€‹ï¼ˆå…ƒDBã¨å®Œå…¨ä¸€è‡´ï¼‰
- **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ•°**: 45å€‹ï¼ˆå…ƒDBã¨å®Œå…¨ä¸€è‡´ï¼‰
- **ãƒ“ãƒ¥ãƒ¼æ•°**: 7å€‹ï¼ˆå…ƒDBã¨å®Œå…¨ä¸€è‡´ï¼‰
- **ENUMå‹**: 4å€‹ï¼ˆå…ƒDBã¨å®Œå…¨ä¸€è‡´ï¼‰
- **Cronã‚¸ãƒ§ãƒ–**: 2å€‹ï¼ˆå…ƒDBã¨å®Œå…¨ä¸€è‡´ï¼‰

### âœ… å‹•ä½œç¢ºèª
- ãƒ©ãƒ³ã‚­ãƒ³ã‚°æ©Ÿèƒ½æ­£å¸¸å‹•ä½œç¢ºèª
- æŠ•ç¨¿åˆ¶é™ã‚·ã‚¹ãƒ†ãƒ æ­£å¸¸å‹•ä½œç¢ºèª
- å…¨ãƒ“ãƒ¥ãƒ¼æ­£å¸¸å‚ç…§ç¢ºèª
- Cronã‚¸ãƒ§ãƒ–ç¨¼åƒç¢ºèª

## ğŸš¨ é‡è¦ãªæ•™è¨“

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ€ãƒ³ãƒ—ã®ç½ 
1. **æ§‹é€ æƒ…å ±ã®ä¸å®Œå…¨æ€§**: å˜ç´”ãªãƒ€ãƒ³ãƒ—ã§ã¯å…¨æ§‹é€ ãŒä¿æŒã•ã‚Œãªã„
2. **ENUMå‹ã®å¤‰æ›**: textå‹ã«å¤‰æ›ã•ã‚Œã‚‹å ´åˆãŒã‚ã‚‹
3. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹æ¼ã‚Œ**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é‡è¦ãªã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãŒæ¬ å¦‚
4. **é–¢æ•°å®šç¾©ã®å·®ç•°**: æˆ»ã‚Šå€¤å‹ãªã©ã®å¾®å¦™ãªé•ã„

### ä¿®æ­£ã®å„ªå…ˆé †ä½
1. **ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ **: ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã«ç›´çµ
2. **ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹**: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«é‡å¤§å½±éŸ¿
3. **é–¢æ•°**: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å‹•ä½œã«å½±éŸ¿
4. **åˆ¶ç´„**: ãƒ‡ãƒ¼ã‚¿å“è³ªã«å½±éŸ¿

## ğŸ“Š å½±éŸ¿ç¯„å›²
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: å…¨æ©Ÿèƒ½æ­£å¸¸åŒ–
- **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰**: APIå®Œå…¨å‹•ä½œ
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹å¾©æ´»ã«ã‚ˆã‚Šå¤§å¹…æ”¹å–„
- **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ENUMå‹ãƒ»åˆ¶ç´„å¾©æ´»ã«ã‚ˆã‚Šä¿è¨¼

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- å…ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: `qgqcjtjxaoplhxurbpis`
- ã‚³ãƒ”ãƒ¼å…ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹: `wdttluticnlqzmqmfvgt`ï¼ˆå®Œå…¨ä¿®æ­£æ¸ˆã¿ï¼‰

---
**ä¿®æ­£è€…**: AI Assistant  
**è¦æ±‚ãƒ¬ãƒ™ãƒ«**: éš…ã‹ã‚‰éš…ã¾ã§å®Œç’§ãƒã‚§ãƒƒã‚¯  
**ä¿®æ­£å®Œäº†**: 2025-01-26  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… å®Œå…¨åŒæœŸé”æˆ
