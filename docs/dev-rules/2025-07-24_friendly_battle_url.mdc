# ãƒãƒˆãƒ«è¦–è´ãƒšãƒ¼ã‚¸ã®ãƒ•ãƒ¬ãƒ³ãƒ‰ãƒªãƒ¼URLå®Ÿè£…ä»•æ§˜æ›¸

## æ¦‚è¦

ãƒãƒˆãƒ«è¦–è´ãƒšãƒ¼ã‚¸ã®URLã‚’ç¾åœ¨ã® `/battle/:id` ã‹ã‚‰ `PlayerA-vs-PlayerB-battleID` å½¢å¼ã®SEO friendlyãªURLã«å¤‰æ›´ã™ã‚‹æ©Ÿèƒ½ã‚’å®Ÿè£…ã—ã¾ã™ã€‚

## èƒŒæ™¯ãƒ»ç›®çš„

- **SEOæ”¹å–„**: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‚’å«ã‚€URLã§ã‚ˆã‚Šã‚ã‹ã‚Šã‚„ã™ã
- **ã‚·ã‚§ã‚¢åŠ¹æœå‘ä¸Š**: URLã‹ã‚‰ãƒãƒˆãƒ«å†…å®¹ãŒæ¨æ¸¬ã§ãã‚‹
- **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Š**: ç›´æ„Ÿçš„ã§è¦šãˆã‚„ã™ã„URL

## ç¾åœ¨ã®æ§‹é€ 

```
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒˆãƒ«: /battle/:battleId
ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒˆãƒ«: /battle-replay/:battleId
```

## æ–°ã—ã„URLå½¢å¼

```
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒˆãƒ«: /battle/PlayerA-vs-PlayerB-battleId
ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒˆãƒ«: /battle-replay/PlayerA-vs-PlayerB-battleId
```

### URLç”Ÿæˆãƒ«ãƒ¼ãƒ«

1. **åŸºæœ¬å½¢å¼**: `{playerA}-vs-{playerB}-{battleId}`
2. **ãƒ¦ãƒ¼ã‚¶ãƒ¼åã®æ­£è¦åŒ–**:
   - è‹±æ•°å­—ã®ã¿è¨±å¯ï¼ˆæ—¥æœ¬èªãƒ»è¨˜å·ã¯å‰Šé™¤ï¼‰
   - å¤§æ–‡å­—å°æ–‡å­—ã¯å°æ–‡å­—ã«çµ±ä¸€
   - é€£ç¶šã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã¯1ã¤ã«çµ±åˆ
   - å‰å¾Œã®ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
   - ç©ºæ–‡å­—ã®å ´åˆã¯ "player" ã«ç½®æ›
3. **æœ€å¤§é•·åˆ¶é™**: å„ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã¯20æ–‡å­—ã¾ã§
4. **é‡è¤‡å›é¿**: battleIdã‚’æœ«å°¾ã«å¿…ãšå«ã‚ã‚‹ã“ã¨ã§ä¸€æ„æ€§ã‚’ä¿è¨¼

### URLç”Ÿæˆä¾‹

```typescript
// é€šå¸¸ã‚±ãƒ¼ã‚¹
generateBattleUrl("TakumiBeats", "RyujiFlow", "abc123")
// â†’ "takumibeats-vs-ryujiflow-abc123"

// ç‰¹æ®Šæ–‡å­—å«ã‚€
generateBattleUrl("TakumiğŸµBeats", "Ryuji-Flow_2024", "abc123")  
// â†’ "takumibeats-vs-ryujiflow-abc123"

// æ—¥æœ¬èªãƒ¦ãƒ¼ã‚¶ãƒ¼å
generateBattleUrl("ç”°ä¸­å¤ªéƒ", "å±±ç”°èŠ±å­", "abc123")
// â†’ "player-vs-player-abc123"

// é•·ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å
generateBattleUrl("VeryLongUserNameThatExceedsLimit", "Short", "abc123")
// â†’ "verylongusernameth-vs-short-abc123"
```

## æŠ€è¡“å®Ÿè£…

### 1. URLç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

```typescript
// src/utils/battleUrl.ts

/**
 * ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’URLå®‰å…¨ãªå½¢å¼ã«æ­£è¦åŒ–
 */
export function sanitizeUsername(username: string | null | undefined): string {
  if (!username) return 'player';
  
  return username
    .toLowerCase()
    .replace(/[^a-z0-9-]/g, '') // è‹±æ•°å­—ã¨ãƒã‚¤ãƒ•ãƒ³ã®ã¿è¨±å¯
    .replace(/-+/g, '-') // é€£ç¶šã™ã‚‹ãƒã‚¤ãƒ•ãƒ³ã‚’1ã¤ã«
    .replace(/^-|-$/g, '') // å‰å¾Œã®ãƒã‚¤ãƒ•ãƒ³ã‚’å‰Šé™¤
    .substring(0, 20) // æœ€å¤§20æ–‡å­—
    .replace(/^$/, 'player'); // ç©ºæ–‡å­—ã®å ´åˆã¯playerã«
}

/**
 * ãƒãƒˆãƒ«URLã‚’ç”Ÿæˆ
 */
export function generateBattleUrl(
  playerA: string | null | undefined,
  playerB: string | null | undefined, 
  battleId: string
): string {
  const sanitizedA = sanitizeUsername(playerA);
  const sanitizedB = sanitizeUsername(playerB);
  return `${sanitizedA}-vs-${sanitizedB}-${battleId}`;
}

/**
 * ãƒãƒˆãƒ«URLã‹ã‚‰ãƒãƒˆãƒ«IDã‚’æŠ½å‡º
 */
export function extractBattleIdFromUrl(battlePath: string): string | null {
  const match = battlePath.match(/-([a-f0-9-]{36})$/);
  return match ? match[1] : null;
}

/**
 * æ—¢å­˜ã®UUIDå½¢å¼ã‹åˆ¤å®š
 */
export function isLegacyBattleUrl(battlePath: string): boolean {
  const uuidRegex = /^[a-f0-9-]{36}$/;
  return uuidRegex.test(battlePath);
}
```

### 2. æ–°ã—ã„ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

```typescript
// src/App.tsx - Routesè¿½åŠ 
<Route path="/battle/:battlePath" element={<BattleViewPage />} />
<Route path="/battle-replay/:battlePath" element={<BattleReplayPage />} />
```

### 3. ãƒãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿å–å¾—ã®æ”¹è‰¯

```typescript
// src/pages/BattleViewPage.tsx
const BattleViewPage: React.FC = () => {
  const { battlePath } = useParams<{ battlePath: string }>();
  
  const battleId = useMemo(() => {
    if (!battlePath) return null;
    
    // æ—¢å­˜ã®UUIDå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾ä½¿ç”¨
    if (isLegacyBattleUrl(battlePath)) {
      return battlePath;
    }
    
    // æ–°å½¢å¼ã‹ã‚‰ãƒãƒˆãƒ«IDã‚’æŠ½å‡º
    return extractBattleIdFromUrl(battlePath);
  }, [battlePath]);
  
  // ä»¥ä¸‹æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
};
```

### 4. OGP Edge Function ã®æ›´æ–°

```typescript
// supabase/functions/ogp-page/index.ts
serve(async (req) => {
  const { searchParams } = new URL(req.url);
  let battleId = searchParams.get("battle_id");
  
  // æ–°å½¢å¼ã®URLã®å ´åˆã€ãƒãƒˆãƒ«IDã‚’æŠ½å‡º
  if (battleId && !isLegacyBattleUrl(battleId)) {
    battleId = extractBattleIdFromUrl(battleId);
  }
  
  if (!battleId) return new Response("battle_id query param required", { status: 400 });
  
  // æ—¢å­˜ã®ãƒ­ã‚¸ãƒƒã‚¯
});
```

### 5. ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ãƒ»ã‚·ã‚§ã‚¢æ©Ÿèƒ½ã®æ›´æ–°

```typescript
// src/components/battle/BattleCard.tsx
const BattleCard: React.FC<{ battle: Battle }> = ({ battle }) => {
  const battleUrl = useMemo(() => {
    return generateBattleUrl(
      battle.contestant_a?.username,
      battle.contestant_b?.username,
      battle.id
    );
  }, [battle]);
  
  return (
    <Link to={`/battle/${battleUrl}`}>
      {/* ã‚«ãƒ¼ãƒ‰å†…å®¹ */}
    </Link>
  );
};
```

## äº’æ›æ€§ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

### æ—¢å­˜URLã®ã‚µãƒãƒ¼ãƒˆ

- æ—¢å­˜ã® `/battle/:uuid` å½¢å¼ã®URLã¯å¼•ãç¶šãã‚µãƒãƒ¼ãƒˆ
- `isLegacyBattleUrl()` é–¢æ•°ã§å½¢å¼ã‚’åˆ¤å®šã—ã€é©åˆ‡ã«å‡¦ç†
- æ–°è¦ç”Ÿæˆã•ã‚Œã‚‹URLã¯å…¨ã¦æ–°å½¢å¼ã‚’ä½¿ç”¨

### ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæˆ¦ç•¥

1. **Edge Function ãƒ¬ãƒ™ãƒ«**: OGPç”Ÿæˆæ™‚ã«æ–°æ—§ä¸¡å½¢å¼ã«å¯¾å¿œ
2. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ ãƒ¬ãƒ™ãƒ«**: ãƒ¬ã‚¬ã‚·ãƒ¼URLã‚‚æ­£å¸¸ã«å‹•ä½œ
3. **å°†æ¥çš„**: ãƒ¬ã‚¬ã‚·ãƒ¼URLã‚¢ã‚¯ã‚»ã‚¹æ™‚ã«æ–°URLã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’æ¤œè¨

## ãƒ†ã‚¹ãƒˆè¨ˆç”»

### å˜ä½“ãƒ†ã‚¹ãƒˆ

1. `sanitizeUsername()` ã®å„ç¨®å…¥åŠ›ãƒ‘ã‚¿ãƒ¼ãƒ³
2. `generateBattleUrl()` ã®çµ„ã¿åˆã‚ã›ãƒ†ã‚¹ãƒˆ
3. `extractBattleIdFromUrl()` ã®æŠ½å‡ºç²¾åº¦
4. `isLegacyBattleUrl()` ã®åˆ¤å®šç²¾åº¦

### çµ±åˆãƒ†ã‚¹ãƒˆ

1. æ–°å½¢å¼URLã§ã®ãƒãƒˆãƒ«è¡¨ç¤º
2. æ—¢å­˜å½¢å¼URLã§ã®å¾Œæ–¹äº’æ›æ€§
3. OGPç”Ÿæˆã®å‹•ä½œç¢ºèª
4. ã‚·ã‚§ã‚¢æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª

### ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ

1. ç‰¹æ®Šæ–‡å­—ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼å
2. éå¸¸ã«é•·ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼å
3. ç©ºãƒ»nullãƒ»undefinedã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å
4. åŒä¸€ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åŒå£«ã®ãƒãƒˆãƒ«
5. å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒãƒˆãƒ«

## å®Ÿè£…å„ªå…ˆåº¦

1. **Phase 1**: URLç”Ÿæˆãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®å®Ÿè£…ã¨ãƒ†ã‚¹ãƒˆ
2. **Phase 2**: ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®æ›´æ–°
3. **Phase 3**: ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ãƒ»ãƒªãƒ³ã‚¯ç”Ÿæˆã®æ›´æ–°
4. **Phase 4**: OGP Edge Function ã®æ›´æ–°
5. **Phase 5**: çµ±åˆãƒ†ã‚¹ãƒˆã¨æœ€çµ‚èª¿æ•´

## æ³¨æ„äº‹é …

- ãƒ¦ãƒ¼ã‚¶ãƒ¼åå¤‰æ›´æ™‚ã®æ—§URLã®å‹•ä½œï¼ˆæ—§URLã§ã‚‚ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªè¨­è¨ˆï¼‰
- ç‰¹æ®Šæ–‡å­—ãƒ»çµµæ–‡å­—ã‚’å«ã‚€ãƒ¦ãƒ¼ã‚¶ãƒ¼åã¸ã®å¯¾å¿œ
- ãƒãƒˆãƒ«IDéƒ¨åˆ†ã¯å¿…ãšUUIDã‚’ä¿æŒã—ä¸€æ„æ€§ã‚’ç¢ºä¿
- æ—¢å­˜ã®ã‚·ã‚§ã‚¢æ©Ÿèƒ½ãƒ»ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯ç­‰ã¸ã®å½±éŸ¿ã‚’æœ€å°åŒ–

---

**å®Ÿè£…æ—¥**: 2025-07-24  
**æ‹…å½“è€…**: ã‚·ã‚¹ãƒ†ãƒ é–‹ç™ºãƒãƒ¼ãƒ   
**é–¢é€£æ©Ÿèƒ½**: ãƒãƒˆãƒ«è¦–è´ã€OGPç”Ÿæˆã€URLç”Ÿæˆã€ã‚·ã‚§ã‚¢æ©Ÿèƒ½
