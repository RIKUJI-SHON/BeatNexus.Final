# ğŸŒŸ BeatNexus OGP ãƒ¡ã‚¿ã‚¿ã‚° & PNG ç”»åƒå‹•çš„ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…ãƒ­ã‚°

## ğŸ“… å®Ÿè£…æ—¥
2025-07-05

## ğŸ¯ æ¦‚è¦
BeatNexusã®ãƒãƒˆãƒ«ãƒšãƒ¼ã‚¸ç”¨OGPç”»åƒã‚’å‹•çš„ç”Ÿæˆã—ã€SNSï¼ˆTwitter/Xç­‰ï¼‰ã§ã‚«ãƒ¼ãƒ‰ç”»åƒãŒæ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã€‚
SPAç‰¹æœ‰ã®meta ã‚¿ã‚°å•é¡Œã‚’è§£æ±ºã—ã€resvg_wasm ã«ã‚ˆã‚‹é«˜å“è³ªPNGç”»åƒç”Ÿæˆã‚’å®Ÿç¾ã€‚

## ğŸ” è§£æ±ºã—ãŸèª²é¡Œ
### 1. Twitter ãŒSVGç”»åƒéå¯¾å¿œ
- **å•é¡Œ**: Twitter ã¯SVGã‚’ç”»åƒã¨ã—ã¦èªè­˜ã—ãªã„
- **è§£æ±º**: resvg_wasm ã§SVGâ†’PNGå¤‰æ›ã‚’å®Ÿè£…

### 2. SPAï¼ˆReactï¼‰ã®meta ã‚¿ã‚°åˆ¶é™
- **å•é¡Œ**: ã‚¯ãƒ­ãƒ¼ãƒ©ã¯JavaScriptå®Ÿè¡Œå¾Œã®meta ã‚¿ã‚°ã‚’èª­ã‚ãªã„
- **è§£æ±º**: OGPå°‚ç”¨HTMLãƒšãƒ¼ã‚¸ã‚’Edge Functionã§ç”Ÿæˆ

### 3. Edge Function ã®JWTèªè¨¼å•é¡Œ
- **å•é¡Œ**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®JWTæ¤œè¨¼ã§ã‚¯ãƒ­ãƒ¼ãƒ©ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
- **è§£æ±º**: `--no-verify-jwt` ãƒ•ãƒ©ã‚°ã§å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯

## ğŸ“ å®Ÿè£…å†…å®¹

### âœ… Edge Function: `ogp-battle-card` (PNGç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³)
**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/ogp-battle-card/index.ts`

#### ä¸»è¦æ©Ÿèƒ½
- **å‹•çš„ã‚¢ãƒã‚¿ãƒ¼å–å¾—**: active_battles/archived_battles ã‹ã‚‰ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±å–å¾—
- **SVGç”»åƒç”Ÿæˆ**: 1200x630ã®ãƒãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’SVGã§çµ„ã¿ç«‹ã¦
- **PNGå¤‰æ›**: resvg_wasm ã§é«˜å“è³ªPNGå‡ºåŠ›
- **ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¯¾å¿œ**: `?format=png` ã¾ãŸã¯ `?format=svg` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

#### resvg_wasm çµ±åˆ
```typescript
// resvg_runtime.js - å‹•çš„import ã§ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«è§£æ±º
let mod;
export async function render(svg, options = {}) {
  if (!mod) {
    mod = await import("https://deno.land/x/resvg_wasm@0.10.0/mod.ts");
  }
  return mod.render(svg, options);
}
```

#### è¨­å®š
```toml
[functions.ogp-battle-card]
verify_jwt = false
static_files = ["./supabase/functions/ogp-battle-card/*.wasm"]
```

### âœ… Edge Function: `ogp-page` (ãƒ¡ã‚¿ã‚¿ã‚° + ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ)
**ãƒ•ã‚¡ã‚¤ãƒ«**: `supabase/functions/ogp-page/index.ts`

#### ä¸»è¦æ©Ÿèƒ½
- **ãƒ¡ã‚¿ã‚¿ã‚°HTMLç”Ÿæˆ**: battle_id ãƒ™ãƒ¼ã‚¹ã®OGP meta ã‚¿ã‚°ä»˜ãHTMLè¿”å´
- **PNG ãƒ—ãƒ­ã‚­ã‚·**: `?image=1` æ™‚ã¯ ogp-battle-card ã¸ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·
- **è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: HTMLå†…ã§å³åº§ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

#### ç”Ÿæˆã•ã‚Œã‚‹meta ã‚¿ã‚°
```html
<meta property="og:title" content="BeatNexus Battle" />
<meta property="og:description" content="ã‚ãªãŸã®ä¸€ç¥¨ã§å‹æ•—ãŒæ±ºã¾ã‚Šã¾ã™ï¼BeatNexusã§æŠ•ç¥¨ã—ã‚ˆã†ã€‚" />
<meta property="og:image" content="${SUPABASE_URL}/functions/v1/ogp-battle-card?battle_id=${battleId}" />
<meta property="og:url" content="${SITE_BASE_URL}/battle/${battleId}" />
<meta name="twitter:card" content="summary_large_image" />
```

#### ãƒ—ãƒ­ã‚­ã‚·å®Ÿè£…ï¼ˆresvg_wasm ã‚¨ãƒ©ãƒ¼å›é¿ï¼‰
```typescript
if (imageOnly) {
  // æ—¢å­˜ã®PNGç”ŸæˆEdge Functionã‚’å‘¼ã³å‡ºã—ã¦ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·
  const pngUrl = `${SUPABASE_URL}/functions/v1/ogp-battle-card?battle_id=${battleId}&format=png`;
  const upstream = await fetch(pngUrl);
  const body = new Uint8Array(await upstream.arrayBuffer());
  return new Response(body, { headers: { "Content-Type": "image/png" } });
}
```

### âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/components/battle/BattleView.tsx`, `src/pages/BattleViewPage.tsx` ç­‰

#### React Helmet ã§ã®é™çš„meta ã‚¿ã‚°
```tsx
<Helmet>
  <meta property="og:image" content={`${VITE_SUPABASE_URL}/functions/v1/ogp-battle-card?battle_id=${battle.id}`} />
  <meta property="og:url" content={`${window.location.origin}/battle/${battle.id}`} />
  <meta name="twitter:card" content="summary_large_image" />
</Helmet>
```

#### å…±æœ‰ãƒœã‚¿ãƒ³ã®URLå¤‰æ›´
```typescript
// OGPå°‚ç”¨ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯ã«å¤‰æ›´
const shareUrl = `${VITE_SUPABASE_URL}/functions/v1/ogp-page?battle_id=${battleId}`;
```

## ğŸ”§ æŠ€è¡“è©³ç´°

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼
```
1. SNSã‚¯ãƒ­ãƒ¼ãƒ© â†’ ogp-page?battle_id=xxx
2. ogp-page â†’ meta ã‚¿ã‚°ä»˜ãHTMLè¿”å´
3. ã‚¯ãƒ­ãƒ¼ãƒ© â†’ og:image URL (ogp-battle-card) ã‚¢ã‚¯ã‚»ã‚¹
4. ogp-battle-card â†’ DBæ¤œç´¢ â†’ ã‚¢ãƒã‚¿ãƒ¼å–å¾— â†’ SVGç”Ÿæˆ â†’ PNGå¤‰æ›
5. ã‚¯ãƒ­ãƒ¼ãƒ© â†’ ç”»åƒä»˜ãã‚«ãƒ¼ãƒ‰è¡¨ç¤º
```

### ãƒ‡ãƒ—ãƒ­ã‚¤ã‚³ãƒãƒ³ãƒ‰
```bash
# JWTæ¤œè¨¼ç„¡åŠ¹åŒ–ãŒå¿…é ˆ
npx supabase@latest functions deploy ogp-battle-card --project-ref qgqcjtjxaoplhxurbpis --no-verify-jwt
npx supabase@latest functions deploy ogp-page --project-ref qgqcjtjxaoplhxurbpis --no-verify-jwt
```

### ãƒãƒˆãƒ«IDæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯
```typescript
// active_battles â†’ archived_battles.original_battle_id â†’ archived_battles.id ã®é †ã§æ¤œç´¢
let { data } = await admin.from("active_battles").select("player1_user_id, player2_user_id").eq("id", battleId).maybeSingle();
if (!data) {
  let res = await admin.from("archived_battles").select("player1_user_id, player2_user_id").eq("original_battle_id", battleId).maybeSingle();
  data = res.data;
  if (!data) {
    res = await admin.from("archived_battles").select("player1_user_id, player2_user_id").eq("id", battleId).maybeSingle();
    data = res.data;
  }
}
```

## ğŸ¯ è§£æ±ºã•ã‚ŒãŸå•é¡Œ

### resvg_wasm ã®å‹•çš„import ã‚¨ãƒ©ãƒ¼
- **å•é¡Œ**: Edge Runtime ã§ `await import()` æ™‚ã«ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æœªæ¤œå‡ºã‚¨ãƒ©ãƒ¼
- **è§£æ±º**: ogp-page ã§ã¯ç‹¬è‡ªPNGç”Ÿæˆã›ãšã€ogp-battle-card ã¸ã®ãƒ—ãƒ­ã‚­ã‚·æ–¹å¼ã‚’æ¡ç”¨
- **ãƒ¡ãƒªãƒƒãƒˆ**: ã‚³ãƒ¼ãƒ‰é‡è¤‡ãªã—ã€æ—¢å­˜ã®å‹•ä½œç¢ºèªæ¸ˆã¿æ©Ÿèƒ½ã‚’å†åˆ©ç”¨

### JWTèªè¨¼ã®å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹å•é¡Œ
- **å•é¡Œ**: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§JWTæ¤œè¨¼æœ‰åŠ¹â†’ã‚¯ãƒ­ãƒ¼ãƒ©ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯
- **è§£æ±º**: `--no-verify-jwt` ãƒ•ãƒ©ã‚°ã§ãƒ‡ãƒ—ãƒ­ã‚¤ã€config.tomlè¨­å®šã‚‚ä½µç”¨

### ãƒãƒˆãƒ«ID ã®è¤‡æ•°ãƒ†ãƒ¼ãƒ–ãƒ«æ¤œç´¢
- **å•é¡Œ**: active_battles, archived_battles ã®ä¸¡æ–¹ã§IDãŒå­˜åœ¨
- **è§£æ±º**: æ®µéšçš„æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã§å…¨ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚«ãƒãƒ¼

## ğŸ“Š æ¤œè¨¼çµæœ

### Twitter Card Validator çµæœ âœ…
```
INFO:  Page fetched successfully
INFO:  8 metatags were found  
INFO:  twitter:card = summary_large_image tag found
INFO:  Card loaded successfully
```

### å¯¾å¿œURLå½¢å¼
- **OGP HTML**: `https://qgqcjtjxaoplhxurbpis.supabase.co/functions/v1/ogp-page?battle_id=xxx`
- **ç›´æ¥PNG**: `https://qgqcjtjxaoplhxurbpis.supabase.co/functions/v1/ogp-page?battle_id=xxx&image=1`
- **å¾“æ¥PNG**: `https://qgqcjtjxaoplhxurbpis.supabase.co/functions/v1/ogp-battle-card?battle_id=xxx&format=png`

## ğŸš€ ä»Šå¾Œã®é‹ç”¨

### SNSå…±æœ‰ã§ã®åˆ©ç”¨
- **æŠ•ç¨¿æ™‚**: OGPå°‚ç”¨URLï¼ˆ`ogp-page?battle_id=xxx`ï¼‰ã‚’ã‚·ã‚§ã‚¢
- **ç”»åƒè¡¨ç¤º**: è‡ªå‹•çš„ã«ãƒãƒˆãƒ«å‚åŠ è€…ã®ã‚¢ãƒã‚¿ãƒ¼ä»˜ãã‚«ãƒ¼ãƒ‰ãŒè¡¨ç¤º
- **ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ**: ã‚¯ãƒªãƒƒã‚¯æ™‚ã¯è‡ªå‹•çš„ã«ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å®Ÿéš›ã®ãƒãƒˆãƒ«ãƒšãƒ¼ã‚¸ã¸

### ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹
- **ã‚¢ãƒã‚¿ãƒ¼æ›´æ–°**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§DBå‚ç…§ã€ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—
- **ãƒ‡ã‚¶ã‚¤ãƒ³å¤‰æ›´**: `buildSvg()` é–¢æ•°ã®ä¿®æ­£ã®ã¿
- **æ–°ãƒãƒˆãƒ«å½¢å¼**: æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯ã§è‡ªå‹•å¯¾å¿œ

## âœ… æ¤œè¨¼é …ç›®
- [x] PNGç”»åƒã®å‹•çš„ç”Ÿæˆï¼ˆresvg_wasmï¼‰
- [x] Twitter Card Validator ã§ã®ç”»åƒè¡¨ç¤ºç¢ºèª  
- [x] OGP meta ã‚¿ã‚°ã®æ­£å¸¸æ¤œå‡º
- [x] active_battles / archived_battles ä¸¡å¯¾å¿œ
- [x] JWTèªè¨¼ç„¡åŠ¹åŒ–ã«ã‚ˆã‚‹å…¬é–‹ã‚¢ã‚¯ã‚»ã‚¹
- [x] ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å…±æœ‰ãƒœã‚¿ãƒ³ã®çµ±åˆ
- [x] è‡ªå‹•ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆæ©Ÿèƒ½

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `supabase/functions/ogp-battle-card/index.ts` - PNGç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³
- `supabase/functions/ogp-battle-card/resvg_runtime.js` - resvg_wasm ãƒ©ãƒƒãƒ‘
- `supabase/functions/ogp-page/index.ts` - OGPå°‚ç”¨ãƒšãƒ¼ã‚¸ç”Ÿæˆ
- `supabase/config.toml` - Edge Functionè¨­å®š
- `src/pages/BattleViewPage.tsx` - React Helmetçµ±åˆ
- `src/components/battle/BattleView.tsx` - å…±æœ‰ãƒœã‚¿ãƒ³çµ±åˆ

---
**å®Ÿè£…è€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: å®Œäº†  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: âœ… **æœ¬ç•ªé‹ç”¨é–‹å§‹** - Twitter Card Validator ã§å‹•ä½œç¢ºèªæ¸ˆã¿

**ğŸµ BeatNexus ã®ãƒãƒˆãƒ«ãŒSNSã§ç¾ã—ãå…±æœ‰ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸï¼ ğŸµ**
description:
globs:
alwaysApply: false
---
