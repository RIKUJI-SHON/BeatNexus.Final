---
description: 
globs: 
alwaysApply: false
---
# ğŸš€ AWS S3 + CloudFront å‹•ç”»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ç§»è¡Œè¨ˆç”»æ›¸

## ğŸ“… ä½œæˆæ—¥
2025-01-20

## ğŸ¯ æ¦‚è¦
BeatNexusãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®å‹•ç”»ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’Supabaseã‹ã‚‰**AWS S3 + CloudFront**ã«ç§»è¡Œã—ã€ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªé«˜é€Ÿé…ä¿¡ã¨ã‚³ã‚¹ãƒˆæœ€é©åŒ–ã‚’å®Ÿç¾ã™ã‚‹åŒ…æ‹¬çš„ãªç§»è¡Œè¨ˆç”»ã€‚

## ğŸ” ç¾åœ¨ã®å®Ÿè£…åˆ†æ

### ğŸ“ ç¾åœ¨ã®Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸å®Ÿè£…
```typescript
// ç¾åœ¨ã®å‹•ç”»ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (PostPage.tsx)
const { error: uploadError } = await supabase.storage
  .from('videos')
  .upload(filePath, videoFile);

const { data: { publicUrl } } = supabase.storage
  .from('videos')
  .getPublicUrl(filePath);
```

### ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã®å‹•ç”»URLä¿å­˜ç®‡æ‰€
1. **submissions.video_url** - æŠ•ç¨¿å‹•ç”»URL
2. **archived_battles.player1_video_url** - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒˆãƒ«å‹•ç”»URL (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1)
3. **archived_battles.player2_video_url** - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒˆãƒ«å‹•ç”»URL (ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2)

### ğŸ”§ ç¾åœ¨ã®å‰Šé™¤ã‚·ã‚¹ãƒ†ãƒ 
```sql
-- delete_user_videos_from_storageé–¢æ•°ã§Supabaseã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ç‰©ç†å‰Šé™¤
DELETE FROM storage.objects 
WHERE bucket_id = 'videos' 
  AND name = replace(v_storage_path, 'videos/', '');
```

## ğŸ“‹ ç§»è¡Œè¨ˆç”»

### ğŸš€ **Phase 1: AWSåŸºç›¤æ§‹ç¯‰** (å®Ÿè£…æœŸé–“: 2-3æ—¥)

#### 1.1 AWS S3è¨­å®š
```bash
# AWS CLIã§ãƒã‚±ãƒƒãƒˆä½œæˆ
aws s3 mb s3://beatnexus-videos --region us-east-1

# CORSè¨­å®š
aws s3api put-bucket-cors \
  --bucket beatnexus-videos \
  --cors-configuration file://cors-config.json
```

**cors-config.json:**
```json
{
  "CORSRules": [
    {
      "AllowedOrigins": ["*"],
      "AllowedHeaders": ["*"],
      "AllowedMethods": ["PUT", "POST", "DELETE", "GET"],
      "MaxAgeSeconds": 3000,
      "ExposeHeaders": [
        "x-amz-server-side-encryption",
        "x-amz-request-id",
        "x-amz-id-2"
      ]
    }
  ]
}
```

#### 1.2 CloudFront Distributionä½œæˆ
```typescript
// AWS CDKã§ã®CloudFrontè¨­å®šä¾‹
const distribution = new cloudfront.Distribution(this, 'VideoDistribution', {
  defaultBehavior: {
    origin: new origins.S3Origin(bucket),
    viewerProtocolPolicy: cloudfront.ViewerProtocolPolicy.REDIRECT_TO_HTTPS,
    compress: true,
    cachePolicyId: cloudfront.CachePolicyId.CACHING_OPTIMIZED,
  },
  priceClass: cloudfront.PriceClass.PRICE_CLASS_100,
  geoRestriction: cloudfront.GeoRestriction.allowlist('US', 'JP', 'CN', 'IN', 'BR'),
});
```

#### 1.3 IAMæ¨©é™è¨­å®š
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:PutObjectAcl",
        "s3:DeleteObject",
        "s3:GetObject"
      ],
      "Resource": "arn:aws:s3:::beatnexus-videos/*"
    }
  ]
}
```

### ğŸ—ï¸ **Phase 2: ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼å®Ÿè£…** (å®Ÿè£…æœŸé–“: 3-4æ—¥)

#### 2.1 æ–°è¦ä¾å­˜é–¢ä¿‚è¿½åŠ 
```json
// package.json ã¸ã®è¿½åŠ 
{
  "dependencies": {
    "@aws-sdk/client-s3": "^3.490.0",
    "@aws-sdk/s3-request-presigner": "^3.490.0",
    "@aws-sdk/lib-storage": "^3.490.0"
  }
}
```

#### 2.2 ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µãƒ¼ãƒ“ã‚¹æŠ½è±¡åŒ–
```typescript
// src/lib/storage/IVideoStorage.ts
export interface IVideoStorage {
  upload(file: File, userId: string): Promise<string>;
  delete(url: string): Promise<void>;
  getUrl(path: string): string;
  generatePresignedUrl(key: string, contentType: string): Promise<string>;
}

// src/lib/storage/SupabaseVideoStorage.ts
export class SupabaseVideoStorage implements IVideoStorage {
  async upload(file: File, userId: string): Promise<string> {
    const fileExt = file.name.split('.').pop();
    const fileName = `${crypto.randomUUID()}.${fileExt}`;
    const filePath = `${userId}/${fileName}`;
    
    const { error } = await supabase.storage
      .from('videos')
      .upload(filePath, file);
    
    if (error) throw new Error(`Upload failed: ${error.message}`);
    
    const { data: { publicUrl } } = supabase.storage
      .from('videos')
      .getPublicUrl(filePath);
    
    return publicUrl;
  }
  
  async delete(url: string): Promise<void> {
    // æ—¢å­˜ã®å‰Šé™¤ãƒ­ã‚¸ãƒƒã‚¯
  }
  
  getUrl(path: string): string {
    return path; // Supabaseã§ã¯æ—¢ã«ãƒ•ãƒ«URL
  }
  
  async generatePresignedUrl(key: string, contentType: string): Promise<string> {
    throw new Error('Presigned URLs not supported by Supabase');
  }
}

// src/lib/storage/S3VideoStorage.ts
export class S3VideoStorage implements IVideoStorage {
  private s3Client: S3Client;
  private bucketName: string;
  private cloudFrontDomain: string;
  
  constructor() {
    this.s3Client = new S3Client({
      region: process.env.AWS_REGION!,
      credentials: {
        accessKeyId: process.env.AWS_ACCESS_KEY_ID!,
        secretAccessKey: process.env.AWS_SECRET_ACCESS_KEY!,
      },
    });
    this.bucketName = process.env.AWS_S3_BUCKET!;
    this.cloudFrontDomain = process.env.CLOUDFRONT_DOMAIN!;
  }
  
  async upload(file: File, userId: string): Promise<string> {
    const fileExt = file.name.split('.').pop();
    const fileName = `${crypto.randomUUID()}.${fileExt}`;
    const key = `videos/${userId}/${fileName}`;
    
    const uploadCommand = new PutObjectCommand({
      Bucket: this.bucketName,
      Key: key,
      Body: file,
      ContentType: file.type,
      ACL: 'public-read',
    });
    
    await this.s3Client.send(uploadCommand);
    
    return `https://${this.cloudFrontDomain}/${key}`;
  }
  
  async delete(url: string): Promise<void> {
    const key = this.extractKeyFromUrl(url);
    
    const deleteCommand = new DeleteObjectCommand({
      Bucket: this.bucketName,
      Key: key,
    });
    
    await this.s3Client.send(deleteCommand);
  }
  
  getUrl(path: string): string {
    if (path.startsWith('https://')) return path;
    return `https://${this.cloudFrontDomain}/${path}`;
  }
  
  async generatePresignedUrl(key: string, contentType: string): Promise<string> {
    const command = new PutObjectCommand({
      Bucket: this.bucketName,
      Key: key,
      ContentType: contentType,
      ACL: 'public-read',
    });
    
    return getSignedUrl(this.s3Client, command, { expiresIn: 3600 });
  }
  
  private extractKeyFromUrl(url: string): string {
    if (url.includes(this.cloudFrontDomain)) {
      return url.split(`${this.cloudFrontDomain}/`)[1];
    }
    // Supabase URLã®å ´åˆã®å‡¦ç†
    const match = url.match(/.*\/storage\/v1\/object\/public\/videos\/(.+)$/);
    return match ? `videos/${match[1]}` : '';
  }
}

// src/lib/storage/VideoStorageFactory.ts
export class VideoStorageFactory {
  static create(): IVideoStorage {
    const provider = process.env.NEXT_PUBLIC_STORAGE_PROVIDER || 'supabase';
    
    switch (provider) {
      case 's3':
        return new S3VideoStorage();
      case 'supabase':
      default:
        return new SupabaseVideoStorage();
    }
  }
}
```

#### 2.3 ç’°å¢ƒå¤‰æ•°è¨­å®š
```env
# .env.local
NEXT_PUBLIC_STORAGE_PROVIDER=s3
AWS_REGION=us-east-1
AWS_ACCESS_KEY_ID=your-access-key
AWS_SECRET_ACCESS_KEY=your-secret-key
AWS_S3_BUCKET=beatnexus-videos
CLOUDFRONT_DOMAIN=d1234567890.cloudfront.net
```

### ğŸ”„ **Phase 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç§»è¡Œ** (å®Ÿè£…æœŸé–“: 2-3æ—¥)

#### 3.1 PostPage.tsxæ›´æ–°
```typescript
// src/pages/PostPage.tsx
import { VideoStorageFactory } from '../lib/storage/VideoStorageFactory';

const PostPage: React.FC = () => {
  const videoStorage = VideoStorageFactory.create();
  
  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsUploading(true);
    setError(null);
    
    try {
      // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ä½¿ç”¨
      const videoUrl = await videoStorage.upload(videoFile, user.id);
      
      // æ—¢å­˜ã®RPCå‘¼ã³å‡ºã—ã¯å¤‰æ›´ãªã—
      const { data: submissionResult, error: submissionError } = await supabase
        .rpc('create_submission_with_cooldown_check', {
          p_user_id: user.id,
          p_video_url: videoUrl, // æ–°ã—ã„CloudFront URL
          p_battle_format: battleFormat
        });
      
      // æ®‹ã‚Šã®å‡¦ç†ã¯æ—¢å­˜ã¨åŒã˜
    } catch (err) {
      setError(err instanceof Error ? err.message : 'æŠ•ç¨¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
    } finally {
      setIsUploading(false);
    }
  };
};
```

#### 3.2 ãƒ—ãƒªã‚µã‚¤ãƒ³ãƒ‰URLå¯¾å¿œï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
```typescript
// src/hooks/usePresignedUpload.ts
export const usePresignedUpload = () => {
  const [uploadProgress, setUploadProgress] = useState(0);
  
  const uploadWithProgress = async (file: File, userId: string) => {
    const videoStorage = VideoStorageFactory.create();
    const key = `videos/${userId}/${crypto.randomUUID()}.${file.name.split('.').pop()}`;
    
    // ãƒ—ãƒªã‚µã‚¤ãƒ³ãƒ‰URLå–å¾—
    const presignedUrl = await videoStorage.generatePresignedUrl(key, file.type);
    
    // XMLHttpRequestã§ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ä»˜ãã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    return new Promise<string>((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      
      xhr.upload.onprogress = (event) => {
        if (event.lengthComputable) {
          const progress = (event.loaded / event.total) * 100;
          setUploadProgress(progress);
        }
      };
      
      xhr.onload = () => {
        if (xhr.status === 200) {
          const cloudFrontUrl = `https://${process.env.NEXT_PUBLIC_CLOUDFRONT_DOMAIN}/${key}`;
          resolve(cloudFrontUrl);
        } else {
          reject(new Error(`Upload failed: ${xhr.status}`));
        }
      };
      
      xhr.onerror = () => reject(new Error('Network error'));
      
      xhr.open('PUT', presignedUrl);
      xhr.setRequestHeader('Content-Type', file.type);
      xhr.send(file);
    });
  };
  
  return { uploadWithProgress, uploadProgress };
};
```

### ğŸ—„ï¸ **Phase 4: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢æ•°æ›´æ–°** (å®Ÿè£…æœŸé–“: 2æ—¥)

#### 4.1 å‰Šé™¤é–¢æ•°ã®æ›´æ–°
```sql
-- supabase/migrations/20250120000000_update_storage_deletion_for_s3.sql

-- S3å¯¾å¿œã®å‹•ç”»å‰Šé™¤é–¢æ•°
CREATE OR REPLACE FUNCTION delete_user_videos_from_s3_and_supabase(p_user_id uuid)
RETURNS JSON
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_video_record RECORD;
  v_deleted_count INTEGER := 0;
  v_failed_count INTEGER := 0;
  v_deleted_urls TEXT[] := '{}';
  v_failed_urls TEXT[] := '{}';
  v_storage_provider TEXT;
BEGIN
  -- ç’°å¢ƒå¤‰æ•°ã‹ã‚‰ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’å–å¾—
  v_storage_provider := current_setting('app.storage_provider', true);
  IF v_storage_provider IS NULL THEN
    v_storage_provider := 'supabase'; -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  END IF;
  
  -- ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é–¢é€£ã™ã‚‹å…¨ã¦ã®å‹•ç”»URLã‚’å–å¾—
  FOR v_video_record IN
    SELECT video_url, 'submissions' as source_table
    FROM submissions 
    WHERE user_id = p_user_id AND video_url IS NOT NULL
    UNION
    SELECT player1_video_url as video_url, 'archived_battles_p1' as source_table
    FROM archived_battles 
    WHERE player1_user_id = p_user_id AND player1_video_url IS NOT NULL
    UNION
    SELECT player2_video_url as video_url, 'archived_battles_p2' as source_table
    FROM archived_battles 
    WHERE player2_user_id = p_user_id AND player2_video_url IS NOT NULL
  LOOP
    BEGIN
      IF v_storage_provider = 's3' THEN
        -- S3ã®å ´åˆï¼šCloudFrontã¾ãŸã¯S3 URLã‹ã‚‰å‰Šé™¤
        -- å®Ÿéš›ã®å‰Šé™¤ã¯ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å´ã§å®Ÿè¡Œ
        -- ã“ã“ã§ã¯ãƒ­ã‚°è¨˜éŒ²ã®ã¿
        INSERT INTO video_deletion_queue (video_url, user_id, created_at)
        VALUES (v_video_record.video_url, p_user_id, NOW());
        
        v_deleted_count := v_deleted_count + 1;
        v_deleted_urls := v_deleted_urls || v_video_record.video_url;
      ELSE
        -- Supabaseã®å ´åˆï¼šæ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
        -- ï¼ˆæ—¢å­˜ã®Supabaseå‰Šé™¤ã‚³ãƒ¼ãƒ‰ï¼‰
      END IF;
      
    EXCEPTION WHEN OTHERS THEN
      v_failed_count := v_failed_count + 1;
      v_failed_urls := v_failed_urls || v_video_record.video_url;
    END;
  END LOOP;
  
  RETURN json_build_object(
    'success', true,
    'deleted_count', v_deleted_count,
    'failed_count', v_failed_count,
    'deleted_urls', v_deleted_urls,
    'failed_urls', v_failed_urls,
    'storage_provider', v_storage_provider
  );
END;
$$;

-- å‹•ç”»å‰Šé™¤ã‚­ãƒ¥ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
CREATE TABLE IF NOT EXISTS video_deletion_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  video_url TEXT NOT NULL,
  user_id UUID NOT NULL,
  deleted BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  processed_at TIMESTAMPTZ
);
```

#### 4.2 Edge Functionæ›´æ–°
```typescript
// supabase/functions/delete-user-account/index.ts
import { S3Client, DeleteObjectCommand } from 'aws-sdk/client-s3';

const s3Client = new S3Client({
  region: Deno.env.get('AWS_REGION')!,
  credentials: {
    accessKeyId: Deno.env.get('AWS_ACCESS_KEY_ID')!,
    secretAccessKey: Deno.env.get('AWS_SECRET_ACCESS_KEY')!,
  },
});

async function deleteVideoFromS3(videoUrl: string): Promise<boolean> {
  try {
    // CloudFront URLã‹ã‚‰S3ã‚­ãƒ¼ã‚’æŠ½å‡º
    const cloudFrontDomain = Deno.env.get('CLOUDFRONT_DOMAIN');
    const bucketName = Deno.env.get('AWS_S3_BUCKET');
    
    let key: string;
    if (videoUrl.includes(cloudFrontDomain!)) {
      key = videoUrl.split(`${cloudFrontDomain}/`)[1];
    } else {
      // Supabase URLã®å ´åˆã®å¾Œæ–¹äº’æ›æ€§
      const match = videoUrl.match(/.*\/storage\/v1\/object\/public\/videos\/(.+)$/);
      key = match ? `videos/${match[1]}` : '';
    }
    
    if (!key) return false;
    
    const deleteCommand = new DeleteObjectCommand({
      Bucket: bucketName,
      Key: key,
    });
    
    await s3Client.send(deleteCommand);
    return true;
  } catch (error) {
    console.error('S3 deletion error:', error);
    return false;
  }
}

// ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ™‚ã®å‡¦ç†ã‚’æ›´æ–°
async function safeDeleteUserProfile(supabaseClient: SupabaseClient, userId: string) {
  console.log(`Attempting to safely delete profile for user ${userId}`);
  
  // S3ã‹ã‚‰ã®å‹•ç”»å‰Šé™¤ã‚’å…ˆã«å®Ÿè¡Œ
  const storageProvider = Deno.env.get('STORAGE_PROVIDER') || 'supabase';
  
  if (storageProvider === 's3') {
    // å‰Šé™¤ã‚­ãƒ¥ãƒ¼ã‹ã‚‰å‹•ç”»URLã‚’å–å¾—ã—ã¦å‰Šé™¤
    const { data: queuedVideos } = await supabaseClient
      .from('video_deletion_queue')
      .select('*')
      .eq('user_id', userId)
      .eq('deleted', false);
    
    if (queuedVideos) {
      for (const video of queuedVideos) {
        const deleted = await deleteVideoFromS3(video.video_url);
        
        // å‰Šé™¤çŠ¶æ…‹ã‚’æ›´æ–°
        await supabaseClient
          .from('video_deletion_queue')
          .update({ 
            deleted: deleted,
            processed_at: new Date().toISOString()
          })
          .eq('id', video.id);
      }
    }
  }
  
  // æ—¢å­˜ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤å‡¦ç†
  const { data, error } = await supabaseClient.rpc('safe_delete_user_account', {
    p_user_id: userId
  });
  
  // æ®‹ã‚Šã¯æ—¢å­˜ã¨åŒã˜
}
```

### ğŸ“Š **Phase 5: ãƒ‡ãƒ¼ã‚¿ç§»è¡Œæˆ¦ç•¥** (å®Ÿè£…æœŸé–“: 3-5æ—¥)

#### 5.1 æ®µéšçš„ç§»è¡Œã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
```typescript
// src/utils/videoMigration.ts
export class VideoMigrationService {
  private supabaseStorage = new SupabaseVideoStorage();
  private s3Storage = new S3VideoStorage();
  
  async migrateVideo(supabaseUrl: string, userId: string): Promise<string> {
    try {
      // 1. Supabaseã‹ã‚‰å‹•ç”»ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const response = await fetch(supabaseUrl);
      const blob = await response.blob();
      
      // 2. File ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
      const fileName = this.extractFileName(supabaseUrl);
      const file = new File([blob], fileName, { type: blob.type });
      
      // 3. S3ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      const s3Url = await this.s3Storage.upload(file, userId);
      
      // 4. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®URLã‚’æ›´æ–°
      await this.updateDatabaseUrls(supabaseUrl, s3Url);
      
      // 5. Supabaseã‹ã‚‰å‰Šé™¤
      await this.supabaseStorage.delete(supabaseUrl);
      
      return s3Url;
    } catch (error) {
      console.error('Migration failed:', error);
      throw error;
    }
  }
  
  private async updateDatabaseUrls(oldUrl: string, newUrl: string): Promise<void> {
    // submissions ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
    await supabase
      .from('submissions')
      .update({ video_url: newUrl })
      .eq('video_url', oldUrl);
    
    // archived_battles ãƒ†ãƒ¼ãƒ–ãƒ«ã®æ›´æ–°
    await supabase
      .from('archived_battles')
      .update({ player1_video_url: newUrl })
      .eq('player1_video_url', oldUrl);
    
    await supabase
      .from('archived_battles')
      .update({ player2_video_url: newUrl })
      .eq('player2_video_url', oldUrl);
  }
  
  private extractFileName(url: string): string {
    return url.split('/').pop() || 'unknown.mp4';
  }
}

// ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆ
export async function runVideoMigration() {
  const migrationService = new VideoMigrationService();
  
  // å…¨ã¦ã®Supabaseå‹•ç”»URLã‚’å–å¾—
  const { data: submissions } = await supabase
    .from('submissions')
    .select('id, video_url, user_id')
    .like('video_url', '%supabase.co%');
  
  if (submissions) {
    for (const submission of submissions) {
      try {
        console.log(`Migrating video: ${submission.video_url}`);
        await migrationService.migrateVideo(
          submission.video_url,
          submission.user_id
        );
        console.log(`âœ… Migration completed for submission ${submission.id}`);
        
        // ãƒ¬ãƒ¼ãƒˆåˆ¶é™å¯¾ç­–
        await new Promise(resolve => setTimeout(resolve, 1000));
      } catch (error) {
        console.error(`âŒ Migration failed for submission ${submission.id}:`, error);
      }
    }
  }
}
```

#### 5.2 ç§»è¡Œç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```typescript
// src/pages/admin/migration-dashboard.tsx
export default function MigrationDashboard() {
  const [migrationStats, setMigrationStats] = useState({
    total: 0,
    migrated: 0,
    failed: 0,
    inProgress: 0
  });
  
  useEffect(() => {
    const checkMigrationStatus = async () => {
      // Supabase URLs ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const { count: totalSupabase } = await supabase
        .from('submissions')
        .select('*', { count: 'exact', head: true })
        .like('video_url', '%supabase.co%');
      
      // S3 URLs ã®æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
      const { count: totalS3 } = await supabase
        .from('submissions')
        .select('*', { count: 'exact', head: true })
        .like('video_url', '%cloudfront.net%');
      
      setMigrationStats({
        total: (totalSupabase || 0) + (totalS3 || 0),
        migrated: totalS3 || 0,
        failed: 0, // ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã‹ã‚‰å–å¾—
        inProgress: 0 // é€²è¡Œä¸­ã®ã‚¸ãƒ§ãƒ–æ•°
      });
    };
    
    checkMigrationStatus();
    const interval = setInterval(checkMigrationStatus, 5000);
    
    return () => clearInterval(interval);
  }, []);
  
  return (
    <div className="p-6">
      <h1 className="text-2xl font-bold mb-6">Video Migration Dashboard</h1>
      
      <div className="grid grid-cols-4 gap-4 mb-6">
        <Card>
          <CardContent className="p-4">
            <div className="text-2xl font-bold">{migrationStats.total}</div>
            <div className="text-sm text-gray-600">Total Videos</div>
          </CardContent>
        </Card>
        
        <Card>
          <CardContent className="p-4">
            <div className="text-2xl font-bold text-green-600">{migrationStats.migrated}</div>
            <div className="text-sm text-gray-600">Migrated</div>
          </CardContent>
        </Card>
        
        <Card>
          <CardContent className="p-4">
            <div className="text-2xl font-bold text-blue-600">{migrationStats.inProgress}</div>
            <div className="text-sm text-gray-600">In Progress</div>
          </CardContent>
        </Card>
        
        <Card>
          <CardContent className="p-4">
            <div className="text-2xl font-bold text-red-600">{migrationStats.failed}</div>
            <div className="text-sm text-gray-600">Failed</div>
          </CardContent>
        </Card>
      </div>
      
      <div className="mb-4">
        <div className="flex justify-between text-sm mb-2">
          <span>Migration Progress</span>
          <span>{Math.round((migrationStats.migrated / migrationStats.total) * 100)}%</span>
        </div>
        <div className="w-full bg-gray-200 rounded-full h-2">
          <div 
            className="bg-blue-600 h-2 rounded-full transition-all duration-300"
            style={{ width: `${(migrationStats.migrated / migrationStats.total) * 100}%` }}
          />
        </div>
      </div>
    </div>
  );
}
```

### ğŸ§ª **Phase 6: ãƒ†ã‚¹ãƒˆ & æ¤œè¨¼** (å®Ÿè£…æœŸé–“: 2æ—¥)

#### 6.1 è‡ªå‹•ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
```typescript
// src/tests/storage.test.ts
import { describe, it, expect, beforeEach } from 'vitest';
import { S3VideoStorage } from '../lib/storage/S3VideoStorage';

describe('S3VideoStorage', () => {
  let storage: S3VideoStorage;
  
  beforeEach(() => {
    storage = new S3VideoStorage();
  });
  
  it('should upload video and return CloudFront URL', async () => {
    const mockFile = new File(['test'], 'test.mp4', { type: 'video/mp4' });
    const url = await storage.upload(mockFile, 'user123');
    
    expect(url).toMatch(/^https:\/\/.*\.cloudfront\.net\/videos\/user123\/.*\.mp4$/);
  });
  
  it('should delete video from S3', async () => {
    const testUrl = 'https://d123.cloudfront.net/videos/user123/test.mp4';
    
    await expect(storage.delete(testUrl)).resolves.not.toThrow();
  });
  
  it('should generate valid presigned URL', async () => {
    const presignedUrl = await storage.generatePresignedUrl(
      'videos/user123/test.mp4',
      'video/mp4'
    );
    
    expect(presignedUrl).toMatch(/^https:\/\/.*\.amazonaws\.com\/.*\?.*Signature=.*/);
  });
});
```

#### 6.2 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
```typescript
// src/tests/performance.test.ts
import { describe, it, expect } from 'vitest';

describe('Performance Tests', () => {
  it('should load video faster with CloudFront', async () => {
    const cloudFrontUrl = 'https://d123.cloudfront.net/videos/test.mp4';
    const supabaseUrl = 'https://project.supabase.co/storage/v1/object/public/videos/test.mp4';
    
    const cloudFrontStart = performance.now();
    await fetch(cloudFrontUrl, { method: 'HEAD' });
    const cloudFrontTime = performance.now() - cloudFrontStart;
    
    const supabaseStart = performance.now();
    await fetch(supabaseUrl, { method: 'HEAD' });
    const supabaseTime = performance.now() - supabaseStart;
    
    console.log(`CloudFront: ${cloudFrontTime}ms, Supabase: ${supabaseTime}ms`);
    expect(cloudFrontTime).toBeLessThan(supabaseTime * 0.8); // 20%ä»¥ä¸Šã®æ”¹å–„ã‚’æœŸå¾…
  });
});
```

### ğŸ“ˆ **Phase 7: ç›£è¦– & æœ€é©åŒ–** (ç¶™ç¶šçš„)

#### 7.1 CloudWatchç›£è¦–è¨­å®š
```typescript
// AWS CDKã§ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°è¨­å®š
const alarm = new cloudwatch.Alarm(this, 'HighErrorRate', {
  metric: distribution.metricErrorRate(),
  threshold: 5,
  evaluationPeriods: 2,
  treatMissingData: cloudwatch.TreatMissingData.NOT_BREACHING,
});

const dashboard = new cloudwatch.Dashboard(this, 'VideoDeliveryDashboard', {
  widgets: [
    [
      new cloudwatch.GraphWidget({
        title: 'CloudFront Cache Hit Rate',
        left: [distribution.metricCacheHitRate()],
      }),
    ],
    [
      new cloudwatch.GraphWidget({
        title: 'S3 Request Metrics',
        left: [
          bucket.metric('NumberOfObjects'),
          bucket.metric('BucketSizeBytes'),
        ],
      }),
    ],
  ],
});
```

#### 7.2 ã‚³ã‚¹ãƒˆç›£è¦–
```typescript
// src/utils/costMonitoring.ts
export class CostMonitoringService {
  async getStorageCosts(): Promise<CostBreakdown> {
    // AWS Cost Explorer APIã‚’ä½¿ç”¨ã—ã¦ã‚³ã‚¹ãƒˆåˆ†æ
    const s3Costs = await this.getS3Costs();
    const cloudFrontCosts = await this.getCloudFrontCosts();
    const dataTransferCosts = await this.getDataTransferCosts();
    
    return {
      s3Storage: s3Costs,
      cloudFrontDelivery: cloudFrontCosts,
      dataTransfer: dataTransferCosts,
      total: s3Costs + cloudFrontCosts + dataTransferCosts,
    };
  }
  
  async compareWithSupabase(): Promise<CostComparison> {
    const currentCosts = await this.getStorageCosts();
    const estimatedSupabaseCosts = await this.estimateSupabaseCosts();
    
    return {
      s3Total: currentCosts.total,
      supabaseEstimate: estimatedSupabaseCosts,
      savings: estimatedSupabaseCosts - currentCosts.total,
      savingsPercentage: ((estimatedSupabaseCosts - currentCosts.total) / estimatedSupabaseCosts) * 100,
    };
  }
}
```

## ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

### ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
- **é…ä¿¡é€Ÿåº¦**: 50-80%æ”¹å–„ï¼ˆã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒƒã‚¸ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰
- **ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€Ÿåº¦**: 30-60%æ”¹å–„ï¼ˆS3 Transfer Accelerationï¼‰
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“**: å¹³å‡200mså‰Šæ¸›

### ğŸ’° ã‚³ã‚¹ãƒˆæœ€é©åŒ–
| å®¹é‡ | Supabase | AWS S3+CloudFront | å‰Šæ¸›ç‡ |
|------|----------|-------------------|--------|
| 100GB | ~$25/æœˆ | ~$8/æœˆ | 68% |
| 1TB | ~$250/æœˆ | ~$35/æœˆ | 86% |
| 10TB | åˆ¶é™ã‚ã‚Š | ~$280/æœˆ | - |

### ğŸ“ˆ ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£
- **å®¹é‡åˆ¶é™**: å®Ÿè³ªç„¡åˆ¶é™
- **å¸¯åŸŸå¹…**: ç„¡åˆ¶é™ï¼ˆCloudFrontï¼‰
- **åœ°ç†çš„åˆ†æ•£**: ä¸–ç•Œ400+ã‚¨ãƒƒã‚¸ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

## âš ï¸ ãƒªã‚¹ã‚¯ & å¯¾ç­–

### æŠ€è¡“çš„ãƒªã‚¹ã‚¯
1. **ç§»è¡Œä¸­ã®ãƒ€ã‚¦ãƒ³ã‚¿ã‚¤ãƒ **
   - å¯¾ç­–: æ®µéšçš„ç§»è¡Œã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»
2. **ãƒ‡ãƒ¼ã‚¿æå¤±ãƒªã‚¹ã‚¯**
   - å¯¾ç­–: ç§»è¡Œå‰å®Œå…¨ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã€æ¤œè¨¼ãƒ—ãƒ­ã‚»ã‚¹
3. **äº’æ›æ€§å•é¡Œ**
   - å¯¾ç­–: æŠ½è±¡åŒ–ãƒ¬ã‚¤ãƒ¤ãƒ¼ã€å¾Œæ–¹äº’æ›æ€§ç¶­æŒ

### é‹ç”¨ãƒªã‚¹ã‚¯
1. **AWSä¾å­˜æ€§**
   - å¯¾ç­–: ãƒãƒ«ãƒã‚¯ãƒ©ã‚¦ãƒ‰å¯¾å¿œè¨­è¨ˆ
2. **ã‚³ã‚¹ãƒˆè¶…é**
   - å¯¾ç­–: è©³ç´°ãªç›£è¦–ã€è‡ªå‹•ã‚¢ãƒ©ãƒ¼ãƒˆ
3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**
   - å¯¾ç­–: IAMæœ€å°æ¨©é™ã€æš—å·åŒ–ã€ç›£æŸ»ãƒ­ã‚°

## ğŸ“… å®Ÿè£…ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

| Phase | æœŸé–“ | æ‹…å½“ | ä¸»è¦ã‚¿ã‚¹ã‚¯ |
|-------|------|------|-----------|
| Phase 1 | Day 1-3 | DevOps | AWSåŸºç›¤æ§‹ç¯‰ |
| Phase 2 | Day 4-7 | Backend | ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æŠ½è±¡åŒ– |
| Phase 3 | Day 8-10 | Frontend | UIç§»è¡Œ |
| Phase 4 | Day 11-12 | Backend | é–¢æ•°æ›´æ–° |
| Phase 5 | Day 13-17 | Full Team | ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ |
| Phase 6 | Day 18-19 | QA | ãƒ†ã‚¹ãƒˆ & æ¤œè¨¼ |
| Phase 7 | Day 20+ | DevOps | ç›£è¦– & æœ€é©åŒ– |

## ğŸ¯ æˆåŠŸæŒ‡æ¨™

### KPIè¨­å®š
1. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**
   - å‹•ç”»èª­ã¿è¾¼ã¿æ™‚é–“: < 2ç§’
   - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æˆåŠŸç‡: > 99%
   - CDNã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡: > 85%

2. **ã‚³ã‚¹ãƒˆ**
   - æœˆé–“ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆ: < $100
   - ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚³ã‚¹ãƒˆ: < $50
   - ç·ã‚³ã‚¹ãƒˆå‰Šæ¸›: > 60%

3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**
   - å‹•ç”»æŠ•ç¨¿å®Œäº†ç‡: > 95%
   - ã‚¨ãƒ©ãƒ¼ç‡: < 1%
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼æº€è¶³åº¦: > 4.5/5

## ğŸ”„ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨ˆç”»

### ç·Šæ€¥æ™‚å¯¾å¿œ
1. **å³åº§åˆ‡ã‚Šæˆ»ã—**: ç’°å¢ƒå¤‰æ•°å¤‰æ›´ã§Supabaseã«å¾©å¸°
2. **ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§**: ç§»è¡Œãƒ­ã‚°ãƒ™ãƒ¼ã‚¹ã§ã®çŠ¶æ…‹å¾©å…ƒ
3. **æ®µéšçš„å¾©æ—§**: æ©Ÿèƒ½åˆ¥ã®å€‹åˆ¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯

### æ‰‹é †
```bash
# ç·Šæ€¥ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
export NEXT_PUBLIC_STORAGE_PROVIDER=supabase
# ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å†èµ·å‹•
pm2 restart beatnexus

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å¾©æ—§
psql -d beatnexus -f rollback_migration.sql
```

---

## ğŸ“ ã¾ã¨ã‚

ã“ã®ç§»è¡Œè¨ˆç”»ã«ã‚ˆã‚Šã€BeatNexusã¯ä»¥ä¸‹ã‚’å®Ÿç¾ã—ã¾ã™ï¼š

âœ… **ã‚°ãƒ­ãƒ¼ãƒãƒ«é«˜é€Ÿé…ä¿¡** - CloudFrontã«ã‚ˆã‚‹ä¸–ç•Œè¦æ¨¡ã®é«˜é€ŸåŒ–  
âœ… **ã‚³ã‚¹ãƒˆå¤§å¹…å‰Šæ¸›** - 60-80%ã®ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚³ã‚¹ãƒˆå‰Šæ¸›  
âœ… **ç„¡åˆ¶é™ã‚¹ã‚±ãƒ¼ãƒ«** - å°†æ¥ã®æˆé•·ã«å¯¾å¿œã™ã‚‹æ‹¡å¼µæ€§  
âœ… **é‹ç”¨åŠ¹ç‡åŒ–** - è‡ªå‹•åŒ–ã•ã‚ŒãŸç›£è¦–ã¨æœ€é©åŒ–  
âœ… **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š** - é«˜é€Ÿã§å®‰å®šã—ãŸå‹•ç”»ã‚µãƒ¼ãƒ“ã‚¹  

**å®Ÿè£…é–‹å§‹æ—¥**: 2025-01-21  
**å®Œäº†äºˆå®šæ—¥**: 2025-02-10  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…**: é–‹ç™ºãƒãƒ¼ãƒ å…¨ä½“  
**æ‰¿èªè€…**: ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼  

---
**ğŸµ æ¬¡ä¸–ä»£ã®ãƒ“ãƒ¼ãƒˆãƒœã‚¯ã‚·ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã¸ã€ã•ã‚‰ãªã‚‹é€²åŒ–ã‚’ï¼ ğŸµ**

