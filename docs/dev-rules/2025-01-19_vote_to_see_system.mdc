---
description:
globs:
alwaysApply: false
---
# 🔒 投票後表示システム実装ログ

## 📅 実装日
2025-01-19

## 🎯 概要
投票分布バー、コメント、プレイヤーへの投票数を投票してから表示するシステムを構築。
投票前は結果が見えないようにし、投票後に詳細情報が表示される仕組みを実装。

## 🔍 実装内容

### ✅ バトル視聴ページ（BattleView.tsx）

#### 1. 投票数の条件付き表示
- **プレイヤーA・B投票数**: `hasVoted || isArchived` 条件で表示制御
- **投票前**: "投票して結果を見る" メッセージ表示
- **投票後**: 実際の投票数を表示

#### 2. 投票分布バーの制御
- **投票前**: 分布バー非表示
- **投票後**: パーセンテージと分布バーを表示
- **中央セクション**: トータル投票数も条件付き表示

#### 3. コメントセクションの大幅改修
- **投票前**: 投票促進UI表示
  - 説明メッセージとCTAボタン
  - プレイヤーAとプレイヤーB用の投票ボタン
- **投票後**: 従来のコメント一覧表示
- **参加者除外**: 自分のバトルでは投票ボタン無効化

### ✅ バトルカード（SimpleBattleCard.tsx）

#### 投票数表示の制御
- **アーカイブバトル**: 実際の投票数表示
- **アクティブバトル**: "?" と "投票して結果を見る" 表示

#### 分布バー制御
- **アーカイブバトル**: 分布バー表示
- **アクティブバトル**: 分布バー非表示

#### 総投票数バッジ
- **アーカイブバトル**: 実際の投票数表示
- **アクティブバトル**: 投票促進メッセージ

### ✅ スペシャルバトルカード（SpecialBattleCard.tsx）

#### PlayerDisplayコンポーネント修正
- `battle.is_archived` に基づく表示切り替え
- アーカイブ時は従来の投票数表示
- アクティブ時は "?" と投票促進メッセージ

#### 同様の制御適用
- 総投票数バッジの条件付き表示
- 分布バーのアーカイブ限定表示

### ✅ 翻訳対応

#### 日本語（ja.json）
```json
"voteToSeeResults": "投票して結果を見る",
"voteToSeeComments": "投票してコメントを見る",
"voteToSeeCommentsDesc": "このバトルの投票結果やコメントを見るには、まず投票してください"
```

#### 英語（en.json）
```json
"voteToSeeResults": "Vote to see results",
"voteToSeeComments": "Vote to see comments", 
"voteToSeeCommentsDesc": "To see voting results and comments for this battle, please vote first"
```

## 🔧 技術詳細

### 状態管理
- **BattleView**: `hasVoted` ステートによる表示制御
- **バトルカード**: `battle.is_archived` による判定
- **条件分岐**: 三項演算子による効率的な条件付きレンダリング

### UI/UX設計
- **視覚的階層**: 投票前は控えめなグレー、投票後は鮮やかな色彩
- **アイコン統一**: ThumbsUpアイコンで投票アクションを暗示
- **メッセージ一貫性**: 全コンポーネントで同じ翻訳キー使用

### アクセシビリティ
- **参加者除外**: 自分のバトルでは投票ボタン無効化
- **アーカイブ対応**: 過去のバトルは常に結果表示
- **ロード状態**: 投票状態読み込み中の適切な表示

## 🎯 解決された問題
1. **投票結果の先行表示**: 投票前に結果が見える問題を完全解決
2. **投票意欲の向上**: 結果を見るために投票が必要になり参加率向上
3. **フェアプレイ促進**: 結果に影響されない純粋な判断での投票
4. **UI一貫性**: 全バトル表示で統一された表示ルール

## 📊 影響範囲
- **BattleView.tsx**: メイン投票・コメント表示ロジック
- **SimpleBattleCard.tsx**: アクティブバトルカード表示
- **SpecialBattleCard.tsx**: 人気バトルカード表示  
- **翻訳ファイル**: 日英両言語対応
- **既存機能**: アーカイブバトルは従来通り表示

## 🚀 期待される効果
1. **投票参加率向上**: 結果を見るために投票が必須
2. **コメント品質向上**: 実際に投票したユーザーのみがコメント
3. **フェアな投票**: 既存結果に影響されない投票判断
4. **エンゲージメント向上**: 投票後の結果発見体験

## ✅ 検証項目
- [ ] アクティブバトルで投票前は結果非表示
- [ ] 投票後は即座に結果とコメント表示
- [ ] アーカイブバトルは常に結果表示
- [ ] 参加者は投票ボタン無効化
- [ ] 翻訳が正しく適用されている

## 🔗 関連ファイル
- `src/components/battle/BattleView.tsx` - メイン実装
- `src/components/battle/SimpleBattleCard.tsx` - バトルカード
- `src/components/battle/SpecialBattleCard.tsx` - スペシャルカード
- `src/i18n/locales/ja.json` - 日本語翻訳
- `src/i18n/locales/en.json` - 英語翻訳

---
**実装者**: AI Assistant  
**レビュー**: 要レビュー  
**ステータス**: 実装完了、動作確認待ち

## 🔄 修正履歴

### 2025-01-19 修正
**要求**: 総投票数の常時表示とコメントセクション投票ボタン削除

#### 修正内容
1. **総投票数の常時表示**
   - BattleView.tsx: ヘッダーとVSセクションの投票数を常に表示
   - SimpleBattleCard.tsx: 総投票数バッジを常に表示
   - SpecialBattleCard.tsx: 総投票数バッジを常に表示

2. **コメントセクション投票ボタン削除**
   - 投票前のプレイヤーA/B投票ボタンを削除
   - シンプルなメッセージ表示のみに変更

#### 影響
- 総投票数はユーザーの投票状態に関係なく表示
- コメントセクションはより簡潔な表示
- 投票は既存の投票ボタン（動画下部）のみで実行

### 2025-01-19 追加修正
**要求**: バトルカードの個別投票数「?」表示削除

#### 修正内容
3. **バトルカード個別投票数表示削除**
   - SimpleBattleCard.tsx: プレイヤーA・B個別投票数の「?」表示削除
   - SpecialBattleCard.tsx: PlayerDisplayでの「?」表示削除
   - アクティブバトルでは個別投票数は非表示、アーカイブバトルのみ表示

#### 最終的な表示ルール
- **総投票数**: 常に表示（全バトル）
- **個別投票数**: アーカイブバトルのみ表示
- **分布バー**: アーカイブバトルのみ表示  
- **コメント**: 投票後のみ表示（バトル視聴ページ）
