---
description: 
globs: 
alwaysApply: false
---
# ğŸ”Œ Supabase Realtimeæ¥ç¶šã‚¨ãƒ©ãƒ¼å¯¾å¿œå®Ÿè£…ãƒ­ã‚°

## ï¿½ï¿½ å®Ÿè£…æ—¥
2025å¹´1æœˆ19æ—¥

## ğŸ†• è¿½åŠ å¯¾å¿œæ—¥
2025å¹´1æœˆ19æ—¥ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰

## ğŸ¯ æ¦‚è¦
Supabase Realtimeãƒãƒ£ãƒ³ãƒãƒ«ã¸ã®WebSocketæ¥ç¶šå¤±æ•—ã‚¨ãƒ©ãƒ¼ã‚’è§£æ±ºã€‚
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã¨ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¦ã€æ¥ç¶šã«å¤±æ•—ã—ã¦ã‚‚ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒæ­£å¸¸ã«å‹•ä½œã—ç¶šã‘ã‚‹ã‚ˆã†æ”¹å–„ã€‚

**ğŸ†• è¿½åŠ å¯¾å¿œ**: WebSocketæ¥ç¶šã®è©³ç´°ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã¨è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’å®Ÿè£…ã€‚

## ğŸ” ç™ºè¦‹ã•ã‚ŒãŸå•é¡Œ
### WebSocketæ¥ç¶šã‚¨ãƒ©ãƒ¼
- **ã‚¨ãƒ©ãƒ¼å†…å®¹**: `WebSocket connection to 'wss://qgqcjtjxaoplhxurbpis.supabase.co/realtime/v1/websocket' failed`
- **å½±éŸ¿ç¯„å›²**: 
  - notificationStore.ts: é€šçŸ¥ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  - battleStore.ts: ãƒãƒˆãƒ«çŠ¶æ³ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°
  - ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒãƒˆãƒ«ã€å¾…æ©Ÿä¸­æŠ•ç¨¿ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

### ç™ºç”ŸåŸå› 
- é–‹ç™ºç’°å¢ƒã§ã®Supabase Realtimeæ¥ç¶šä¸å®‰å®š
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®å•é¡Œ
- Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®realtimeè¨­å®šã®å•é¡Œ

## ğŸ“ å®Ÿè£…å†…å®¹

### âœ… Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šå¼·åŒ–ï¼ˆåˆæœŸå®Ÿè£…ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/supabase.ts`

#### è¿½åŠ è¨­å®š
```typescript
realtime: {
  params: {
    eventsPerSecond: 10,
  },
  heartbeatIntervalMs: 30000,
},
global: {
  headers: {
    'X-Client-Info': 'beatnexus-web',
  },
}
```

### ğŸ†• WebSocketãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½è¿½åŠ ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/lib/supabase.ts`

#### æ–°æ©Ÿèƒ½
- **è©³ç´°ãƒ­ã‚°å‡ºåŠ›**: WebSocketæ¥ç¶šçŠ¶æ³ã®å®Œå…¨ç›£è¦–
- **è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤**: æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã«ã‚ˆã‚‹è³¢ã„å†æ¥ç¶š
- **ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰**: é–‹ç™ºç’°å¢ƒå°‚ç”¨ã®è©³ç´°æƒ…å ±åé›†

#### WebSocketãƒ‡ãƒãƒƒã‚°å®Ÿè£…
```typescript
// WebSocketæ¥ç¶šã®ãƒ‡ãƒãƒƒã‚°ç”¨
const logWebSocketEvents = () => {
  if (typeof window !== 'undefined' && import.meta.env.DEV) {
    // WebSocketæ¥ç¶šã‚’ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°
    const originalWebSocket = window.WebSocket;
    window.WebSocket = class extends originalWebSocket {
      constructor(url: string | URL, protocols?: string | string[]) {
        console.log('ğŸ”Œ WebSocket connection attempt:', { url, protocols });
        super(url, protocols);
        
        this.addEventListener('open', () => {
          console.log('âœ… WebSocket connection opened:', url);
        });
        
        this.addEventListener('error', (event) => {
          console.error('âŒ WebSocket error for:', url, event);
        });
        
        this.addEventListener('close', (event) => {
          console.warn('ğŸ”’ WebSocket connection closed:', { 
            url, 
            code: event.code, 
            reason: event.reason, 
            wasClean: event.wasClean 
          });
        });
      }
    };
  }
};
```

#### ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥å®Ÿè£…
```typescript
realtime: {
  // æ—¢å­˜è¨­å®š...
  // ğŸ†• WebSocketæ¥ç¶šã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã¨ãƒªãƒˆãƒ©ã‚¤è¨­å®šã‚’è¿½åŠ 
  reconnectAfterMs: (tries: number) => {
    // ãƒªãƒˆãƒ©ã‚¤é–“éš”: 1ç§’, 2ç§’, 4ç§’, 8ç§’, 16ç§’, æœ€å¤§30ç§’
    const interval = Math.min(1000 * Math.pow(2, tries), 30000);
    console.log(`ğŸ”„ WebSocket reconnect attempt ${tries + 1} in ${interval}ms`);
    return interval;
  },
  // ğŸ†• ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’æœ‰åŠ¹åŒ–
  logger: import.meta.env.DEV ? (level: string, message: string, data?: any) => {
    console.log(`ğŸ” Realtime [${level}]:`, message, data);
  } : undefined,
}
```

### âœ… ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½è¿½åŠ ï¼ˆåˆæœŸå®Ÿè£…ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/store/battleStore.ts`

#### å®Ÿè£…å†…å®¹
- **ã‚¨ãƒ©ãƒ¼æ¤œå‡º**: ãƒãƒ£ãƒ³ãƒãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç›£è¦–å¼·åŒ–
- **ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½**: æ¥ç¶šå¤±æ•—æ™‚ã®æ‰‹å‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥**: è­¦å‘Šãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°å‡ºåŠ›

#### ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°é–¢æ•°
```typescript
const handleChannelError = (channelName: string, status: string) => {
  if (status === 'CHANNEL_ERROR') {
    console.warn(`âš ï¸ ${channelName} connection failed, continuing with manual refresh mode`);
    // 30ç§’ã”ã¨ã®å®šæœŸæ›´æ–°ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
    const fallbackInterval = setInterval(() => {
      if (channelName.includes('active')) get().fetchActiveBattles();
      if (channelName.includes('archived')) get().fetchArchivedBattles();
      if (channelName.includes('waiting')) get().fetchWaitingSubmissions();
    }, 30000);
  }
};
```

### âœ… Notification Storeå¯¾å¿œï¼ˆåˆæœŸå®Ÿè£…ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/store/notificationStore.ts`

#### å®Ÿè£…å†…å®¹
- **æ¥ç¶šå¤±æ•—æ™‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯**: 1åˆ†ã”ã¨ã®æ‰‹å‹•æ›´æ–°
- **ã‚¨ãƒ©ãƒ¼å¾©æ—§**: è‡ªå‹•å†è©¦è¡Œæ©Ÿèƒ½
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ä¿æŒ**: é€šçŸ¥æ©Ÿèƒ½ã®ç¶™ç¶šå‹•ä½œ

### ğŸ†• ç’°å¢ƒå¤‰æ•°å‹å®šç¾©æ‹¡å¼µï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
**ãƒ•ã‚¡ã‚¤ãƒ«**: `src/vite-env.d.ts`

#### å®Ÿè£…å†…å®¹
```typescript
interface ImportMetaEnv {
  readonly VITE_SUPABASE_URL: string
  readonly VITE_SUPABASE_ANON_KEY: string
  readonly DEV: boolean          // ğŸ†• é–‹ç™ºç’°å¢ƒåˆ¤å®šç”¨
  readonly PROD: boolean         // ğŸ†• æœ¬ç•ªç’°å¢ƒåˆ¤å®šç”¨
  readonly MODE: string          // ğŸ†• ãƒ¢ãƒ¼ãƒ‰å–å¾—ç”¨
}
```

## ğŸ”§ æŠ€è¡“è©³ç´°

### ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥
1. **å³åº§å¯¾å¿œ**: ã‚¨ãƒ©ãƒ¼æ¤œå‡ºæ™‚ã«è­¦å‘Šè¡¨ç¤º
2. **è‡ªå‹•å¾©æ—§**: å®šæœŸçš„ãªæ‰‹å‹•ãƒ‡ãƒ¼ã‚¿æ›´æ–°
3. **ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£ç¶­æŒ**: åŸºæœ¬æ©Ÿèƒ½ã®ç¶™ç¶šæä¾›
4. **ãƒ¡ãƒ¢ãƒªç®¡ç†**: ã‚¿ã‚¤ãƒãƒ¼ã®é©åˆ‡ãªã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—

### ğŸ†• ãƒªãƒˆãƒ©ã‚¤æˆ¦ç•¥ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
1. **æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•**: 1ç§’ â†’ 2ç§’ â†’ 4ç§’ â†’ 8ç§’ â†’ 16ç§’ â†’ 30ç§’ï¼ˆæœ€å¤§ï¼‰
2. **è©³ç´°ãƒ­ã‚°**: å„ãƒªãƒˆãƒ©ã‚¤è©¦è¡Œã®è©³ç´°è¨˜éŒ²
3. **è‡ªå‹•åˆ‡ã‚Šæ›¿ãˆ**: ãƒªãƒˆãƒ©ã‚¤å¤±æ•—æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ç§»è¡Œ

### ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒ™ãƒ«åˆ†é¡
- `CHANNEL_ERROR`: æ¥ç¶šå¤±æ•— â†’ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰
- `TIMED_OUT`: ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ è‡ªå‹•å†è©¦è¡Œ
- `CLOSED`: æ­£å¸¸çµ‚äº† â†’ ãƒ­ã‚°è¨˜éŒ²ã®ã¿

### ğŸ†• WebSocketã‚¨ãƒ©ãƒ¼è©³ç´°åˆ†æï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
- **æ¥ç¶šè©¦è¡Œãƒ­ã‚°**: URLã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«æƒ…å ±è¨˜éŒ²
- **ã‚¨ãƒ©ãƒ¼è©³ç´°**: ã‚¨ãƒ©ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆã®å®Œå…¨ã‚­ãƒ£ãƒ—ãƒãƒ£
- **åˆ‡æ–­ç†ç”±**: ã‚¯ãƒ­ãƒ¼ã‚ºã‚³ãƒ¼ãƒ‰ã€ç†ç”±ã€ã‚¯ãƒªãƒ¼ãƒ³çµ‚äº†ã®åˆ¤å®š

## ğŸ¯ è§£æ±ºã•ã‚ŒãŸå•é¡Œ
1. **ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åœæ­¢å›é¿**: æ¥ç¶šã‚¨ãƒ©ãƒ¼ã§ã‚‚ã‚¢ãƒ—ãƒªç¶™ç¶šå‹•ä½œ
2. **ãƒ‡ãƒ¼ã‚¿åŒæœŸç¶­æŒ**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿æ›´æ–°
3. **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Š**: ã‚¨ãƒ©ãƒ¼ã‚’æ„Ÿã˜ã•ã›ãªã„é‹ç”¨
4. **ãƒ‡ãƒãƒƒã‚°åŠ¹ç‡åŒ–**: è©³ç´°ãªãƒ­ã‚°å‡ºåŠ›ã«ã‚ˆã‚‹å•é¡Œç‰¹å®š
5. **ğŸ†• æ ¹æœ¬åŸå› ç‰¹å®š**: WebSocketæ¥ç¶šå¤±æ•—ã®è©³ç´°åˆ†ææ©Ÿèƒ½
6. **ğŸ†• è‡ªå‹•å¾©æ—§å¼·åŒ–**: è³¢ã„ãƒªãƒˆãƒ©ã‚¤ã«ã‚ˆã‚‹æ¥ç¶šæˆåŠŸç‡å‘ä¸Š

## ğŸ“Š å½±éŸ¿ç¯„å›²
- **ãƒãƒˆãƒ«æ©Ÿèƒ½**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–° â†’ å®šæœŸæ›´æ–°ãƒ¢ãƒ¼ãƒ‰
- **é€šçŸ¥æ©Ÿèƒ½**: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é…ä¿¡ â†’ æ‰‹å‹•æ›´æ–°ãƒ¢ãƒ¼ãƒ‰  
- **å¾…æ©Ÿãƒ—ãƒ¼ãƒ«**: å³åº§æ›´æ–° â†’ 30ç§’é–“éš”æ›´æ–°
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“**: ç¶™ç¶šçš„ãªæ©Ÿèƒ½æä¾›
- **ğŸ†• ãƒ‡ãƒãƒƒã‚°**: é–‹ç™ºç’°å¢ƒã§ã®è©³ç´°å•é¡Œåˆ†æ

## ğŸš€ ä»Šå¾Œã®é‹ç”¨æ–¹é‡

### é‹ç”¨ãƒ¢ãƒ¼ãƒ‰
- **æœ¬ç•ªç’°å¢ƒ**: Realtimeæ¥ç¶šå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä½µç”¨
- **é–‹ç™ºç’°å¢ƒ**: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰è¨±å®¹ã€è©³ç´°ãƒ‡ãƒãƒƒã‚°æœ‰åŠ¹
- **ç›£è¦–å¼·åŒ–**: æ¥ç¶šçŠ¶æ³ã®å®šæœŸãƒã‚§ãƒƒã‚¯

### ğŸ†• ãƒ‡ãƒãƒƒã‚°æˆ¦ç•¥ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
- **é–‹ç™ºæ™‚**: å…¨WebSocketé€šä¿¡ã®è©³ç´°ãƒ­ã‚°åé›†
- **å•é¡Œåˆ†æ**: æ¥ç¶šå¤±æ•—ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š
- **æœ€é©åŒ–**: ãƒªãƒˆãƒ©ã‚¤é–“éš”ã®èª¿æ•´ã¨ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

### æ”¹å–„æ¤œè¨é …ç›®
- Supabaseãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã®è¦‹ç›´ã—
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ç’°å¢ƒã®æœ€é©åŒ–
- ã‚ˆã‚ŠåŠ¹ç‡çš„ãªãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã®èª¿æ•´
- ğŸ†• åé›†ã—ãŸãƒ‡ãƒãƒƒã‚°æƒ…å ±ã«åŸºã¥ãæ ¹æœ¬å¯¾ç­–

## âœ… æ¤œè¨¼é …ç›®
- [x] ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°æ©Ÿèƒ½ã®å®Ÿè£…
- [x] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å‹•ä½œç¢ºèª
- [x] ãƒ­ã‚°å‡ºåŠ›ã®é©åˆ‡æ€§ç¢ºèª
- [x] ğŸ†• WebSocketãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½ã®å®Ÿè£…
- [x] ğŸ†• è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã®å®Ÿè£…
- [ ] æœ¬ç•ªç’°å¢ƒã§ã®æ¥ç¶šå®‰å®šæ€§ç¢ºèª
- [ ] ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ™‚ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š
- [ ] ğŸ†• ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã«åŸºã¥ãå•é¡Œåˆ†æ

## ğŸ”— é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
- `src/lib/supabase.ts` - Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨­å®šï¼ˆğŸ†• ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½è¿½åŠ ï¼‰
- `src/store/battleStore.ts` - ãƒãƒˆãƒ«é–¢é€£ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†
- `src/store/notificationStore.ts` - é€šçŸ¥ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†
- `src/vite-env.d.ts` - ç’°å¢ƒå¤‰æ•°å‹å®šç¾©ï¼ˆğŸ†• DEV, PRODè¿½åŠ ï¼‰

## ğŸ”„ ã‚¨ãƒ©ãƒ¼å¯¾å¿œãƒ‘ã‚¿ãƒ¼ãƒ³
### æ¨™æº–å¯¾å¿œãƒ•ãƒ­ãƒ¼
```typescript
.subscribe((status) => {
  if (status === 'SUBSCRIBED') {
    console.log('âœ… Connected');
  } else {
    handleChannelError(channelName, status);
  }
});
```

### ğŸ†• è©³ç´°ãƒ‡ãƒãƒƒã‚°ãƒ•ãƒ­ãƒ¼ï¼ˆè¿½åŠ å®Ÿè£…ï¼‰
```typescript
// WebSocketè©³ç´°ç›£è¦–
ğŸ”Œ WebSocket connection attempt: { url, protocols }
âœ… WebSocket connection opened: [URL]
âŒ WebSocket error for: [URL] [ErrorEvent]
ğŸ”’ WebSocket connection closed: { url, code, reason, wasClean }

// è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤
ğŸ”„ WebSocket reconnect attempt 1 in 1000ms
ğŸ”„ WebSocket reconnect attempt 2 in 2000ms
// ... æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ç¶™ç¶š
```

---
**å®Ÿè£…è€…**: AI Assistant  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼**: è¦ãƒ¬ãƒ“ãƒ¥ãƒ¼  
**ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° + ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å®Ÿè£…å®Œäº†ã€ç¶™ç¶šç›£è¦–ä¸­

**ğŸ”— é–¢é€£æ”¹å–„**: WebSocketæ¥ç¶šå•é¡Œã®æ ¹æœ¬è§£æ±ºã«å‘ã‘ãŸè©³ç´°åˆ†æã¨ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ã‚’è¿½åŠ 

