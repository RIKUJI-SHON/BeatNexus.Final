# オンボーディングモーダル表示問題の修正

## 修正日
2025-07-20

## 問題の概要
新規アカウント作成後に、本来表示されるべきガイドモーダル（オンボーディング）が表示されない問題が発生していた。

## 原因分析
1. **新規ユーザー作成フロー**：
   - `SIGNED_UP`イベントは正しく発火している
   - `triggerOnboardingForNewUser`関数も正しく実行されている
   - しかし、タイミングや処理順序に問題がある可能性

2. **データベース状況**：
   - `has_seen_onboarding`フィールドのデフォルト値は`false`で正常
   - 新規ユーザーは正しく`has_seen_onboarding = false`で作成されている

3. **フロントエンド処理**：
   - オンボーディング状況チェックが適切なタイミングで実行されていない可能性
   - ユーザーがログイン状態になった後のオンボーディング確認が不十分

## 修正内容

### 1. オンボーディング初期化フックの作成
新しいカスタムフック`useOnboardingInitialization.ts`を作成：

```typescript
// src/hooks/useOnboardingInitialization.ts
// ユーザーがログインした際に自動的にオンボーディング状況をチェック
// 未完了の場合は自動表示する
```

### 2. App.tsx での統合
言語初期化と同様に、アプリレベルでオンボーディング初期化を実行：

```typescript
// App.tsx
useLanguageInitialization();
useOnboardingInitialization(); // 追加
```

### 3. 処理タイミングの改善
- 認証状態の読み込み完了後にオンボーディング状況を確認
- `SIGNED_UP`イベントだけでなく、通常のログイン時にも状況確認
- ダブルチェック機能により確実にオンボーディングを表示

## 期待される効果
- ✅ 新規ユーザーのオンボーディング自動表示
- ✅ 既存ユーザーでオンボーディング未完了の場合も自動表示
- ✅ 手動トリガー（BattlesPageのボタン）も継続動作
- ✅ タイミング問題の解決

## 適用環境
- ✅ 開発環境
- ⏳ 本番環境（次回デプロイ時）

## テスト方法
1. オンボーディング状況をリセット：
   ```sql
   UPDATE profiles SET has_seen_onboarding = false WHERE email = 'test@example.com';
   ```
2. ログアウト → ログイン
3. オンボーディングモーダルが自動表示されることを確認

## 注意点
- 既存のオンボーディング完了済みユーザーには影響なし
- `AuthProvider`の`SIGNED_UP`イベント処理は引き続き動作
- ダブルチェック機能により信頼性向上
