# 電話番号認証システム - 本番環境適用手順書

## 📋 概要
開発環境で完了した電話番号認証システムの管理テーブル方式を本番環境に適用するための手順書です。

## 📅 作成日
2025-01-27

## 🎯 適用対象
- **本番環境プロジェクトID**: `qgqcjtjxaoplhxurbpis`
- **マイグレーションファイル**: `20250127000000_complete_phone_verification_system.sql`
- **Edge Function**: `phone-verification`

## 🚀 実行手順

### Phase 1: データベースマイグレーション実行

#### 1.1 事前確認
```sql
-- 本番環境の既存データ確認
SELECT COUNT(*) as total_users FROM auth.users;
SELECT COUNT(*) as users_with_phone FROM auth.users WHERE phone IS NOT NULL;
```

#### 1.2 マイグレーション実行
```bash
# 統合マイグレーションファイルを本番環境に適用
mcp_supabase_apply_migration(
  name: "complete_phone_verification_system",
  project_id: "qgqcjtjxaoplhxurbpis",
  query: [20250127000000_complete_phone_verification_system.sqlの内容]
)
```

#### 1.3 実行後確認
```sql
-- テーブル作成確認
SELECT table_name, column_count 
FROM (
  SELECT table_name, COUNT(*) as column_count
  FROM information_schema.columns 
  WHERE table_name IN ('phone_verifications', 'audit_logs', 'security_audit_log')
  GROUP BY table_name
) t;

-- 関数作成確認
SELECT routine_name 
FROM information_schema.routines 
WHERE routine_name IN (
  'normalize_phone_number',
  'check_phone_availability', 
  'record_phone_verification',
  'log_phone_verification_attempt'
);

-- テスト実行
SELECT normalize_phone_number('090-1234-5678');
SELECT check_phone_availability('+81-90-1234-5678');
```

### Phase 2: Edge Function デプロイ

#### 2.1 Edge Function更新
```bash
mcp_supabase_deploy_edge_function(
  name: "phone-verification-new",
  project_id: "qgqcjtjxaoplhxurbpis", 
  files: [
    {
      name: "index.ts",
      content: [phone-verification-new/index.tsの内容]
    },
    {
      name: "deno.json", 
      content: [deno.jsonの内容]
    }
  ]
)
```

#### 2.2 デプロイ後確認
- Edge Function一覧で`phone-verification-new`が表示されることを確認
- 新しい管理テーブル方式の電話番号認証機能が正常動作することを確認

### Phase 3: フロントエンド デプロイ

#### 3.1 更新内容
- `src/components/auth/AuthModal.tsx`: 新しいEdge Function `phone-verification-new` 使用、エラーハンドリング改善
- `src/i18n/locales/ja.json`: 日本語エラーメッセージ追加  
- `src/i18n/locales/en.json`: 英語エラーメッセージ追加

#### 3.2 デプロイ実行
```bash
# Vercelへのデプロイ（既存のCI/CDパイプライン使用）
git add .
git commit -m "feat: 電話番号認証システム管理テーブル方式対応（phone-verification-new使用）"
git push origin develop
```

### Phase 4: 動作検証

#### 4.1 機能テスト
1. **新規ユーザー登録テスト**
   - 重複していない電話番号での登録成功
   - 重複した電話番号での登録失敗（エラーメッセージ表示）
   
2. **既存ユーザー電話番号追加テスト**
   - ログイン後の電話番号認証成功
   - 管理テーブルへの記録確認

3. **エラーハンドリングテスト**
   - システムエラー時の適切なメッセージ表示
   - 無効なOTPコード入力時のエラー表示

#### 4.2 データ整合性確認
```sql
-- 認証完了ユーザーの確認
SELECT 
  u.email,
  u.phone,
  u.phone_confirmed_at,
  pv.phone_number,
  pv.verified_at
FROM auth.users u
LEFT JOIN phone_verifications pv ON u.id = pv.user_id
WHERE u.phone_confirmed_at IS NOT NULL
ORDER BY u.created_at DESC
LIMIT 10;

-- 統計確認
SELECT * FROM phone_verification_stats;
```

## ⚠️ 注意事項

### リスク管理
1. **バックアップ**: マイグレーション実行前に必ずデータベースバックアップを取得
2. **段階実行**: データベース → Edge Function → フロントエンドの順で実行
3. **監視**: 実行後24時間はエラーログを重点監視

### ロールバック手順
```sql
-- 緊急時のロールバック（テーブル削除）
DROP TABLE IF EXISTS phone_verifications CASCADE;
DROP TABLE IF EXISTS audit_logs CASCADE; 
DROP TABLE IF EXISTS security_audit_log CASCADE;
DROP FUNCTION IF EXISTS normalize_phone_number(TEXT) CASCADE;
DROP FUNCTION IF EXISTS check_phone_availability(TEXT) CASCADE;
DROP FUNCTION IF EXISTS record_phone_verification(UUID, TEXT) CASCADE;
```

### 既存ユーザーへの影響
- 既存の電話番号認証済みユーザーに影響なし
- auth.usersテーブルの既存データは保持
- 新規認証時から管理テーブルが使用される

## 📊 成功指標

### 定量的指標
- [ ] マイグレーション成功率: 100%
- [ ] Edge Functionデプロイ成功: 確認済み
- [ ] 電話番号重複チェック動作: 正常
- [ ] 新規登録成功率: 95%以上維持

### 定性的指標  
- [ ] ユーザーからの重複アカウント関連問い合わせ減少
- [ ] エラーメッセージの分かりやすさ向上
- [ ] システム安定性向上

## 📞 緊急連絡先

### 技術サポート
- 開発者: システム管理者
- 実装日時: 要調整
- 監視期間: 実装後1週間

### 完了報告
- [ ] Phase 1: データベースマイグレーション完了
- [ ] Phase 2: Edge Functionデプロイ完了  
- [ ] Phase 3: フロントエンドデプロイ完了
- [ ] Phase 4: 動作検証完了
- [ ] 本番環境適用完了

---

**重要**: この手順書に従って慎重に実行し、各段階で動作確認を行ってください。問題が発生した場合は即座にロールバックを実行してください。
