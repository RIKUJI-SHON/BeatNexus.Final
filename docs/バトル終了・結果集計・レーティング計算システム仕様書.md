# BeatNexus ãƒãƒˆãƒ«çµ‚äº†ãƒ»çµæœé›†è¨ˆãƒ»ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸

**æœ€çµ‚æ›´æ–°**: 2025å¹´7æœˆ25æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: v7.0  
**é©ç”¨ç’°å¢ƒ**: é–‹ç™ºç’°å¢ƒãƒ»æœ¬ç•ªç’°å¢ƒ

## ğŸ“‹ ç›®æ¬¡
1. [æ¦‚è¦](#æ¦‚è¦)
2. [ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ](#ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ )
3. [çµæœé›†è¨ˆã‚·ã‚¹ãƒ†ãƒ ](#çµæœé›†è¨ˆã‚·ã‚¹ãƒ†ãƒ )
4. [ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ](#ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ )
5. [ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ](#ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ )
6. [è‡ªå‹•å‡¦ç†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«](#è‡ªå‹•å‡¦ç†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«)
7. [é–¢æ•°è©³ç´°è§£èª¬](#é–¢æ•°è©³ç´°è§£èª¬)
8. [ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£](#ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£)

---

## æ¦‚è¦

BeatNexusã®ãƒãƒˆãƒ«çµ‚äº†ãƒ»çµæœé›†è¨ˆãƒ»ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ ã¯ã€æŠ•ç¥¨æœŸé–“ãŒçµ‚äº†ã—ãŸãƒãƒˆãƒ«ã‚’è‡ªå‹•çš„ã«åˆ¤å®šã—ã€å‹æ•—ã‚’ç¢ºå®šã—ã¦ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹æ©Ÿèƒ½ã§ã™ã€‚å …ç‰¢ãªEloãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ ã¨ã‚·ãƒ¼ã‚ºãƒ³åˆ¶ã«ã‚ˆã£ã¦ã€å…¬å¹³ã§ç¶™ç¶šçš„ãªç«¶æŠ€ç’°å¢ƒã‚’æä¾›ã—ã¾ã™ã€‚

### ä¸»è¦ãªç‰¹å¾´
- **è‡ªå‹•ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†**: æŠ•ç¥¨æœŸé–“çµ‚äº†å¾Œã®è‡ªå‹•åˆ¤å®šãƒ»ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
- **Eloãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ **: æˆ¦åŠ›å·®ã‚’è€ƒæ…®ã—ãŸå…¬å¹³ãªãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—
- **ãƒãƒˆãƒ«å½¢å¼åˆ¥Kãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼**: MAIN_BATTLE/MINI_BATTLE/THEME_CHALLENGEã”ã¨ã®èª¿æ•´
- **ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆç®¡ç†**: ã‚·ãƒ¼ã‚ºãƒ³åˆ¶ã«ã‚ˆã‚‹é•·æœŸçš„ãªç«¶æŠ€ã‚·ã‚¹ãƒ†ãƒ 
- **å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ**: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®å¯¾æˆ¦æ™‚ã®ç‰¹åˆ¥å‡¦ç†
- **å‹•ç”»URLæ°¸ç¶šä¿å­˜**: ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ™‚ã®å‹•ç”»URLä¿å­˜ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ä¿å…¨

---

## ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 

### å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
graph TD
    A[pg_cron: 5åˆ†é–“éš”å®Ÿè¡Œ] --> B[process_expired_battles()]
    B --> C[æŠ•ç¥¨æœŸé–“çµ‚äº†ãƒãƒˆãƒ«æ¤œç´¢]
    C --> D[ãƒãƒˆãƒ«ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: PROCESSING_RESULTS]
    D --> E[å‹æ•—åˆ¤å®š]
    E --> F[complete_battle_with_video_archiving()]
    F --> G[archived_battlesã«ç§»å‹•]
    F --> H[ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ›´æ–°]
    F --> I[ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆæ›´æ–°]
    F --> J[å‹•ç”»URLä¿å­˜]
    F --> K[active_battlesã‹ã‚‰å‰Šé™¤]
    K --> L[å‡¦ç†å®Œäº†]
```

### å‹æ•—åˆ¤å®šãƒ«ãƒ¼ãƒ«

#### 1. åŸºæœ¬å‹æ•—åˆ¤å®š
```sql
-- å‹æ•—ã®æ±ºå®š
IF votes_a > votes_b THEN
  winner_id := player1_user_id;  -- Player Aå‹åˆ©
ELSIF votes_b > votes_a THEN
  winner_id := player2_user_id;  -- Player Bå‹åˆ©
ELSE
  winner_id := NULL;             -- å¼•ãåˆ†ã‘
END IF;
```

#### 2. æŠ•ç¥¨æœŸé–“ãƒã‚§ãƒƒã‚¯
- **çµ‚äº†åˆ¤å®š**: `end_voting_at < NOW()`
- **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹**: `status = 'ACTIVE'`ã®ã¿å‡¦ç†å¯¾è±¡
- **é‡è¤‡å‡¦ç†é˜²æ­¢**: `PROCESSING_RESULTS`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡

#### 3. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
- **å‡¦ç†å¤±æ•—æ™‚**: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’`ACTIVE`ã«æˆ»ã—ã¦ãƒªãƒˆãƒ©ã‚¤å¯¾è±¡ã¨ã™ã‚‹
- **ãƒ­ã‚°è¨˜éŒ²**: æˆåŠŸãƒ»å¤±æ•—ã®è©³ç´°ãƒ­ã‚°ã‚’JSONå½¢å¼ã§ä¿å­˜

---

## çµæœé›†è¨ˆã‚·ã‚¹ãƒ†ãƒ 

### ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–å‡¦ç†

#### archived_battlesãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
```sql
CREATE TABLE archived_battles (
  id UUID PRIMARY KEY,
  original_battle_id UUID,           -- å…ƒã®active_battle.id
  winner_id UUID,                    -- å‹è€…ã®user_id (NULLãªã‚‰å¼•ãåˆ†ã‘)
  final_votes_a INTEGER,             -- æœ€çµ‚æŠ•ç¥¨æ•°A
  final_votes_b INTEGER,             -- æœ€çµ‚æŠ•ç¥¨æ•°B
  battle_format battle_format,       -- ãƒãƒˆãƒ«å½¢å¼
  player1_user_id UUID,              -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®user_id
  player2_user_id UUID,              -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®user_id
  player1_submission_id UUID,        -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®æŠ•ç¨¿ID
  player2_submission_id UUID,        -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®æŠ•ç¨¿ID
  player1_video_url TEXT,            -- âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®å‹•ç”»URLï¼ˆæ°¸ç¶šä¿å­˜ï¼‰
  player2_video_url TEXT,            -- âœ… ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‹•ç”»URLï¼ˆæ°¸ç¶šä¿å­˜ï¼‰
  player1_rating_change INTEGER,     -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•
  player2_rating_change INTEGER,     -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•
  player1_final_rating INTEGER,      -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®æœ€çµ‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  player2_final_rating INTEGER,      -- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®æœ€çµ‚ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
  season_id UUID,                    -- ã‚·ãƒ¼ã‚ºãƒ³ID
  archived_at TIMESTAMPTZ,           -- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ—¥æ™‚
  created_at TIMESTAMPTZ,            -- å…ƒã®ä½œæˆæ—¥æ™‚
  updated_at TIMESTAMPTZ             -- æ›´æ–°æ—¥æ™‚
);
```

#### æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
```sql
-- archived_battle_votesãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç§»è¡Œ
INSERT INTO archived_battle_votes (
  archived_battle_id,
  user_id,
  vote,
  comment,
  created_at
)
SELECT 
  v_archived_id,      -- æ–°ã—ã„archived_battle.id
  user_id,
  vote,
  comment,
  created_at
FROM battle_votes
WHERE battle_id = p_battle_id;
```

### çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ

#### ãƒãƒˆãƒ«çµ±è¨ˆ
- **å‡¦ç†æˆåŠŸæ•°**: `v_processed_count`
- **ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ•°**: `v_error_count`
- **å‡¦ç†è©³ç´°**: å„ãƒãƒˆãƒ«ã®å‹æ•—ãƒ»æŠ•ç¥¨æ•°ãƒ»ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•
- **ã‚¨ãƒ©ãƒ¼è©³ç´°**: å¤±æ•—ã—ãŸãƒãƒˆãƒ«ã®ã‚¨ãƒ©ãƒ¼å†…å®¹ã¨ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—

---

## ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 

### Eloãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

#### åŸºæœ¬è¨ˆç®—å¼
```sql
-- æœŸå¾…å‹ç‡ã®è¨ˆç®—
expected_score := 1.0 / (1.0 + POWER(10.0, (opponent_rating - player_rating) / 400.0));

-- ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•ã®è¨ˆç®—
rating_change := ROUND(k_factor * (result - expected_score));

-- æ–°ã—ã„ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
new_rating := GREATEST(old_rating + rating_change, 1100);  -- æœ€ä½ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°1100
```

#### Kãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ï¼ˆãƒãƒˆãƒ«å½¢å¼åˆ¥ï¼‰
```sql
-- get_k_factor_by_format() é–¢æ•°
CASE battle_format
  WHEN 'MAIN_BATTLE' THEN RETURN 32;      -- ãƒ¡ã‚¤ãƒ³ãƒãƒˆãƒ«: é«˜å¤‰å‹•
  WHEN 'MINI_BATTLE' THEN RETURN 24;      -- ãƒŸãƒ‹ãƒãƒˆãƒ«: ä¸­å¤‰å‹•  
  WHEN 'THEME_CHALLENGE' THEN RETURN 20;  -- ãƒ†ãƒ¼ãƒãƒãƒ£ãƒ¬ãƒ³ã‚¸: ä½å¤‰å‹•
  ELSE RETURN 32;                          -- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
END CASE;
```

#### ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ãƒ‘ã‚¿ãƒ¼ãƒ³

##### 1. é€šå¸¸å¯¾æˆ¦ï¼ˆä¸¡ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ï¼‰
```sql
-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1å‹åˆ©ã®å ´åˆ
IF winner_id = player1_user_id THEN
  player1_change := calculate_elo_rating_change(player1_rating, player2_rating, 1.0, k_factor);
  player2_change := calculate_elo_rating_change(player2_rating, player1_rating, 0.0, k_factor);

-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2å‹åˆ©ã®å ´åˆ  
ELSIF winner_id = player2_user_id THEN
  player1_change := calculate_elo_rating_change(player1_rating, player2_rating, 0.0, k_factor);
  player2_change := calculate_elo_rating_change(player2_rating, player1_rating, 1.0, k_factor);

-- å¼•ãåˆ†ã‘ã®å ´åˆ
ELSE
  player1_change := calculate_elo_rating_change(player1_rating, player2_rating, 0.5, k_factor);
  player2_change := calculate_elo_rating_change(player2_rating, player1_rating, 0.5, k_factor);
END IF;
```

##### 2. å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾æˆ¦
```sql
-- ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1ã®ã¿ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã®å ´åˆ
IF NOT player1_deleted AND player2_deleted THEN
  IF winner_id = player1_user_id THEN
    player1_change := k_factor / 2;  -- å‹åˆ©æ™‚ï¼šåŠåˆ†Kãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ãƒœãƒ¼ãƒŠã‚¹
  ELSE
    player1_change := 0;             -- æ•—åŒ—æ™‚ï¼šãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—
  END IF;
END IF;
```

### ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒ©ãƒ³ã‚¯ ã‚·ã‚¹ãƒ†ãƒ 

#### ãƒ©ãƒ³ã‚¯åŒºåˆ†
```sql
-- get_rank_from_rating() é–¢æ•°
CASE 
  WHEN rating >= 1800 THEN RETURN 'Grandmaster';  -- ã‚°ãƒ©ãƒ³ãƒ‰ãƒã‚¹ã‚¿ãƒ¼
  WHEN rating >= 1600 THEN RETURN 'Master';       -- ãƒã‚¹ã‚¿ãƒ¼
  WHEN rating >= 1400 THEN RETURN 'Expert';       -- ã‚¨ã‚­ã‚¹ãƒ‘ãƒ¼ãƒˆ
  WHEN rating >= 1300 THEN RETURN 'Advanced';     -- ã‚¢ãƒ‰ãƒãƒ³ã‚¹
  WHEN rating >= 1200 THEN RETURN 'Intermediate'; -- ä¸­ç´š
  WHEN rating >= 1100 THEN RETURN 'Beginner';     -- åˆç´š
  ELSE RETURN 'Unranked';                          -- ãƒ©ãƒ³ã‚¯ãªã—
END CASE;
```

#### ãƒ©ãƒ³ã‚¯è‰²
```sql
-- get_rank_color_from_rating() é–¢æ•°
CASE 
  WHEN rating >= 1800 THEN RETURN 'rainbow';  -- ãƒ¬ã‚¤ãƒ³ãƒœãƒ¼
  WHEN rating >= 1600 THEN RETURN 'purple';   -- ç´«
  WHEN rating >= 1400 THEN RETURN 'blue';     -- é’
  WHEN rating >= 1300 THEN RETURN 'green';    -- ç·‘
  WHEN rating >= 1200 THEN RETURN 'yellow';   -- é»„
  WHEN rating >= 1100 THEN RETURN 'gray';     -- ã‚°ãƒ¬ãƒ¼
  ELSE RETURN 'unranked';                      -- ãƒ©ãƒ³ã‚¯ãªã—
END CASE;
```

---

## ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—ã‚·ã‚¹ãƒ†ãƒ 

### ã‚·ãƒ¼ã‚ºãƒ³åˆ¶ã®æ¦‚å¿µ
- **ä¸¦è¡Œã‚·ã‚¹ãƒ†ãƒ **: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã¯ç‹¬ç«‹ã—ãŸã‚·ãƒ¼ã‚ºãƒ³é™å®šãƒã‚¤ãƒ³ãƒˆ
- **å®šæœŸãƒªã‚»ãƒƒãƒˆ**: ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã«ãƒªã‚»ãƒƒãƒˆã€æ–°ã‚·ãƒ¼ã‚ºãƒ³ã§1200ãƒã‚¤ãƒ³ãƒˆã‚¹ã‚¿ãƒ¼ãƒˆ
- **åŒä¸€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯**: ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã¨å®Œå…¨åŒã˜Eloã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨

### ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆè¨ˆç®—

#### åŸºæœ¬å‡¦ç†ãƒ•ãƒ­ãƒ¼
```sql
-- update_season_points_after_battle() é–¢æ•°
1. ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ã‚ºãƒ³ã®å–å¾—
2. ãƒãƒˆãƒ«æƒ…å ±ã®å–å¾—ï¼ˆarchived_battlesã‹ã‚‰ï¼‰
3. å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒã‚§ãƒƒã‚¯
4. ç¾åœ¨ã®ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆå–å¾—
5. Eloã‚·ã‚¹ãƒ†ãƒ ã§ãƒã‚¤ãƒ³ãƒˆå¤‰å‹•è¨ˆç®—ï¼ˆãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯ï¼‰
6. æœ€ä½1100ãƒã‚¤ãƒ³ãƒˆåˆ¶é™é©ç”¨
7. profilesãƒ†ãƒ¼ãƒ–ãƒ«ã®season_pointsæ›´æ–°
```

#### è¨ˆç®—ä¾‹
```sql
-- é€šå¸¸å¯¾æˆ¦æ™‚ï¼ˆãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã¨å®Œå…¨åŒä¸€ï¼‰
IF winner_id = player1_user_id THEN
  player1_change := calculate_elo_rating_change(player1_season_points, player2_season_points, 1.0, k_factor);
  player2_change := calculate_elo_rating_change(player2_season_points, player1_season_points, 0.0, k_factor);
END IF;

-- æ–°ã—ã„ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆï¼ˆæœ€ä½1100åˆ¶é™ï¼‰
player1_new_points := GREATEST(player1_season_points + player1_change, 1100);
player2_new_points := GREATEST(player2_season_points + player2_change, 1100);
```

---

## è‡ªå‹•å‡¦ç†ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«

### pg_cronã«ã‚ˆã‚‹å®šæœŸå®Ÿè¡Œ

#### 1. ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†
```sql
-- pg_cronè¨­å®šï¼ˆä¾‹ï¼‰
SELECT cron.schedule(
  'process-expired-battles',
  '*/5 * * * *',  -- 5åˆ†é–“éš”
  'SELECT process_expired_battles();'
);
```

#### 2. å‡¦ç†ã‚¿ã‚¤ãƒŸãƒ³ã‚°
- **å®Ÿè¡Œé–“éš”**: 5åˆ†ã”ã¨
- **å¯¾è±¡**: `end_voting_at < NOW() AND status = 'ACTIVE'`
- **ä¸¦è¡Œå‡¦ç†**: `PROCESSING_RESULTS`ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«ã‚ˆã‚‹æ’ä»–åˆ¶å¾¡

#### 3. ã‚¨ãƒ©ãƒ¼å¾©æ—§
- **è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤**: å¤±æ•—ã—ãŸãƒãƒˆãƒ«ã¯æ¬¡å›å®Ÿè¡Œæ™‚ã«å†å‡¦ç†
- **ãƒ­ã‚°è¨˜éŒ²**: å‡¦ç†çµæœã¨ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’JSONå½¢å¼ã§è¨˜éŒ²

---

## é–¢æ•°è©³ç´°è§£èª¬

### 1. `process_expired_battles()`

#### ç›®çš„
æŠ•ç¥¨æœŸé–“ãŒçµ‚äº†ã—ãŸã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒˆãƒ«ã‚’è‡ªå‹•çš„ã«å‡¦ç†ã—ã€çµæœã‚’ç¢ºå®šã™ã‚‹

#### æˆ»ã‚Šå€¤
```json
{
  "success": true,
  "processed_count": 3,
  "error_count": 0,
  "processed_battles": [
    {
      "battle_id": "uuid",
      "winner_id": "uuid",
      "is_tie": false,
      "votes_a": 15,
      "votes_b": 8,
      "completion_result": { /* è©³ç´°çµæœ */ }
    }
  ],
  "errors": [],
  "execution_time": "2025-07-25T12:00:00Z"
}
```

### 2. `complete_battle_with_video_archiving()`

#### ç›®çš„
ãƒãƒˆãƒ«çµ‚äº†æ™‚ã®åŒ…æ‹¬çš„å‡¦ç†ï¼ˆã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ»ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ›´æ–°ãƒ»å‹•ç”»ä¿å­˜ï¼‰

#### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- `p_battle_id`: çµ‚äº†ã™ã‚‹ãƒãƒˆãƒ«ID
- `p_winner_id`: å‹è€…ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDï¼ˆå¼•ãåˆ†ã‘ãªã‚‰NULLï¼‰

#### å‡¦ç†å†…å®¹
```sql
1. ãƒãƒˆãƒ«è©³ç´°ã®å–å¾—
2. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®å‰Šé™¤çŠ¶æ…‹ãƒã‚§ãƒƒã‚¯
3. å‹•ç”»URLã®å–å¾—ï¼ˆsubmissionsãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰ï¼‰
4. archived_battlesã¸ã®æŒ¿å…¥ï¼ˆå‹•ç”»URLå«ã‚€ï¼‰
5. archived_battle_votesã¸ã®æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ç§»è¡Œ
6. submissionsã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆBATTLE_ENDEDï¼‰
7. ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ›´æ–°ï¼ˆå‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼è€ƒæ…®ï¼‰
8. ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆæ›´æ–°
9. active_battlesã¨battle_votesã®å‰Šé™¤
```

#### æˆ»ã‚Šå€¤
```json
{
  "success": true,
  "archived_battle_id": "uuid",
  "winner_id": "uuid",
  "final_votes_a": 15,
  "final_votes_b": 8,
  "player1_video_url": "https://...",
  "player2_video_url": "https://...",
  "player1_deleted": false,
  "player2_deleted": false,
  "rating_update": { /* ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°æ›´æ–°çµæœ */ },
  "season_points_update": { /* ã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆæ›´æ–°çµæœ */ }
}
```

### 3. `update_battle_ratings_safe()`

#### ç›®çš„
ãƒãƒˆãƒ«çµæœã«åŸºã¥ã„ãŸãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã®å®‰å…¨ãªæ›´æ–°

#### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
- `p_battle_id`: ãƒãƒˆãƒ«ID
- `p_winner_id`: å‹è€…IDï¼ˆå¼•ãåˆ†ã‘ãªã‚‰NULLï¼‰
- `p_player1_deleted`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼1å‰Šé™¤ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: FALSEï¼‰
- `p_player2_deleted`: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2å‰Šé™¤ãƒ•ãƒ©ã‚°ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: FALSEï¼‰

#### ç‰¹å¾´
- **å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼å¯¾å¿œ**: å‰Šé™¤ã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯æ›´æ–°ã—ãªã„
- **ãƒœãƒ¼ãƒŠã‚¹åˆ¶åº¦**: å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å‹åˆ©ã—ãŸå ´åˆã€åŠåˆ†Kãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã®ãƒœãƒ¼ãƒŠã‚¹
- **ãƒšãƒŠãƒ«ãƒ†ã‚£å…é™¤**: å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ•—åŒ—ã—ã¦ã‚‚ãƒšãƒŠãƒ«ãƒ†ã‚£ãªã—
- **æœ€ä½ä¿è¨¼**: ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¯1100ä»¥ä¸‹ã«ã¯ãªã‚‰ãªã„

### 4. `update_season_points_after_battle()`

#### ç›®çš„
ãƒãƒˆãƒ«çµæœã«åŸºã¥ã„ãŸã‚·ãƒ¼ã‚ºãƒ³ãƒã‚¤ãƒ³ãƒˆã®æ›´æ–°

#### å‡¦ç†ãƒ­ã‚¸ãƒƒã‚¯
- **ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°è¨ˆç®—ã¨å®Œå…¨åŒä¸€**: Eloã‚·ã‚¹ãƒ†ãƒ ã€Kãƒ•ã‚¡ã‚¯ã‚¿ãƒ¼ã€å‰Šé™¤ãƒ¦ãƒ¼ã‚¶ãƒ¼å‡¦ç†ã™ã¹ã¦åŒã˜
- **ç‹¬ç«‹ç®¡ç†**: ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ã¯åˆ¥ã§ç®¡ç†
- **ã‚·ãƒ¼ã‚ºãƒ³é™å®š**: ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚·ãƒ¼ã‚ºãƒ³ãŒã‚ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ

---

## ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ»ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

### ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
```sql
-- å„é–¢æ•°ã¯ç‹¬ç«‹ã—ãŸãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ
-- ã‚¨ãƒ©ãƒ¼æ™‚ã¯è‡ªå‹•ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
EXCEPTION WHEN OTHERS THEN
  RETURN json_build_object(
    'success', false,
    'error', 'Transaction failed',
    'error_details', SQLERRM
  );
```

### ä¸¦è¡Œå‡¦ç†åˆ¶å¾¡
```sql
-- ãƒãƒˆãƒ«å‡¦ç†ä¸­ã®æ’ä»–åˆ¶å¾¡
UPDATE public.active_battles
SET status = 'PROCESSING_RESULTS', updated_at = now()
WHERE id = rec.id;
```

### ãƒ‡ãƒ¼ã‚¿ä¿å…¨
- **å‹•ç”»URLæ°¸ç¶šä¿å­˜**: archived_battlesãƒ†ãƒ¼ãƒ–ãƒ«ã«å‹•ç”»URLã‚’æ°¸ç¶šä¿å­˜
- **æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ä¿å…¨**: archived_battle_votesã«å…¨æŠ•ç¥¨ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œ
- **ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´**: archived_battlesã«ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•å±¥æ­´ã‚’ä¿å­˜

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£
```sql
SECURITY DEFINER  -- å®šç¾©è€…æ¨©é™ã§å®Ÿè¡Œ
-- èªè¨¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ãªé–¢æ•°ã¯é©åˆ‡ãªæ¨©é™åˆ¶å¾¡
```

---

## ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
```sql
-- ãƒãƒˆãƒ«çµ‚äº†å‡¦ç†ç”¨
CREATE INDEX idx_active_battles_end_voting 
ON public.active_battles (end_voting_at, status)
WHERE status = 'ACTIVE';

-- ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æ¤œç´¢ç”¨
CREATE INDEX idx_archived_battles_user_created 
ON public.archived_battles (player1_user_id, player2_user_id, created_at);
```

### ãƒãƒƒãƒå‡¦ç†åŠ¹ç‡åŒ–
- **ä¸€æ‹¬å‡¦ç†**: process_expired_battles()ã§è¤‡æ•°ãƒãƒˆãƒ«ã‚’åŒæ™‚å‡¦ç†
- **ã‚¨ãƒ©ãƒ¼éš”é›¢**: 1ã¤ã®ãƒãƒˆãƒ«å‡¦ç†å¤±æ•—ãŒä»–ã«å½±éŸ¿ã—ãªã„è¨­è¨ˆ
- **çµ±è¨ˆæƒ…å ±**: å‡¦ç†çµæœã®è©³ç´°çµ±è¨ˆã‚’JSONå½¢å¼ã§æä¾›

---

## ä»Šå¾Œã®æ”¹å–„äºˆå®š

### æ©Ÿèƒ½æ‹¡å¼µ
1. **ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å±¥æ­´**: è©³ç´°ãªãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å¤‰å‹•å±¥æ­´ã®å¯è¦–åŒ–
2. **çµ±è¨ˆãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰**: ãƒãƒˆãƒ«çµæœãƒ»ãƒ¬ãƒ¼ãƒ†ã‚£ãƒ³ã‚°åˆ†å¸ƒã®åˆ†ææ©Ÿèƒ½
3. **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹åˆ†æ**: å€‹äººãƒ»å…¨ä½“ã®æˆç¸¾åˆ†ææ©Ÿèƒ½
4. **ã‚·ãƒ¼ã‚ºãƒ³å ±é…¬**: ã‚·ãƒ¼ã‚ºãƒ³çµ‚äº†æ™‚ã®è‡ªå‹•å ±é…¬é…å¸ƒ

### æœ€é©åŒ–
1. **ä¸¦åˆ—å‡¦ç†**: å¤§é‡ãƒãƒˆãƒ«å‡¦ç†æ™‚ã®ä¸¦åˆ—åŒ–
2. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½**: é »ç¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã‚Œã‚‹çµ±è¨ˆæƒ…å ±ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥
3. **ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–æœ€é©åŒ–**: å¤ã„ãƒ‡ãƒ¼ã‚¿ã®åˆ¥ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®ç§»è¡Œ

---

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- [ãƒãƒƒãƒãƒ³ã‚°ãƒ»æŠ•ç¨¿æ©Ÿèƒ½ä»•æ§˜æ›¸](./ãƒãƒƒãƒãƒ³ã‚°ãƒ»æŠ•ç¨¿æ©Ÿèƒ½ä»•æ§˜æ›¸.md)
- [æŠ•ç¥¨æ©Ÿèƒ½ä»•æ§˜æ›¸](./æŠ•ç¥¨æ©Ÿèƒ½ä»•æ§˜æ›¸.md)
- [ã‚·ãƒ¼ã‚ºãƒ³ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸](./ã‚·ãƒ¼ã‚ºãƒ³ã‚·ã‚¹ãƒ†ãƒ ä»•æ§˜æ›¸.md)
- [BeatNexus.mdc](./BeatNexus.mdc) - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ä»•æ§˜

---

**æ³¨æ„**: ã“ã®ä»•æ§˜æ›¸ã¯ç¾åœ¨å®Ÿè£…æ¸ˆã¿ã®æ©Ÿèƒ½ã‚’è©³ç´°ã«è§£èª¬ã—ãŸã‚‚ã®ã§ã™ã€‚ä¸¡ç’°å¢ƒã®æ•´åˆæ€§ã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ç¢ºèªã•ã‚Œã¾ã™ã€‚
